var e=Object.defineProperty,t=(e,t)=>()=>(e&&(t=e(e=0)),t),n=t=>{let n={};for(var r in t)e(n,r,{get:t[r],enumerable:!0});return n};const r=5e3;var i={debug:0,info:1,warn:2,error:3,none:4},a=`warn`;function o(){let e=self;return e.SW_LOG_LEVEL&&e.SW_LOG_LEVEL in i?e.SW_LOG_LEVEL:a}function s(e){let t=o();return i[e]>=i[t]}function c(e){return`[SW ${new Date().toISOString()}] ${e.toUpperCase()}:`}function l(e,t,n){if(!s(e))return;let r=c(e),i=e===`debug`?`log`:e;n===void 0?console[i](r,t):console[i](r,t,n)}const u={debug:(e,t)=>l(`debug`,e,t),info:(e,t)=>l(`info`,e,t),warn:(e,t)=>l(`warn`,e,t),error:(e,t)=>l(`error`,e,t),setLevel:e=>{let t=self;t.SW_LOG_LEVEL=e,console.log(`[SW] Log level set to: ${e}`)},getLevel:()=>o()};var d={status:`idle`},ee=null;function f(){return d}function te(){return ee}function ne(e){ee=e}function p(){return d.status===`active`?d:null}function m(){return d.status===`active`?{tonk:d.tonk,manifest:d.manifest}:null}function re(e){u.debug(`Cleaning up active bundle state`,{bundleId:e.bundleId,watcherCount:e.watchers.size,hasHealthCheck:!!e.healthCheckInterval}),e.healthCheckInterval&&clearInterval(e.healthCheckInterval),e.watchers.forEach((e,t)=>{try{e.stop(),u.debug(`Stopped watcher`,{id:t})}catch(e){u.warn(`Error stopping watcher`,{id:t,error:e instanceof Error?e.message:String(e)})}});try{typeof e.tonk.disconnectWebsocket==`function`&&(e.tonk.disconnectWebsocket(),u.debug(`Disconnected WebSocket`))}catch(e){u.warn(`Error disconnecting WebSocket`,{error:e instanceof Error?e.message:String(e)})}}function h(e){let t=d;u.debug(`State transition`,{from:t.status,to:e.status,bundleId:`bundleId`in e?e.bundleId:void 0}),t.status===`active`&&re(t),d=e}function ie(e){return d.status===`active`?(d={...d,appSlug:e},!0):!1}function ae(e){d.status===`active`&&(d={...d,connectionHealthy:e})}function oe(){return d.status===`active`?(d={...d,reconnectAttempts:d.reconnectAttempts+1},d.reconnectAttempts):0}function se(){d.status===`active`&&(d={...d,reconnectAttempts:0})}function ce(e){d.status===`active`&&(d={...d,healthCheckInterval:e})}function le(e,t){d.status===`active`&&d.watchers.set(e,t)}function ue(e){if(d.status===`active`){let t=d.watchers.get(e);if(t){try{t.stop()}catch(t){u.warn(`Error stopping watcher on remove`,{id:e,error:t instanceof Error?t.message:String(t)})}return d.watchers.delete(e),!0}}return!1}function de(e){if(d.status===`active`)return d.watchers.get(e)}function fe(){return d.status===`active`?Array.from(d.watchers.entries()):[]}var pe=`modulepreload`,me=function(e){return`/`+e},he={};const g=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let e=document.getElementsByTagName(`link`),i=document.querySelector(`meta[property=csp-nonce]`),a=i?.nonce||i?.getAttribute(`nonce`);function o(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:`fulfilled`,value:e}),e=>({status:`rejected`,reason:e}))))}r=o(t.map(t=>{if(t=me(t,n),t in he)return;he[t]=!0;let r=t.endsWith(`.css`),i=r?`[rel="stylesheet"]`:``;if(n)for(let n=e.length-1;n>=0;n--){let i=e[n];if(i.href===t&&(!r||i.rel===`stylesheet`))return}else if(document.querySelector(`link[href="${t}"]${i}`))return;let o=document.createElement(`link`);if(o.rel=r?`stylesheet`:pe,r||(o.as=`script`),o.crossOrigin=``,o.href=t,a&&o.setAttribute(`nonce`,a),document.head.appendChild(o),r)return new Promise((e,n)=>{o.addEventListener(`load`,e),o.addEventListener(`error`,()=>n(Error(`Unable to preload CSS for ${t}`)))})}))}function i(e){let t=new Event(`vite:preloadError`,{cancelable:!0});if(t.payload=e,self.dispatchEvent(t),!t.defaultPrevented)throw e}return r.then(t=>{for(let e of t||[])e.status===`rejected`&&i(e.reason);return e().catch(i)})};var _=n({WasmBundle:()=>P,WasmDocHandle:()=>Ze,WasmDocumentWatcher:()=>$e,WasmError:()=>tt,WasmRepo:()=>rt,WasmTonkCore:()=>at,WasmWebSocketHandle:()=>st,create_bundle_from_bytes:()=>ke,create_tonk:()=>Se,create_tonk_from_bundle:()=>Oe,create_tonk_from_bundle_with_storage:()=>Ae,create_tonk_from_bytes:()=>we,create_tonk_from_bytes_with_storage:()=>Te,create_tonk_with_config:()=>Ce,create_tonk_with_peer_id:()=>Ee,create_tonk_with_storage:()=>xe,default:()=>F,init:()=>De,initSync:()=>Ve,set_time_provider:()=>je});function v(){return(O===null||O.byteLength===0)&&(O=new Uint8Array(D.memory.buffer)),O}function ge(e,t){return A+=t,A>=Ue&&(k=typeof TextDecoder<`u`?new TextDecoder(`utf-8`,{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error(`TextDecoder not available`)}},k.decode(),A=t),k.decode(v().subarray(e,e+t))}function y(e,t){return e>>>=0,ge(e,t)}function b(e,t,n){if(n===void 0){let n=M.encode(e),r=t(n.length,1)>>>0;return v().subarray(r,r+n.length).set(n),j=n.length,r}let r=e.length,i=t(r,1)>>>0,a=v(),o=0;for(;o<r;o++){let t=e.charCodeAt(o);if(t>127)break;a[i+o]=t}if(o!==r){o!==0&&(e=e.slice(o)),i=n(i,r,r=o+e.length*3,1)>>>0;let t=v().subarray(i+o,i+r),a=We(e,t);o+=a.written,i=n(i,r,o,1)>>>0}return j=o,i}function x(){return(N===null||N.buffer.detached===!0||N.buffer.detached===void 0&&N.buffer!==D.memory.buffer)&&(N=new DataView(D.memory.buffer)),N}function S(e){let t=D.__externref_table_alloc();return D.__wbindgen_export_4.set(t,e),t}function C(e,t){try{return e.apply(this,t)}catch(e){let t=S(e);D.__wbindgen_exn_store(t)}}function w(e){return e==null}function _e(e,t){return e>>>=0,v().subarray(e/1,e/1+t)}function T(e,t,n,r){let i={a:e,b:t,cnt:1,dtor:n},a=(...e)=>{i.cnt++;let t=i.a;i.a=0;try{return r(t,i.b,...e)}finally{--i.cnt===0?(D.__wbindgen_export_6.get(i.dtor)(t,i.b),Ge.unregister(i)):i.a=t}};return a.original=i,Ge.register(a,i,i),a}function ve(e){let t=typeof e;if(t==`number`||t==`boolean`||e==null)return`${e}`;if(t==`string`)return`"${e}"`;if(t==`symbol`){let t=e.description;return t==null?`Symbol`:`Symbol(${t})`}if(t==`function`){let t=e.name;return typeof t==`string`&&t.length>0?`Function(${t})`:`Function`}if(Array.isArray(e)){let t=e.length,n=`[`;t>0&&(n+=ve(e[0]));for(let r=1;r<t;r++)n+=`, `+ve(e[r]);return n+=`]`,n}let n=/\[object ([^\]]+)\]/.exec(toString.call(e)),r;if(n&&n.length>1)r=n[1];else return toString.call(e);if(r==`Object`)try{return`Object(`+JSON.stringify(e)+`)`}catch{return`Object`}return e instanceof Error?`${e.name}: ${e.message}\n${e.stack}`:r}function E(e){let t=D.__wbindgen_export_4.get(e);return D.__externref_table_dealloc(e),t}function ye(e,t){if(!(e instanceof t))throw Error(`expected instance of ${t.name}`)}function be(e,t){let n=t(e.length*1,1)>>>0;return v().set(e,n/1),j=e.length,n}function xe(e){return D.create_tonk_with_storage(e)}function Se(){return D.create_tonk()}function Ce(e,t){let n=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),r=j;return D.create_tonk_with_config(n,r,t)}function we(e){return D.create_tonk_from_bytes(e)}function Te(e,t){return D.create_tonk_from_bytes_with_storage(e,t)}function Ee(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.create_tonk_with_peer_id(t,n)}function De(){D.init()}function Oe(e){return ye(e,P),D.create_tonk_from_bundle(e.__wbg_ptr)}function ke(e){let t=D.create_bundle_from_bytes(e);if(t[2])throw E(t[1]);return P.__wrap(t[0])}function Ae(e,t){return ye(e,P),D.create_tonk_from_bundle_with_storage(e.__wbg_ptr,t)}function je(e){D.set_time_provider(e)}function Me(e,t,n){D.closure713_externref_shim(e,t,n)}function Ne(e,t,n){let r=D.closure716_externref_shim_multivalue_shim(e,t,n);if(r[1])throw E(r[0])}function Pe(e,t,n){D.closure992_externref_shim(e,t,n)}function Fe(e,t){D.wasm_bindgen__convert__closures_____invoke__hfd3cca906b115850(e,t)}function Ie(e,t,n){D.closure1010_externref_shim(e,t,n)}function Le(e,t,n,r){D.closure1273_externref_shim(e,t,n,r)}async function Re(e,t){if(typeof Response==`function`&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming==`function`)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if(e.ok&&ct.has(e.type)&&e.headers.get(`Content-Type`)!==`application/wasm`)console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t);else throw t}let n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{let n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function ze(){let e={};return e.wbg={},e.wbg.__wbg_Error_0497d5bdba9362e5=function(e,t){return Error(y(e,t))},e.wbg.__wbg_String_8f0eb39a4a4c2f66=function(e,t){let n=b(String(t),D.__wbindgen_malloc,D.__wbindgen_realloc),r=j;x().setInt32(e+4,r,!0),x().setInt32(e+0,n,!0)},e.wbg.__wbg_Window_41559019033ede94=function(e){return e.Window},e.wbg.__wbg_WorkerGlobalScope_d324bffbeaef9f3a=function(e){return e.WorkerGlobalScope},e.wbg.__wbg_abort_601b12a63a2f3a3a=function(){return C(function(e){e.abort()},arguments)},e.wbg.__wbg_bound_eb572b424befade3=function(){return C(function(e,t,n,r){return IDBKeyRange.bound(e,t,n!==0,r!==0)},arguments)},e.wbg.__wbg_buffer_a1a27a0dfa70165d=function(e){return e.buffer},e.wbg.__wbg_buffer_e495ba54cee589cc=function(e){return e.buffer},e.wbg.__wbg_call_f2db6205e5c51dc8=function(){return C(function(e,t,n){return e.call(t,n)},arguments)},e.wbg.__wbg_call_fbe8be8bf6436ce5=function(){return C(function(e,t){return e.call(t)},arguments)},e.wbg.__wbg_close_b08c03c920ee0bba=function(){return C(function(e){e.close()},arguments)},e.wbg.__wbg_commit_a54edce65f3858f2=function(){return C(function(e){e.commit()},arguments)},e.wbg.__wbg_continue_7d9cdafc888cb902=function(){return C(function(e){e.continue()},arguments)},e.wbg.__wbg_createObjectStore_b1f08961900155dd=function(){return C(function(e,t,n){return e.createObjectStore(y(t,n))},arguments)},e.wbg.__wbg_data_fffd43bf0ca75fff=function(e){return e.data},e.wbg.__wbg_delete_71b7921c73aa9378=function(){return C(function(e,t){return e.delete(t)},arguments)},e.wbg.__wbg_done_4d01f352bade43b7=function(e){return e.done},e.wbg.__wbg_entries_41651c850143b957=function(e){return Object.entries(e)},e.wbg.__wbg_error_31d7961b8e0d3f6c=function(e,t){console.error(y(e,t))},e.wbg.__wbg_error_4e978abc9692c0c5=function(){return C(function(e){let t=e.error;return w(t)?0:S(t)},arguments)},e.wbg.__wbg_error_51ecdd39ec054205=function(e){console.error(e)},e.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let n,r;try{n=e,r=t,console.error(y(e,t))}finally{D.__wbindgen_free(n,r,1)}},e.wbg.__wbg_from_12ff8e47307bd4c7=function(e){return Array.from(e)},e.wbg.__wbg_getRandomValues_1c61fac11405ffdc=function(){return C(function(e,t){globalThis.crypto.getRandomValues(_e(e,t))},arguments)},e.wbg.__wbg_getTime_2afe67905d873e92=function(e){return e.getTime()},e.wbg.__wbg_get_92470be87867c2e5=function(){return C(function(e,t){return Reflect.get(e,t)},arguments)},e.wbg.__wbg_get_a131a44bd1eb6979=function(e,t){return e[t>>>0]},e.wbg.__wbg_get_d37904b955701f99=function(){return C(function(e,t){return e.get(t)},arguments)},e.wbg.__wbg_getwithrefkey_1dc361bd10053bfe=function(e,t){return e[t]},e.wbg.__wbg_global_f5c2926e57ba457f=function(e){return e.global},e.wbg.__wbg_indexedDB_317016dcb8a872d6=function(){return C(function(e){let t=e.indexedDB;return w(t)?0:S(t)},arguments)},e.wbg.__wbg_indexedDB_54f01430b1e194e8=function(){return C(function(e){let t=e.indexedDB;return w(t)?0:S(t)},arguments)},e.wbg.__wbg_indexedDB_63b82e158eb67cbd=function(){return C(function(e){let t=e.indexedDB;return w(t)?0:S(t)},arguments)},e.wbg.__wbg_instanceof_ArrayBuffer_a8b6f580b363f2bc=function(e){let t;try{t=e instanceof ArrayBuffer}catch{t=!1}return t},e.wbg.__wbg_instanceof_CursorSys_4b6a8aba0e823e75=function(e){let t;try{t=e instanceof IDBCursorWithValue}catch{t=!1}return t},e.wbg.__wbg_instanceof_DomException_77720ed8752d7409=function(e){let t;try{t=e instanceof DOMException}catch{t=!1}return t},e.wbg.__wbg_instanceof_Error_58a92d81483a4b16=function(e){let t;try{t=e instanceof Error}catch{t=!1}return t},e.wbg.__wbg_instanceof_IdbCursor_07be219dc9364535=function(e){let t;try{t=e instanceof IDBCursor}catch{t=!1}return t},e.wbg.__wbg_instanceof_IdbDatabase_0ed56ed115d533bc=function(e){let t;try{t=e instanceof IDBDatabase}catch{t=!1}return t},e.wbg.__wbg_instanceof_IdbRequest_c4498c7b5a3a0fa3=function(e){let t;try{t=e instanceof IDBRequest}catch{t=!1}return t},e.wbg.__wbg_instanceof_Map_80cc65041c96417a=function(e){let t;try{t=e instanceof Map}catch{t=!1}return t},e.wbg.__wbg_instanceof_Uint8Array_ca460677bc155827=function(e){let t;try{t=e instanceof Uint8Array}catch{t=!1}return t},e.wbg.__wbg_isArray_5f090bed72bd4f89=function(e){return Array.isArray(e)},e.wbg.__wbg_isSafeInteger_90d7c4674047d684=function(e){return Number.isSafeInteger(e)},e.wbg.__wbg_item_15285ca2d766f142=function(e,t,n){let r=t.item(n>>>0);var i=w(r)?0:b(r,D.__wbindgen_malloc,D.__wbindgen_realloc),a=j;x().setInt32(e+4,a,!0),x().setInt32(e+0,i,!0)},e.wbg.__wbg_iterator_4068add5b2aef7a6=function(){return Symbol.iterator},e.wbg.__wbg_key_a17a68df9ec1b180=function(){return C(function(e){return e.key},arguments)},e.wbg.__wbg_keys_42062809bf87339e=function(e){return Object.keys(e)},e.wbg.__wbg_length_ab6d22b5ead75c72=function(e){return e.length},e.wbg.__wbg_length_f00ec12454a5d9fd=function(e){return e.length},e.wbg.__wbg_log_0cc1b7768397bcfe=function(e,t,n,r,i,a,o,s){let c,l;try{c=e,l=t,console.log(y(e,t),y(n,r),y(i,a),y(o,s))}finally{D.__wbindgen_free(c,l,1)}},e.wbg.__wbg_log_cb9e190acc5753fb=function(e,t){let n,r;try{n=e,r=t,console.log(y(e,t))}finally{D.__wbindgen_free(n,r,1)}},e.wbg.__wbg_log_ea240990d83e374e=function(e){console.log(e)},e.wbg.__wbg_lowerBound_13c8e875a3fb9f7d=function(){return C(function(e,t){return IDBKeyRange.lowerBound(e,t!==0)},arguments)},e.wbg.__wbg_mark_7438147ce31e9d4b=function(e,t){performance.mark(y(e,t))},e.wbg.__wbg_measure_fb7825c11612c823=function(){return C(function(e,t,n,r){let i,a,o,s;try{i=e,a=t,o=n,s=r,performance.measure(y(e,t),y(n,r))}finally{D.__wbindgen_free(i,a,1),D.__wbindgen_free(o,s,1)}},arguments)},e.wbg.__wbg_message_2d95ea5aff0d63b9=function(e,t){let n=t.message,r=b(n,D.__wbindgen_malloc,D.__wbindgen_realloc),i=j;x().setInt32(e+4,i,!0),x().setInt32(e+0,r,!0)},e.wbg.__wbg_message_4159c15dac08c5e9=function(e){return e.message},e.wbg.__wbg_message_44ef9b801b7d8bc3=function(e,t){let n=t.message,r=b(n,D.__wbindgen_malloc,D.__wbindgen_realloc),i=j;x().setInt32(e+4,i,!0),x().setInt32(e+0,r,!0)},e.wbg.__wbg_name_2acff1e83d9735f9=function(e,t){let n=t.name,r=b(n,D.__wbindgen_malloc,D.__wbindgen_realloc),i=j;x().setInt32(e+4,i,!0),x().setInt32(e+0,r,!0)},e.wbg.__wbg_new0_97314565408dea38=function(){return new Date},e.wbg.__wbg_new_07b483f72211fd66=function(){return{}},e.wbg.__wbg_new_476169e6d59f23ae=function(e,t){return Error(y(e,t))},e.wbg.__wbg_new_58353953ad2097cc=function(){return[]},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return Error()},e.wbg.__wbg_new_a979b4b45bd55c7f=function(){return new Map},e.wbg.__wbg_new_e30c39c06edaabf2=function(e,t){try{var n={a:e,b:t};return new Promise((e,t)=>{let r=n.a;n.a=0;try{return Le(r,n.b,e,t)}finally{n.a=r}})}finally{n.a=n.b=0}},e.wbg.__wbg_new_e52b3efaaa774f96=function(e){return new Uint8Array(e)},e.wbg.__wbg_new_f42a001532528172=function(){return C(function(e,t){return new WebSocket(y(e,t))},arguments)},e.wbg.__wbg_newfromslice_7c05ab1297cb2d88=function(e,t){return new Uint8Array(_e(e,t))},e.wbg.__wbg_newnoargs_ff528e72d35de39a=function(e,t){return Function(y(e,t))},e.wbg.__wbg_newwithbyteoffsetandlength_3b01ecda099177e8=function(e,t,n){return new Uint8Array(e,t>>>0,n>>>0)},e.wbg.__wbg_newwithlength_08f872dc1e3ada2e=function(e){return new Uint8Array(e>>>0)},e.wbg.__wbg_next_8bb824d217961b5d=function(e){return e.next},e.wbg.__wbg_next_e2da48d8fff7439a=function(){return C(function(e){return e.next()},arguments)},e.wbg.__wbg_now_eb0821f3bd9f6529=function(){return Date.now()},e.wbg.__wbg_objectStoreNames_e82275eb2d403a92=function(e){return e.objectStoreNames},e.wbg.__wbg_objectStore_b463d32c86d6b543=function(){return C(function(e,t,n){return e.objectStore(y(t,n))},arguments)},e.wbg.__wbg_openCursor_7c13a2cd32c6258b=function(){return C(function(e){return e.openCursor()},arguments)},e.wbg.__wbg_open_0f04f50fa4d98f67=function(){return C(function(e,t,n,r){return e.open(y(t,n),r>>>0)},arguments)},e.wbg.__wbg_push_73fd7b5550ebf707=function(e,t){return e.push(t)},e.wbg.__wbg_put_7f0b4dcc666f09e3=function(){return C(function(e,t,n){return e.put(t,n)},arguments)},e.wbg.__wbg_queueMicrotask_46c1df247678729f=function(e){queueMicrotask(e)},e.wbg.__wbg_queueMicrotask_8acf3ccb75ed8d11=function(e){return e.queueMicrotask},e.wbg.__wbg_readyState_249e5707a38b7a7a=function(e){let t=e.readyState;return(qe.indexOf(t)+1||3)-1},e.wbg.__wbg_request_5079471e06223120=function(e){return e.request},e.wbg.__wbg_request_fada8c23b78b3a02=function(e){return e.request},e.wbg.__wbg_resolve_0dac8c580ffd4678=function(e){return Promise.resolve(e)},e.wbg.__wbg_result_a0f1bf2fe64a516c=function(){return C(function(e){return e.result},arguments)},e.wbg.__wbg_send_05456d2bf190b017=function(){return C(function(e,t){e.send(t)},arguments)},e.wbg.__wbg_set_3f1d0b984ed272ed=function(e,t,n){e[t]=n},e.wbg.__wbg_set_7422acbe992d64ab=function(e,t,n){e[t>>>0]=n},e.wbg.__wbg_set_c43293f93a35998a=function(){return C(function(e,t,n){return Reflect.set(e,t,n)},arguments)},e.wbg.__wbg_set_d6bdfd275fb8a4ce=function(e,t,n){return e.set(t,n)},e.wbg.__wbg_set_fe4e79d1ed3b0e9b=function(e,t,n){e.set(t,n>>>0)},e.wbg.__wbg_setbinaryType_52787d6025601cc5=function(e,t){e.binaryType=Ke[t]},e.wbg.__wbg_setonabort_479ebb5884fcb171=function(e,t){e.onabort=t},e.wbg.__wbg_setonclose_c6db38f935250174=function(e,t){e.onclose=t},e.wbg.__wbg_setoncomplete_27bdbca012e45c05=function(e,t){e.oncomplete=t},e.wbg.__wbg_setonerror_537b68f474e27d4e=function(e,t){e.onerror=t},e.wbg.__wbg_setonerror_ab02451cd01cb480=function(e,t){e.onerror=t},e.wbg.__wbg_setonerror_ce5c4d34aed931bb=function(e,t){e.onerror=t},e.wbg.__wbg_setonmessage_49ca623a77cfb3e6=function(e,t){e.onmessage=t},e.wbg.__wbg_setonopen_1475cbeb761c101f=function(e,t){e.onopen=t},e.wbg.__wbg_setonsuccess_0b2b45bd8cc13b95=function(e,t){e.onsuccess=t},e.wbg.__wbg_setonupgradeneeded_be2e0ae927917f82=function(e,t){e.onupgradeneeded=t},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){let n=t.stack,r=b(n,D.__wbindgen_malloc,D.__wbindgen_realloc),i=j;x().setInt32(e+4,i,!0),x().setInt32(e+0,r,!0)},e.wbg.__wbg_static_accessor_GLOBAL_487c52c58d65314d=function(){let e=typeof globalThis>`u`?null:globalThis;return w(e)?0:S(e)},e.wbg.__wbg_static_accessor_GLOBAL_THIS_ee9704f328b6b291=function(){let e=typeof globalThis>`u`?null:globalThis;return w(e)?0:S(e)},e.wbg.__wbg_static_accessor_SELF_78c9e3071b912620=function(){let e=typeof self>`u`?null:self;return w(e)?0:S(e)},e.wbg.__wbg_static_accessor_WINDOW_a093d21393777366=function(){let e=typeof self>`u`?null:self;return w(e)?0:S(e)},e.wbg.__wbg_target_15f1da583855ac4e=function(e){let t=e.target;return w(t)?0:S(t)},e.wbg.__wbg_then_82ab9fb4080f1707=function(e,t,n){return e.then(t,n)},e.wbg.__wbg_then_db882932c0c714c6=function(e,t){return e.then(t)},e.wbg.__wbg_toString_bc7a05a172b5cf14=function(e){return e.toString()},e.wbg.__wbg_transaction_36c8b28ed4349a9a=function(){return C(function(e,t,n,r){return e.transaction(y(t,n),Je[r])},arguments)},e.wbg.__wbg_transaction_d1f21f4378880521=function(e){return e.transaction},e.wbg.__wbg_upperBound_a0bd8ece19d98580=function(){return C(function(e,t){return IDBKeyRange.upperBound(e,t!==0)},arguments)},e.wbg.__wbg_value_17b896954e14f896=function(e){return e.value},e.wbg.__wbg_value_648dc44894c8dc95=function(){return C(function(e){return e.value},arguments)},e.wbg.__wbg_wasmdochandle_new=function(e){return Ze.__wrap(e)},e.wbg.__wbg_wasmdocumentwatcher_new=function(e){return $e.__wrap(e)},e.wbg.__wbg_wasmerror_new=function(e){return tt.__wrap(e)},e.wbg.__wbg_wasmrepo_new=function(e){return rt.__wrap(e)},e.wbg.__wbg_wasmtonkcore_new=function(e){return at.__wrap(e)},e.wbg.__wbindgen_bigint_from_i64=function(e){return e},e.wbg.__wbindgen_bigint_from_u64=function(e){return BigInt.asUintN(64,e)},e.wbg.__wbindgen_bigint_get_as_i64=function(e,t){let n=t,r=typeof n==`bigint`?n:void 0;x().setBigInt64(e+8,w(r)?BigInt(0):r,!0),x().setInt32(e+0,!w(r),!0)},e.wbg.__wbindgen_boolean_get=function(e){let t=e;return typeof t==`boolean`?t?1:0:2},e.wbg.__wbindgen_cb_drop=function(e){let t=e.original;return t.cnt--==1?(t.a=0,!0):!1},e.wbg.__wbindgen_closure_wrapper1832=function(e,t,n){return T(e,t,712,Me)},e.wbg.__wbindgen_closure_wrapper1834=function(e,t,n){return T(e,t,712,Me)},e.wbg.__wbindgen_closure_wrapper1836=function(e,t,n){return T(e,t,712,Ne)},e.wbg.__wbindgen_closure_wrapper1838=function(e,t,n){return T(e,t,712,Me)},e.wbg.__wbindgen_closure_wrapper2532=function(e,t,n){return T(e,t,991,Pe)},e.wbg.__wbindgen_closure_wrapper2534=function(e,t,n){return T(e,t,991,Fe)},e.wbg.__wbindgen_closure_wrapper2562=function(e,t,n){return T(e,t,1009,Ie)},e.wbg.__wbindgen_debug_string=function(e,t){let n=ve(t),r=b(n,D.__wbindgen_malloc,D.__wbindgen_realloc),i=j;x().setInt32(e+4,i,!0),x().setInt32(e+0,r,!0)},e.wbg.__wbindgen_in=function(e,t){return e in t},e.wbg.__wbindgen_init_externref_table=function(){let e=D.__wbindgen_export_4,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},e.wbg.__wbindgen_is_bigint=function(e){return typeof e==`bigint`},e.wbg.__wbindgen_is_function=function(e){return typeof e==`function`},e.wbg.__wbindgen_is_null=function(e){return e===null},e.wbg.__wbindgen_is_object=function(e){let t=e;return typeof t==`object`&&!!t},e.wbg.__wbindgen_is_string=function(e){return typeof e==`string`},e.wbg.__wbindgen_is_undefined=function(e){return e===void 0},e.wbg.__wbindgen_jsval_eq=function(e,t){return e===t},e.wbg.__wbindgen_jsval_loose_eq=function(e,t){return e==t},e.wbg.__wbindgen_memory=function(){return D.memory},e.wbg.__wbindgen_number_get=function(e,t){let n=t,r=typeof n==`number`?n:void 0;x().setFloat64(e+8,w(r)?0:r,!0),x().setInt32(e+0,!w(r),!0)},e.wbg.__wbindgen_number_new=function(e){return e},e.wbg.__wbindgen_string_get=function(e,t){let n=t,r=typeof n==`string`?n:void 0;var i=w(r)?0:b(r,D.__wbindgen_malloc,D.__wbindgen_realloc),a=j;x().setInt32(e+4,a,!0),x().setInt32(e+0,i,!0)},e.wbg.__wbindgen_string_new=function(e,t){return y(e,t)},e.wbg.__wbindgen_throw=function(e,t){throw Error(y(e,t))},e}function Be(e,t){return D=e.exports,He.__wbindgen_wasm_module=t,N=null,O=null,D.__wbindgen_start(),D}function Ve(e){if(D!==void 0)return D;e!==void 0&&(Object.getPrototypeOf(e)===Object.prototype?{module:e}=e:console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));let t=ze();e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e));let n=new WebAssembly.Instance(e,t);return Be(n,e)}async function He(e){if(D!==void 0)return D;e!==void 0&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn(`using deprecated parameters for the initialization function; pass a single object instead`)),e===void 0&&(e=new URL(`/tonk_core_bg.wasm`,``+import.meta.url));let t=ze();(typeof e==`string`||typeof Request==`function`&&e instanceof Request||typeof URL==`function`&&e instanceof URL)&&(e=fetch(e));let{instance:n,module:r}=await Re(await e,t);return Be(n,r)}var D,O,k,Ue,A,j,M,We,N,Ge,Ke,qe,Je,Ye,P,Xe,Ze,Qe,$e,et,tt,nt,rt,it,at,ot,st,ct,F,I=t((()=>{O=null,k=typeof TextDecoder<`u`?new TextDecoder(`utf-8`,{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error(`TextDecoder not available`)}},typeof TextDecoder<`u`&&k.decode(),Ue=2146435072,A=0,j=0,M=typeof TextEncoder<`u`?new TextEncoder(`utf-8`):{encode:()=>{throw Error(`TextEncoder not available`)}},We=typeof M.encodeInto==`function`?function(e,t){return M.encodeInto(e,t)}:function(e,t){let n=M.encode(e);return t.set(n),{read:e.length,written:n.length}},N=null,Ge=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>{D.__wbindgen_export_6.get(e.dtor)(e.a,e.b)}),Ke=[`blob`,`arraybuffer`],qe=[`pending`,`done`],Je=[`readonly`,`readwrite`,`versionchange`,`readwriteflush`,`cleanup`],Ye=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>D.__wbg_wasmbundle_free(e>>>0,1)),P=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,Ye.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,Ye.unregister(this),e}free(){let e=this.__destroy_into_raw();D.__wbg_wasmbundle_free(e,0)}static fromBytes(t){let n=D.wasmbundle_fromBytes(t);if(n[2])throw E(n[1]);return e.__wrap(n[0])}getPrefix(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmbundle_getPrefix(this.__wbg_ptr,t,n)}getRootId(){return D.wasmbundle_getRootId(this.__wbg_ptr)}getManifest(){return D.wasmbundle_getManifest(this.__wbg_ptr)}setManifest(e){return D.wasmbundle_setManifest(this.__wbg_ptr,e)}get(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmbundle_get(this.__wbg_ptr,t,n)}toBytes(){return D.wasmbundle_toBytes(this.__wbg_ptr)}listKeys(){return D.wasmbundle_listKeys(this.__wbg_ptr)}},Xe=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>D.__wbg_wasmdochandle_free(e>>>0,1)),Ze=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,Xe.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,Xe.unregister(this),e}free(){let e=this.__destroy_into_raw();D.__wbg_wasmdochandle_free(e,0)}documentId(){let e,t;try{let n=D.wasmdochandle_documentId(this.__wbg_ptr);return e=n[0],t=n[1],y(n[0],n[1])}finally{D.__wbindgen_free(e,t,1)}}getDocument(){let e=D.wasmdochandle_getDocument(this.__wbg_ptr);if(e[2])throw E(e[1]);return E(e[0])}url(){let e,t;try{let n=D.wasmdochandle_url(this.__wbg_ptr);return e=n[0],t=n[1],y(n[0],n[1])}finally{D.__wbindgen_free(e,t,1)}}},Qe=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>D.__wbg_wasmdocumentwatcher_free(e>>>0,1)),$e=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,Qe.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,Qe.unregister(this),e}free(){let e=this.__destroy_into_raw();D.__wbg_wasmdocumentwatcher_free(e,0)}documentId(){let e,t;try{let n=D.wasmdocumentwatcher_documentId(this.__wbg_ptr);return e=n[0],t=n[1],y(n[0],n[1])}finally{D.__wbindgen_free(e,t,1)}}stop(){return D.wasmdocumentwatcher_stop(this.__wbg_ptr)}},et=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>D.__wbg_wasmerror_free(e>>>0,1)),tt=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,et.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,et.unregister(this),e}free(){let e=this.__destroy_into_raw();D.__wbg_wasmerror_free(e,0)}get message(){let e,t;try{let n=D.wasmerror_message(this.__wbg_ptr);return e=n[0],t=n[1],y(n[0],n[1])}finally{D.__wbindgen_free(e,t,1)}}},nt=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>D.__wbg_wasmrepo_free(e>>>0,1)),rt=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,nt.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,nt.unregister(this),e}free(){let e=this.__destroy_into_raw();D.__wbg_wasmrepo_free(e,0)}findDocument(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmrepo_findDocument(this.__wbg_ptr,t,n)}listDocuments(){let e=D.wasmrepo_listDocuments(this.__wbg_ptr);if(e[2])throw E(e[1]);return E(e[0])}createDocument(e){return D.wasmrepo_createDocument(this.__wbg_ptr,e)}connectWebSocket(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j,r=D.wasmrepo_connectWebSocket(this.__wbg_ptr,t,n);if(r[2])throw E(r[1]);return st.__wrap(r[0])}connectWebSocketAsync(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmrepo_connectWebSocketAsync(this.__wbg_ptr,t,n)}constructor(){return D.wasmrepo_new()}stop(){return D.wasmrepo_stop(this.__wbg_ptr)}peerId(){let e,t;try{let n=D.wasmrepo_peerId(this.__wbg_ptr);return e=n[0],t=n[1],y(n[0],n[1])}finally{D.__wbindgen_free(e,t,1)}}},it=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>D.__wbg_wasmtonkcore_free(e>>>0,1)),at=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,it.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,it.unregister(this),e}free(){let e=this.__destroy_into_raw();D.__wbg_wasmtonkcore_free(e,0)}static fromBytes(e){return D.wasmtonkcore_fromBytes(e)}createFile(e,t){let n=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),r=j;return D.wasmtonkcore_createFile(this.__wbg_ptr,n,r,t)}deleteFile(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmtonkcore_deleteFile(this.__wbg_ptr,t,n)}static fromBundle(e){return ye(e,P),D.wasmtonkcore_fromBundle(e.__wbg_ptr)}getPeerId(){return D.wasmtonkcore_getPeerId(this.__wbg_ptr)}updateFile(e,t){let n=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),r=j;return D.wasmtonkcore_updateFile(this.__wbg_ptr,n,r,t)}getMetadata(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmtonkcore_getMetadata(this.__wbg_ptr,t,n)}isConnected(){return D.wasmtonkcore_isConnected(this.__wbg_ptr)}static withPeerId(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmtonkcore_withPeerId(t,n)}forkToBytes(e){return D.wasmtonkcore_forkToBytes(this.__wbg_ptr,e)}listDirectory(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmtonkcore_listDirectory(this.__wbg_ptr,t,n)}watchDocument(e,t){let n=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),r=j;return D.wasmtonkcore_watchDocument(this.__wbg_ptr,n,r,t)}watchDirectory(e,t){let n=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),r=j;return D.wasmtonkcore_watchDirectory(this.__wbg_ptr,n,r,t)}createDirectory(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmtonkcore_createDirectory(this.__wbg_ptr,t,n)}connectWebsocket(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmtonkcore_connectWebsocket(this.__wbg_ptr,t,n)}getConnectionState(){return D.wasmtonkcore_getConnectionState(this.__wbg_ptr)}createFileWithBytes(e,t,n){let r=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),i=j,a=be(n,D.__wbindgen_malloc),o=j;return D.wasmtonkcore_createFileWithBytes(this.__wbg_ptr,r,i,t,a,o)}updateFileWithBytes(e,t,n){let r=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),i=j,a=be(n,D.__wbindgen_malloc),o=j;return D.wasmtonkcore_updateFileWithBytes(this.__wbg_ptr,r,i,t,a,o)}constructor(){return D.wasmtonkcore_new()}exists(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmtonkcore_exists(this.__wbg_ptr,t,n)}rename(e,t){let n=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),r=j,i=b(t,D.__wbindgen_malloc,D.__wbindgen_realloc),a=j;return D.wasmtonkcore_rename(this.__wbg_ptr,n,r,i,a)}toBytes(e){return D.wasmtonkcore_toBytes(this.__wbg_ptr,e)}readFile(e){let t=b(e,D.__wbindgen_malloc,D.__wbindgen_realloc),n=j;return D.wasmtonkcore_readFile(this.__wbg_ptr,t,n)}},ot=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>D.__wbg_wasmwebsockethandle_free(e>>>0,1)),st=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,ot.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,ot.unregister(this),e}free(){let e=this.__destroy_into_raw();D.__wbg_wasmwebsockethandle_free(e,0)}waitForDisconnect(){return D.wasmwebsockethandle_waitForDisconnect(this.__wbg_ptr)}close(){D.wasmwebsockethandle_close(this.__wbg_ptr)}},ct=new Set([`basic`,`cors`,`default`]),F=He})),lt=function(e,t,n,r,i){if(r===`m`)throw TypeError(`Private method is not writable`);if(r===`a`&&!i)throw TypeError(`Private accessor was defined without a setter`);if(typeof t==`function`?e!==t||!i:!t.has(e))throw TypeError(`Cannot write private member to an object whose class did not declare it`);return r===`a`?i.call(e,n):i?i.value=n:t.set(e,n),n},L=function(e,t,n,r){if(n===`a`&&!r)throw TypeError(`Private accessor was defined without a getter`);if(typeof t==`function`?e!==t||!r:!t.has(e))throw TypeError(`Cannot read private member from an object whose class did not declare it`);return n===`m`?r:n===`a`?r.call(e):r?r.value:t.get(e)},R,z,B=class extends Error{constructor(e,t){super(e),this.code=t,this.name=`TonkError`}},ut=class extends B{constructor(e){super(e,`CONNECTION_ERROR`),this.name=`ConnectionError`}},V=class extends B{constructor(e){super(e,`FILESYSTEM_ERROR`),this.name=`FileSystemError`}},H=class extends B{constructor(e){super(e,`BUNDLE_ERROR`),this.name=`BundleError`}},U=class e{constructor(e){R.set(this,void 0),lt(this,R,e,`f`)}static async fromBytes(t,n){try{let{create_bundle_from_bytes:r}=n||await g(()=>Promise.resolve().then(()=>(I(),_)),void 0);return new e(r(t))}catch(e){throw new H(`Failed to create bundle from bytes: ${e}`)}}async getRootId(){try{return await L(this,R,`f`).getRootId()}catch(e){throw new H(`Failed to get root ID: ${e}`)}}async get(e){try{let t=await L(this,R,`f`).get(e);return t===null?null:t}catch(t){throw new H(`Failed to get key ${e}: ${t}`)}}async getPrefix(e){try{return(await L(this,R,`f`).getPrefix(e)).map(e=>({key:e.key,value:e.value}))}catch(t){throw new H(`Failed to get prefix ${e}: ${t}`)}}async listKeys(){try{return await L(this,R,`f`).listKeys()}catch(e){throw new H(`Failed to list keys: ${e}`)}}async getManifest(){try{return await L(this,R,`f`).getManifest()}catch(e){throw new H(`Failed to retrieve manifest: ${e}`)}}async setManifest(e){try{await L(this,R,`f`).setManifest(e)}catch(e){throw new H(`Failed to set manifest: ${e}`)}}async toBytes(){try{return await L(this,R,`f`).toBytes()}catch(e){throw new H(`Failed to serialize bundle: ${e}`)}}free(){L(this,R,`f`).free()}};R=new WeakMap;var W=class e{constructor(e){z.set(this,void 0),lt(this,z,e,`f`)}static async create(t,n){let r=n||await g(()=>Promise.resolve().then(()=>(I(),_)),void 0);if(t?.peerId&&t?.storage){let{create_tonk_with_config:n}=r,i=await n(t.peerId,t.storage.type===`indexeddb`);return new e(i)}else if(t?.peerId){let{create_tonk_with_peer_id:n}=r,i=await n(t.peerId);return new e(i)}else if(t?.storage){let{create_tonk_with_storage:n}=r,i=await n(t.storage.type===`indexeddb`);return new e(i)}else{let{create_tonk:t}=r,n=await t();return new e(n)}}static async createWithPeerId(t,n){let{create_tonk_with_peer_id:r}=n||await g(()=>Promise.resolve().then(()=>(I(),_)),void 0),i=await r(t);return new e(i)}static async fromBundle(t,n,r){let i=r||await g(()=>Promise.resolve().then(()=>(I(),_)),void 0);if(n?.storage){let{create_tonk_from_bundle_with_storage:r}=i,a=await r(t,n.storage.type===`indexeddb`);return new e(a)}else{let{create_tonk_from_bundle:n}=i,r=await n(t);return new e(r)}}static async fromBytes(t,n,r){let i=r||await g(()=>Promise.resolve().then(()=>(I(),_)),void 0);if(n?.storage){let{create_tonk_from_bytes_with_storage:r}=i,a=await r(t,n.storage.type===`indexeddb`);return new e(a)}else{let{create_tonk_from_bytes:n}=i,r=await n(t);return new e(r)}}getPeerId(){return L(this,z,`f`).getPeerId()}async connectWebsocket(e){try{await L(this,z,`f`).connectWebsocket(e)}catch(t){throw new ut(`Failed to connect to ${e}: ${t}`)}}async isConnected(){try{return await L(this,z,`f`).isConnected()}catch(e){return console.error(`ðŸ”Œ [CORE-JS] isConnected() error:`,e),!1}}async getConnectionState(){try{return await L(this,z,`f`).getConnectionState()}catch(e){return console.error(`ðŸ“¡ [CORE-JS] getConnectionState() error:`,e),`failed:`+String(e)}}async forkToBytes(e){try{return await L(this,z,`f`).forkToBytes(e)}catch(e){throw new B(`Failed to serialize to bundle data: ${e}`)}}async toBytes(e){try{return await L(this,z,`f`).toBytes(e)}catch(e){throw new B(`Failed to serialize to bundle data: ${e}`)}}async createFile(e,t){try{await L(this,z,`f`).createFile(e,t)}catch(t){throw new V(`Failed to create file at ${e}: ${t}`)}}async createFileWithBytes(e,t,n){try{let r=typeof n==`string`?dt(n):n;await L(this,z,`f`).createFileWithBytes(e,t,r)}catch(t){throw new V(`Failed to create file at ${e}: ${t}`)}}async readFile(e){try{let t=await L(this,z,`f`).readFile(e);if(t===null)throw new V(`File not found: ${e}`);let n;return t.bytes&&(n=ft(t.bytes)),{...t,content:JSON.parse(t.content),bytes:n}}catch(t){throw t instanceof V?t:new V(`Failed to read file at ${e}: ${t}`)}}async updateFile(e,t){try{return await L(this,z,`f`).updateFile(e,t)}catch(t){throw new V(`Failed to update file at ${e}: ${t}`)}}async updateFileWithBytes(e,t,n){try{let r=typeof n==`string`?dt(n):n;return await L(this,z,`f`).updateFileWithBytes(e,t,r)}catch(t){throw new V(`Failed to update file at ${e}: ${t}`)}}async deleteFile(e){try{return await L(this,z,`f`).deleteFile(e)}catch(t){throw new V(`Failed to delete file at ${e}: ${t}`)}}async createDirectory(e){try{await L(this,z,`f`).createDirectory(e)}catch(t){throw new V(`Failed to create directory at ${e}: ${t}`)}}async listDirectory(e){try{return(await L(this,z,`f`).listDirectory(e)).map(e=>({name:e.name,type:e.type,timestamps:e.timestamps,pointer:e.pointer}))}catch(t){throw new V(`Failed to list directory at ${e}: ${t}`)}}async exists(e){try{return await L(this,z,`f`).exists(e)}catch(t){throw new V(`Failed to check existence of ${e}: ${t}`)}}async rename(e,t){try{return await L(this,z,`f`).rename(e,t)}catch(n){throw new V(`Failed to rename ${e} to ${t}: ${n}`)}}async getMetadata(e){try{let t=await L(this,z,`f`).getMetadata(e);if(t===null)throw new V(`File or directory not found: ${e}`);return t}catch(t){throw t instanceof V?t:new V(`Failed to get metadata for ${e}: ${t}`)}}async watchFile(e,t){try{let n=await L(this,z,`f`).watchDocument(e,e=>{let n;e.bytes&&(n=ft(e.bytes)),t({...e,content:JSON.parse(e.content),bytes:n})});if(n===null)throw new V(`File not found: ${e}`);return n}catch(t){throw t instanceof V?t:new V(`Failed to watch file at path ${e}: ${t}`)}}async watchDirectory(e,t){try{let n=await L(this,z,`f`).watchDirectory(e,t);if(n===null)throw new V(`Directory not found: ${e}`);return n}catch(t){throw t instanceof V?t:new V(`Failed to watch directory at path ${e}: ${t}`)}}free(){L(this,z,`f`).free()}};z=new WeakMap;var dt=e=>{let t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n},ft=e=>{if(typeof e==`string`)return e;if(Array.isArray(e)){let t=8192,n=``;for(let r=0;r<e.length;r+=t){let i=e.slice(r,r+t);n+=String.fromCharCode(...i)}return btoa(n)}else throw new V(`Unrecognized bytes type in readFile ${typeof e}`)};I();var pt=!1,G=null;async function mt(e){if(!pt)return G||(G=(async()=>{try{e?.wasmPath?await F({module_or_path:e.wasmPath}):await F(),pt=!0}catch(e){throw G=null,e}})(),G)}var K=null,ht=!1;async function q(){if(ht){u.debug(`WASM already initialized`);return}return K?(u.debug(`WASM initialization in progress, waiting...`),K):(u.debug(`Starting WASM initialization`),K=(async()=>{try{let e=`/tonk_core_bg.wasm?t=${Date.now()}`;await mt({wasmPath:e}),ht=!0,u.info(`WASM initialization completed`)}catch(e){throw K=null,ht=!1,u.error(`WASM initialization failed`,{error:e instanceof Error?e.message:String(e)}),e}})(),K)}const J=`tonk-sw-state-v1`,gt=`/tonk-state/appSlug`,_t=`/tonk-state/bundleBytes`,vt=`/tonk-state/wsUrl`;async function yt(e){try{let t=await caches.open(J);if(e===null)await t.delete(gt);else{let n=new Response(JSON.stringify({slug:e}),{headers:{"Content-Type":`application/json`}});await t.put(gt,n)}u.debug(`AppSlug persisted to cache`,{slug:e})}catch(e){u.error(`Failed to persist appSlug`,{error:e instanceof Error?e.message:String(e)})}}async function bt(){try{let e=await(await caches.open(J)).match(gt);return e&&(await e.json()).slug||null}catch(e){return u.error(`Failed to restore appSlug`,{error:e instanceof Error?e.message:String(e)}),null}}async function Y(e){try{let t=await caches.open(J);if(e===null)await t.delete(_t);else{let n=new Blob([e],{type:`application/octet-stream`}),r=new Response(n,{headers:{"Content-Type":`application/octet-stream`}});await t.put(_t,r)}u.debug(`Bundle bytes persisted to cache`,{size:e?e.length:0})}catch(e){u.error(`Failed to persist bundle bytes`,{error:e instanceof Error?e.message:String(e)})}}async function xt(){try{let e=await(await caches.open(J)).match(_t);if(!e)return null;let t=await e.arrayBuffer();return new Uint8Array(t)}catch(e){return u.error(`Failed to restore bundle bytes`,{error:e instanceof Error?e.message:String(e)}),null}}async function X(e){try{let t=await caches.open(J);if(e===null)await t.delete(vt);else{let n=new Response(JSON.stringify({url:e}),{headers:{"Content-Type":`application/json`}});await t.put(vt,n)}u.debug(`WS URL persisted to cache`,{url:e})}catch(e){u.error(`Failed to persist WS URL`,{error:e instanceof Error?e.message:String(e)})}}async function St(){try{let e=await(await caches.open(J)).match(vt);return e&&(await e.json()).url||null}catch(e){return u.error(`Failed to restore WS URL`,{error:e instanceof Error?e.message:String(e)}),null}}async function Ct(){await Promise.all([yt(null),Y(null),X(null)])}async function Z(e){l(`info`,`Posting response to main thread`,{type:e.type,success:`success`in e?e.success:`N/A`}),(await self.clients.matchAll()).forEach(t=>{t.postMessage(e)})}async function wt(e){if(e.bytes){let t=atob(e.bytes),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return new Response(n,{headers:{"Content-Type":e.content.mime||`application/octet-stream`}})}else return new Response(e.content,{headers:{"Content-Type":`application/json`}})}async function Tt(){let e=p();if(!e)return!1;try{return await e.tonk.isConnected()}catch(e){return u.error(`performHealthCheck() failed`,{error:e instanceof Error?e.message:String(e)}),!1}}async function Et(){let e=p();if(!e){u.error(`Cannot reconnect: no active bundle`);return}let t=e.wsUrl;if(!t){u.error(`Cannot reconnect: wsUrl not stored`);return}let n=oe();n>=10&&se(),u.debug(`Attempting to reconnect`,{attempt:n,maxAttempts:10,wsUrl:t}),await Z({type:`reconnecting`,attempt:n});try{if(await e.tonk.connectWebsocket(t),await new Promise(e=>setTimeout(e,1e3)),await e.tonk.isConnected())ae(!0),se(),u.info(`Reconnection successful`),await Z({type:`reconnected`}),await Dt();else throw Error(`Connection check failed after reconnect attempt`)}catch(e){u.warn(`Reconnection failed`,{error:e instanceof Error?e.message:String(e),attempt:n});let t=Math.min(1e3*2**(n-1),3e4);u.debug(`Scheduling next reconnect attempt`,{delayMs:t,nextAttempt:n+1}),setTimeout(Et,t)}}async function Dt(){let e=fe();u.debug(`Re-establishing watchers after reconnection`,{watcherCount:e.length}),u.debug(`Watcher re-establishment complete`,{watcherCount:e.length}),await Z({type:`watchersReestablished`,count:e.length})}function Q(){let e=p();if(!e){u.warn(`Cannot start health monitoring: no active bundle`);return}e.healthCheckInterval&&clearInterval(e.healthCheckInterval),u.debug(`Starting health monitoring`,{intervalMs:r});let t=setInterval(async()=>{let e=await Tt(),n=p();if(!n){clearInterval(t);return}!e&&n.connectionHealthy?(ae(!1),u.warn(`Connection lost, starting reconnection attempts`),await Z({type:`disconnected`}),Et()):e&&!n.connectionHealthy&&(ae(!0),se(),u.debug(`Connection health restored`))},r);ce(t)}async function $(e){return u.debug(`Waiting for PathIndex to sync from remote...`),new Promise(t=>{let n=!1,r=null,i=setTimeout(()=>{if(r)try{r.stop()}catch(e){u.warn(`Error stopping PathIndex watcher on timeout`,{error:e instanceof Error?e.message:String(e)})}n||(u.debug(`No PathIndex changes detected after 1s - proceeding`),t())},1e3);e.watchDirectory(`/`,e=>{if(!n){if(n=!0,u.debug(`PathIndex synced from remote`,{documentType:e.type}),clearTimeout(i),r)try{r.stop()}catch(e){u.warn(`Error stopping PathIndex watcher after sync`,{error:e instanceof Error?e.message:String(e)})}t()}}).then(e=>{r=e,u.debug(`PathIndex watcher established`,{watcherId:e?.document_id||`unknown`})}).catch(e=>{u.error(`Failed to establish PathIndex watcher`,{error:e.message}),clearTimeout(i),t()})})}async function Ot(){try{let e=await bt(),t=await xt(),n=await St();if(!e||!t){u.debug(`No cached state found, waiting for initialization message`,{hasSlug:!!e,hasBundle:!!t});return}u.info(`Auto-initializing from cache`,{slug:e,bundleSize:t.length}),await q();let r=await(await U.fromBytes(t)).getManifest();u.debug(`Bundle and manifest restored from cache`,{rootId:r.rootId});let i=await W.fromBytes(t,{storage:{type:`indexeddb`}});u.debug(`TonkCore created from cached bundle`);let a=n||`${`https://relay.tonk.xyz`.replace(/^http/,`ws`)}`;!n&&a&&await X(a),u.debug(`Connecting to websocket...`,{wsUrl:a,localRootId:r.rootId}),await i.connectWebsocket(a),u.debug(`Websocket connected`),await $(i),u.info(`Auto-initialization complete`),h({status:`active`,bundleId:r.rootId,tonk:i,manifest:r,appSlug:e,wsUrl:a,healthCheckInterval:null,watchers:new Map,connectionHealthy:!0,reconnectAttempts:0}),Q()}catch(e){u.error(`Auto-initialization failed`,{error:e instanceof Error?e.message:String(e)}),h({status:`idle`}),await Ct(),(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:`needsReinit`,appSlug:null,reason:`Auto-initialization failed`})})}}async function kt(e,t,n,r){u.debug(`Loading new bundle`,{byteLength:e.length,serverUrl:t,hasCachedManifest:!!r});try{let n=f();await q();let i;if(r)u.info(`Using cached manifest, skipping Bundle.fromBytes`,{rootId:r.rootId}),i=r;else{u.debug(`No cached manifest, parsing bundle`,{byteLength:e.length});let t=await U.fromBytes(e);i=await t.getManifest(),t.free(),u.debug(`Bundle manifest extracted`,{rootId:i.rootId})}if(n.status===`active`&&n.manifest.rootId===i.rootId)return u.debug(`Bundle already loaded with same rootId, skipping reload`,{rootId:i.rootId}),{success:!0,skipped:!0};u.debug(`Creating new TonkCore from bundle bytes`);let a=await W.fromBytes(e,{storage:{type:`indexeddb`}});u.debug(`New TonkCore created successfully`,{rootId:i.rootId});let o=new URLSearchParams(self.location.search).get(`bundle`),s=`${t.replace(/^http/,`ws`)}`;if(o)try{let e=atob(o),t=JSON.parse(e);t.wsUrl&&(s=t.wsUrl)}catch(e){u.warn(`Could not parse bundle config for wsUrl`,{error:e instanceof Error?e.message:String(e)})}u.debug(`Determined websocket URL`,{wsUrl:s,serverUrl:t}),await X(s),u.debug(`Connecting new tonk to websocket`,{wsUrl:s,localRootId:i.rootId}),s&&(await a.connectWebsocket(s),u.debug(`Websocket connection established`),await $(a),u.debug(`PathIndex sync complete after loadBundle`));let c=f(),l=c.status===`active`?c.appSlug:i.entrypoints?.[0]||`app`;return h({status:`active`,bundleId:i.rootId,tonk:a,manifest:i,appSlug:l,wsUrl:s,healthCheckInterval:null,watchers:new Map,connectionHealthy:!0,reconnectAttempts:0}),Q(),await Y(e),u.debug(`Bundle bytes persisted to cache`),u.info(`Bundle loaded successfully`,{rootId:i.rootId}),{success:!0}}catch(e){return u.error(`Failed to load bundle`,{error:e instanceof Error?e.message:String(e)}),h({status:`error`,error:e instanceof Error?e:Error(String(e))}),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function At(e){u.debug(`Reading file`,{path:e.path});try{let t=m();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.readFile(e.path);u.debug(`File read successfully`,{path:e.path}),Z({type:`readFile`,id:e.id,success:!0,data:n})}catch(t){u.error(`Failed to read file`,{path:e.path,error:t instanceof Error?t.message:String(t)}),Z({type:`readFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function jt(e){u.debug(`Writing file`,{path:e.path,create:e.create,hasBytes:!!e.content.bytes});try{let t=m();if(!t)throw Error(`Tonk not initialized`);let n=e.content.content;e.create?(u.debug(`Creating new file`,{path:e.path}),e.content.bytes?await t.tonk.createFileWithBytes(e.path,n,e.content.bytes):await t.tonk.createFile(e.path,n)):(u.debug(`Updating existing file`,{path:e.path}),e.content.bytes?await t.tonk.updateFileWithBytes(e.path,n,e.content.bytes):await t.tonk.updateFile(e.path,n)),u.debug(`File write completed`,{path:e.path}),Z({type:`writeFile`,id:e.id,success:!0})}catch(t){u.error(`Failed to write file`,{path:e.path,create:e.create,error:t instanceof Error?t.message:String(t)}),Z({type:`writeFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Mt(e){u.debug(`Deleting file`,{path:e.path});try{let t=m();if(!t)throw Error(`Tonk not initialized`);await t.tonk.deleteFile(e.path),u.debug(`File deleted successfully`,{path:e.path}),Z({type:`deleteFile`,id:e.id,success:!0})}catch(t){u.error(`Failed to delete file`,{path:e.path,error:t instanceof Error?t.message:String(t)}),Z({type:`deleteFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Nt(e){u.debug(`Renaming file or directory`,{oldPath:e.oldPath,newPath:e.newPath});try{let t=m();if(!t)throw Error(`Tonk not initialized`);await t.tonk.rename(e.oldPath,e.newPath),u.debug(`Rename completed`,{oldPath:e.oldPath,newPath:e.newPath}),Z({type:`rename`,id:e.id,success:!0})}catch(t){u.error(`Failed to rename`,{oldPath:e.oldPath,newPath:e.newPath,error:t instanceof Error?t.message:String(t)}),Z({type:`rename`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Pt(e){u.debug(`Checking file existence`,{path:e.path});try{let t=m();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.exists(e.path);u.debug(`File existence check completed`,{path:e.path,exists:n}),Z({type:`exists`,id:e.id,success:!0,data:n})}catch(t){u.error(`Failed to check file existence`,{path:e.path,error:t instanceof Error?t.message:String(t)}),Z({type:`exists`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Ft(e){u.debug(`Listing directory`,{path:e.path});try{let t=m();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.listDirectory(e.path);u.debug(`Directory listed`,{path:e.path,fileCount:Array.isArray(n)?n.length:`unknown`}),Z({type:`listDirectory`,id:e.id,success:!0,data:n})}catch(t){u.error(`Failed to list directory`,{path:e.path,error:t instanceof Error?t.message:String(t)}),Z({type:`listDirectory`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function It(e){u.debug(`Starting file watch`,{path:e.path,watchId:e.id});try{let t=m();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.watchFile(e.path,t=>{u.debug(`File change detected`,{watchId:e.id,path:e.path}),Z({type:`fileChanged`,watchId:e.id,documentData:t})});n&&le(e.id,n),u.debug(`File watch started`,{path:e.path,watchId:e.id}),Z({type:`watchFile`,id:e.id,success:!0})}catch(t){u.error(`Failed to start file watch`,{path:e.path,error:t instanceof Error?t.message:String(t)}),Z({type:`watchFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Lt(e){u.debug(`Stopping file watch`,{watchId:e.id});try{de(e.id)?(u.debug(`Found watcher, stopping it`,{watchId:e.id}),ue(e.id),u.debug(`File watch stopped`,{watchId:e.id})):u.debug(`No watcher found for ID`,{watchId:e.id}),Z({type:`unwatchFile`,id:e.id,success:!0})}catch(t){u.error(`Failed to stop file watch`,{watchId:e.id,error:t instanceof Error?t.message:String(t)}),Z({type:`unwatchFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Rt(e){u.debug(`Starting directory watch`,{path:e.path,watchId:e.id});try{let t=m();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.watchDirectory(e.path,t=>{u.debug(`Directory change detected`,{watchId:e.id,path:e.path}),Z({type:`directoryChanged`,watchId:e.id,path:e.path,changeData:t})});n&&le(e.id,n),u.debug(`Directory watch started`,{path:e.path,watchId:e.id}),Z({type:`watchDirectory`,id:e.id,success:!0})}catch(t){u.error(`Failed to start directory watch`,{path:e.path,error:t instanceof Error?t.message:String(t)}),Z({type:`watchDirectory`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function zt(e){u.debug(`Stopping directory watch`,{watchId:e.id});try{de(e.id)?(u.debug(`Found directory watcher, stopping it`,{watchId:e.id}),ue(e.id),u.debug(`Directory watch stopped`,{watchId:e.id})):u.debug(`No directory watcher found for ID`,{watchId:e.id}),Z({type:`unwatchDirectory`,id:e.id,success:!0})}catch(t){u.error(`Failed to stop directory watch`,{watchId:e.id,error:t instanceof Error?t.message:String(t)}),Z({type:`unwatchDirectory`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Bt(e){u.debug(`Loading new bundle`,{byteLength:e.bundleBytes.byteLength,serverUrl:e.serverUrl,hasCachedManifest:!!e.manifest});let t=e.serverUrl||`https://relay.tonk.xyz`,n=new Uint8Array(e.bundleBytes),r=await kt(n,t,e.id,e.manifest);Z({type:`loadBundle`,id:e.id,success:r.success,skipped:r.skipped,error:r.error})}async function Vt(e){u.debug(`Converting tonk to bytes`);try{let t=m();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.toBytes(),r=t.manifest.rootId;u.debug(`Tonk converted to bytes`,{byteLength:n.length,rootId:r}),Z({type:`toBytes`,id:e.id,success:!0,data:n,rootId:r})}catch(t){u.error(`Failed to convert tonk to bytes`,{error:t instanceof Error?t.message:String(t)}),Z({type:`toBytes`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Ht(e){u.debug(`Forking tonk to bytes`);try{let t=m();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.forkToBytes(),r=(await(await U.fromBytes(n)).getManifest()).rootId;u.debug(`Tonk forked to bytes`,{byteLength:n.length,rootId:r}),Z({type:`forkToBytes`,id:e.id,success:!0,data:n,rootId:r})}catch(t){u.error(`Failed to fork tonk to bytes`,{error:t instanceof Error?t.message:String(t)}),Z({type:`forkToBytes`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Ut(e){u.debug(`Handling VFS init message`,{manifestSize:e.manifest.byteLength,wsUrl:e.wsUrl});try{let e=f();if(e.status===`active`){u.debug(`Tonk already initialized`),Z({type:`init`,success:!0});return}if(e.status===`loading`){u.debug(`Tonk is loading, waiting for completion`);try{await e.promise,u.debug(`Tonk loading completed`),Z({type:`init`,success:!0})}catch(e){u.error(`Tonk loading failed`,{error:e instanceof Error?e.message:String(e)}),Z({type:`init`,success:!1,error:e instanceof Error?e.message:String(e)})}return}if(e.status===`error`){u.error(`Tonk initialization failed previously`,{error:e.error.message}),Z({type:`init`,success:!1,error:e.error.message});return}u.warn(`Tonk is uninitialized, this is unexpected`),Z({type:`init`,success:!1,error:`Tonk not initialized`})}catch(e){u.error(`Failed to handle init message`,{error:e instanceof Error?e.message:String(e)}),Z({type:`init`,success:!1,error:e instanceof Error?e.message:String(e)})}}async function Wt(e){u.debug(`Initializing from URL`,{manifestUrl:e.manifestUrl,wasmUrl:e.wasmUrl});try{let t=e.manifestUrl||`https://relay.tonk.xyz/.manifest.tonk`,n=e.wsUrl||`https://relay.tonk.xyz`.replace(/^http/,`ws`);await q(),u.debug(`Fetching manifest from URL`,{manifestUrl:t});let r=await fetch(t),i=new Uint8Array(await r.arrayBuffer());u.debug(`Manifest bytes loaded`,{byteLength:i.length});let a=await(await U.fromBytes(i)).getManifest();u.debug(`Bundle and manifest created`),u.debug(`Creating TonkCore from manifest bytes`);let o=await W.fromBytes(i,{storage:{type:`indexeddb`}});u.debug(`TonkCore created`),await X(n),u.debug(`Connecting to websocket`,{wsUrl:n}),await o.connectWebsocket(n),u.debug(`Websocket connection established`),await $(o),u.debug(`PathIndex sync complete`),h({status:`active`,bundleId:a.rootId,tonk:o,manifest:a,appSlug:a.entrypoints?.[0]||`app`,wsUrl:n,healthCheckInterval:null,watchers:new Map,connectionHealthy:!0,reconnectAttempts:0}),Q(),await Y(i),u.debug(`Bundle bytes persisted`),u.info(`Initialized from URL successfully`),Z({type:`initializeFromUrl`,id:e.id,success:!0})}catch(t){u.error(`Failed to initialize from URL`,{error:t instanceof Error?t.message:String(t)}),h({status:`error`,error:t instanceof Error?t:Error(String(t))}),Z({type:`initializeFromUrl`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Gt(e){u.debug(`Initializing from bytes`,{byteLength:e.bundleBytes.byteLength,serverUrl:e.serverUrl});try{let t=e.serverUrl||`https://relay.tonk.xyz`,n=e.wsUrl||t.replace(/^http/,`ws`);u.debug(`Using server URL`,{serverUrl:t}),await q();let r=new Uint8Array(e.bundleBytes);u.debug(`Creating bundle from bytes`,{byteLength:r.length});let i=await(await U.fromBytes(r)).getManifest();u.debug(`Bundle and manifest created`,{rootId:i.rootId}),u.debug(`Creating TonkCore from bundle bytes`);let a=await W.fromBytes(r,{storage:{type:`indexeddb`}});u.debug(`TonkCore created`),u.debug(`Connecting to websocket`,{wsUrl:n}),n&&(await a.connectWebsocket(n),u.debug(`Websocket connection established`),await $(a),u.debug(`PathIndex sync complete`)),h({status:`active`,bundleId:i.rootId,tonk:a,manifest:i,appSlug:i.entrypoints?.[0]||`app`,wsUrl:n,healthCheckInterval:null,watchers:new Map,connectionHealthy:!0,reconnectAttempts:0}),Q(),await Y(r),u.debug(`Bundle bytes persisted`),u.info(`Initialized from bytes successfully`),Z({type:`initializeFromBytes`,id:e.id,success:!0})}catch(t){u.error(`Failed to initialize from bytes`,{error:t instanceof Error?t.message:String(t)}),h({status:`error`,error:t instanceof Error?t:Error(String(t))}),Z({type:`initializeFromBytes`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Kt(e){u.debug(`Getting server URL`),Z({type:`getServerUrl`,id:e.id,success:!0,data:`https://relay.tonk.xyz`})}async function qt(e){u.debug(`Getting manifest`);try{let t=m();if(!t)throw Error(`Tonk not initialized`);Z({type:`getManifest`,id:e.id,success:!0,data:t.manifest})}catch(t){u.error(`Failed to get manifest`,{error:t instanceof Error?t.message:String(t)}),Z({type:`getManifest`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Jt(){let e=f();u.debug(`Ping received`),Z({type:`ready`,status:e.status,needsBundle:e.status!==`active`})}async function Yt(e){f().status===`active`&&ie(e.slug),await yt(e.slug),u.debug(`App slug set and persisted`,{slug:e.slug})}var Xt=[`init`,`loadBundle`,`initializeFromUrl`,`initializeFromBytes`,`getServerUrl`,`ping`,`setAppSlug`];async function Zt(e){let t=e.type,n=e.id;u.debug(`Received message`,{type:t,id:n||`N/A`});let r=f();if(t===`setAppSlug`){await Yt({slug:e.slug});return}if(t===`ping`){await Jt();return}if(r.status!==`active`&&!Xt.includes(t)){u.warn(`Operation attempted before VFS initialization`,{type:t,status:r.status}),n&&Z({type:t,id:n,success:!1,error:`VFS not initialized. Please load a bundle first.`});return}switch(t){case`init`:await Ut({...n!==void 0&&{id:n},manifest:e.manifest,...e.wsUrl!==void 0&&{wsUrl:e.wsUrl}});break;case`initializeFromUrl`:await Wt({...n!==void 0&&{id:n},...e.manifestUrl!==void 0&&{manifestUrl:e.manifestUrl},...e.wasmUrl!==void 0&&{wasmUrl:e.wasmUrl},...e.wsUrl!==void 0&&{wsUrl:e.wsUrl}});break;case`initializeFromBytes`:await Gt({...n!==void 0&&{id:n},bundleBytes:e.bundleBytes,...e.serverUrl!==void 0&&{serverUrl:e.serverUrl},...e.wsUrl!==void 0&&{wsUrl:e.wsUrl}});break;case`getServerUrl`:await Kt({id:n});break;case`getManifest`:await qt({id:n});break;case`loadBundle`:await Bt({...n!==void 0&&{id:n},bundleBytes:e.bundleBytes,...e.serverUrl!==void 0&&{serverUrl:e.serverUrl},...e.manifest!==void 0&&{manifest:e.manifest}});break;case`toBytes`:await Vt({id:n});break;case`forkToBytes`:await Ht({id:n});break;case`readFile`:await At({id:n,path:e.path});break;case`writeFile`:await jt({id:n,path:e.path,...e.create!==void 0&&{create:e.create},content:e.content});break;case`deleteFile`:await Mt({id:n,path:e.path});break;case`rename`:await Nt({id:n,oldPath:e.oldPath,newPath:e.newPath});break;case`exists`:await Pt({id:n,path:e.path});break;case`listDirectory`:await Ft({id:n,path:e.path});break;case`watchFile`:await It({id:n,path:e.path});break;case`unwatchFile`:await Lt({id:n});break;case`watchDirectory`:await Rt({id:n,path:e.path});break;case`unwatchDirectory`:await zt({id:n});break;default:u.warn(`Unknown message type`,{type:t}),n&&Z({type:t,id:n,success:!1,error:`Unknown message type: ${t}`})}}function Qt(e,t){if(console.log(`determinePath START`,{url:e.href,pathname:e.pathname,appSlug:t||`none`}),!t)throw console.error(`determinePath - NO APP SLUG SET`),Error(`No app slug available for ${e.pathname}`);let n=new URL(self.registration?.scope??self.location.href).pathname,r=e.pathname.startsWith(n)?e.pathname.slice(n.length):e.pathname,i=r.replace(/^\/+/,``).split(`/`).filter(Boolean);console.log(`determinePath - segments`,{scopePath:n,strippedPath:r,segments:[...i],firstSegment:i[0]||`none`});let a=i;if(i[0]===t?(a=i.slice(1),console.log(`determinePath - appSlug already present, using remaining segments`,{pathSegments:[...a]})):console.log(`determinePath - appSlug not present, using all segments as path`,{pathSegments:[...a]}),a.length===0||e.pathname.endsWith(`/`)){let e=`${t}/index.html`;return console.log(`determinePath - defaulting to index.html`,{result:e}),e}let o=`${t}/${a.join(`/`)}`;return console.log(`determinePath - returning file path`,{result:o}),o}function $t(e){let t=new URL(e.request.url),n=e.request.referrer,r=f(),i=p()?.appSlug||null;u.debug(`Fetch event`,{url:t.href,pathname:t.pathname,state:r.status,appSlug:i});let a=e.request.headers.get(`upgrade`);if(a&&a.toLowerCase()===`websocket`){u.debug(`WebSocket upgrade request - passing through`,{url:t.href});return}let o=t.pathname===`/`||t.pathname===``;o&&i&&Promise.all([yt(null),Y(null)]).catch(e=>{u.error(`Failed to persist state reset`,{error:e})});let s=t.pathname.startsWith(`/app/`),c=t.searchParams.has(`bundleId`),l=[`/app/index.html`,`/app/main.js`,`/app/main.css`,`/app/service-worker-bundled.js`].some(e=>t.pathname===e),d=t.pathname.startsWith(`/app/`)&&[`.otf`,`.ttf`,`.woff`,`.woff2`,`.eot`].some(e=>t.pathname.endsWith(e));if(s&&(c||l||d)){u.debug(`Runtime static asset - passing through`,{pathname:t.pathname});return}if(s&&i!==`app`){u.debug(`Runtime path with non-app slug - passing through`,{pathname:t.pathname});return}if(i&&!o){if(t.pathname.startsWith(`/@vite`)||t.pathname.startsWith(`/@react-refresh`)||t.pathname.startsWith(`/src/`)||t.pathname.startsWith(`/${i}/@vite`)||t.pathname.startsWith(`/${i}/node_modules`)||t.pathname.startsWith(`/${i}/src/`)||t.pathname.startsWith(`/node_modules`)||t.pathname.includes(`__vite__`)||t.searchParams.has(`t`)){u.debug(`Vite HMR asset - proxying to dev server`,{pathname:t.pathname}),e.respondWith((async()=>{try{let e=`http://localhost:4001${t.pathname}${t.search}`,n=await fetch(e),r=new Headers(n.headers);return r.set(`Cache-Control`,`no-cache, no-store, must-revalidate`),r.set(`Pragma`,`no-cache`),r.set(`Expires`,`0`),new Response(n.body,{status:n.status,statusText:n.statusText,headers:r})}catch(e){return u.error(`Failed to fetch Vite asset`,{error:e instanceof Error?e.message:String(e),pathname:t.pathname}),new Response(`Vite dev server unreachable`,{status:502,headers:{"Content-Type":`text/plain`}})}})());return}u.debug(`TONK_SERVE_LOCAL - proxying to dev server`,{pathname:t.pathname}),e.respondWith((async()=>{try{let e=`http://localhost:4001${t.pathname}${t.search}`,n=await fetch(e),r=new Headers(n.headers);return r.set(`Cache-Control`,`no-cache, no-store, must-revalidate`),r.set(`Pragma`,`no-cache`),r.set(`Expires`,`0`),new Response(n.body,{status:n.status,statusText:n.statusText,headers:r})}catch(e){return u.error(`Failed to fetch from local dev server`,{error:e instanceof Error?e.message:String(e),pathname:t.pathname}),new Response(`Local dev server unreachable on port 4001`,{status:502,headers:{"Content-Type":`text/plain`}})}})());return}i&&t.origin===location.origin&&!o?(u.debug(`Processing VFS request`,{pathname:t.pathname,referrer:n}),e.respondWith((async()=>{try{let e=Qt(t,i);u.debug(`Resolved VFS path`,{path:e,url:t.pathname});let n=te();if(n&&f().status!==`active`){u.debug(`Waiting for initialization`,{status:f().status});try{await Promise.race([n,new Promise((e,t)=>setTimeout(()=>t(Error(`Initialization timeout`)),15e3))])}catch(e){u.warn(`Initialization wait failed or timed out`,{error:e instanceof Error?e.message:String(e)})}}let r=p();if(!r)throw u.error(`Tonk not initialized - cannot handle request`,{status:f().status,path:e}),Error(`Tonk not initialized`);let a=`/${e}`;if(!await r.tonk.exists(a)){u.debug(`File not found, falling back to index.html`,{path:a});let e=`/${i}/index.html`,t=await r.tonk.readFile(e);return wt(t)}u.debug(`Serving file from VFS`,{path:a});let o=await r.tonk.readFile(a);return await wt(o)}catch(n){return u.error(`Failed to fetch from VFS`,{error:n instanceof Error?n.message:String(n),url:t.href,status:f().status}),u.debug(`Falling back to network request`,{url:t.href}),fetch(e.request)}})())):u.debug(`Ignoring fetch - different origin or root`,{requestOrigin:t.origin,swOrigin:location.origin,isRoot:o})}var en=self;u.info(`Service worker starting`,{version:`mirjc0vi`,buildTime:`2025-12-04T14:32:32.621Z`,location:self.location.href}),u.debug(`Checking for cached state`),ne(Ot()),self.addEventListener(`install`,e=>{u.info(`Service worker installing`),en.skipWaiting(),u.debug(`skipWaiting called`)}),self.addEventListener(`activate`,e=>{u.info(`Service worker activating`),e.waitUntil((async()=>{await en.clients.claim(),u.debug(`Clients claimed`);let e=await en.clients.matchAll();e.forEach(e=>{e.postMessage({type:`ready`,needsBundle:!0})}),u.info(`Service worker activated`,{clientCount:e.length})})())}),self.addEventListener(`message`,async e=>{u.debug(`Message received`,{type:e.data?.type});try{await Zt(e.data)}catch(e){u.error(`Error handling message`,{error:e instanceof Error?e.message:String(e)})}}),self.addEventListener(`fetch`,e=>{$t(e)}),u.debug(`VFS Service Worker initialized`);