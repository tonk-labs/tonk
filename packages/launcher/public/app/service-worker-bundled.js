var e=Object.defineProperty,t=(e,t)=>()=>(e&&(t=e(e=0)),t),n=t=>{let n={};for(var r in t)e(n,r,{get:t[r],enumerable:!0});return n};const r=5e3;var i={debug:0,info:1,warn:2,error:3,none:4},a=`warn`;function o(){let e=self;return e.SW_LOG_LEVEL&&e.SW_LOG_LEVEL in i?e.SW_LOG_LEVEL:a}function s(e){let t=o();return i[e]>=i[t]}function c(e){return`[SW ${new Date().toISOString()}] ${e.toUpperCase()}:`}function l(e,t,n){if(!s(e))return;let r=c(e),i=e===`debug`?`log`:e;n===void 0?console[i](r,t):console[i](r,t,n)}const u={debug:(e,t)=>l(`debug`,e,t),info:(e,t)=>l(`info`,e,t),warn:(e,t)=>l(`warn`,e,t),error:(e,t)=>l(`error`,e,t),setLevel:e=>{let t=self;t.SW_LOG_LEVEL=e,console.log(`[SW] Log level set to: ${e}`)},getLevel:()=>o()},d=`tonk-sw-state-v1`,ee=`/tonk-state/appSlug`,te=`/tonk-state/bundleBytes`,ne=`/tonk-state/wsUrl`;async function re(e){try{let t=await caches.open(d);if(e===null)await t.delete(ee);else{let n=new Response(JSON.stringify({slug:e}),{headers:{"Content-Type":`application/json`}});await t.put(ee,n)}u.debug(`AppSlug persisted to cache`,{slug:e})}catch(e){u.error(`Failed to persist appSlug`,{error:e instanceof Error?e.message:String(e)})}}async function ie(){try{let e=await(await caches.open(d)).match(ee);return e&&(await e.json()).slug||null}catch(e){return u.error(`Failed to restore appSlug`,{error:e instanceof Error?e.message:String(e)}),null}}async function f(e){try{let t=await caches.open(d);if(e===null)await t.delete(te);else{let n=new Blob([e],{type:`application/octet-stream`}),r=new Response(n,{headers:{"Content-Type":`application/octet-stream`}});await t.put(te,r)}u.debug(`Bundle bytes persisted to cache`,{size:e?e.length:0})}catch(e){u.error(`Failed to persist bundle bytes`,{error:e instanceof Error?e.message:String(e)})}}async function ae(){try{let e=await(await caches.open(d)).match(te);if(!e)return null;let t=await e.arrayBuffer();return new Uint8Array(t)}catch(e){return u.error(`Failed to restore bundle bytes`,{error:e instanceof Error?e.message:String(e)}),null}}async function p(e){try{let t=await caches.open(d);if(e===null)await t.delete(ne);else{let n=new Response(JSON.stringify({url:e}),{headers:{"Content-Type":`application/json`}});await t.put(ne,n)}u.debug(`WS URL persisted to cache`,{url:e})}catch(e){u.error(`Failed to persist WS URL`,{error:e instanceof Error?e.message:String(e)})}}async function oe(){try{let e=await(await caches.open(d)).match(ne);return e&&(await e.json()).url||null}catch(e){return u.error(`Failed to restore WS URL`,{error:e instanceof Error?e.message:String(e)}),null}}async function se(){await Promise.all([re(null),f(null),p(null)])}var m={status:`idle`},ce=null;function h(){return m}function le(){return ce}function ue(e){ce=e}function g(){return m.status===`active`?m:null}function _(){return m.status===`active`?{tonk:m.tonk,manifest:m.manifest}:null}function de(e){u.debug(`Cleaning up active bundle state`,{bundleId:e.bundleId,watcherCount:e.watchers.size,hasHealthCheck:!!e.healthCheckInterval}),e.healthCheckInterval&&clearInterval(e.healthCheckInterval),e.watchers.forEach((e,t)=>{try{e.stop(),u.debug(`Stopped watcher`,{id:t})}catch(e){u.warn(`Error stopping watcher`,{id:t,error:e instanceof Error?e.message:String(e)})}});try{typeof e.tonk.disconnectWebsocket==`function`&&(e.tonk.disconnectWebsocket(),u.debug(`Disconnected WebSocket`))}catch(e){u.warn(`Error disconnecting WebSocket`,{error:e instanceof Error?e.message:String(e)})}}function v(e){let t=m;u.debug(`State transition`,{from:t.status,to:e.status,bundleId:`bundleId`in e?e.bundleId:void 0}),t.status===`active`&&de(t),m=e}function fe(e){return m.status===`active`?(m={...m,appSlug:e},!0):!1}function pe(e){m.status===`active`&&(m={...m,connectionHealthy:e})}function me(){return m.status===`active`?(m={...m,reconnectAttempts:m.reconnectAttempts+1},m.reconnectAttempts):0}function he(){m.status===`active`&&(m={...m,reconnectAttempts:0})}function ge(e){m.status===`active`&&(m={...m,healthCheckInterval:e})}function _e(e,t){m.status===`active`&&m.watchers.set(e,t)}function ve(e){if(m.status===`active`){let t=m.watchers.get(e);if(t){try{t.stop()}catch(t){u.warn(`Error stopping watcher on remove`,{id:e,error:t instanceof Error?t.message:String(t)})}return m.watchers.delete(e),!0}}return!1}function ye(e){if(m.status===`active`)return m.watchers.get(e)}function be(){return m.status===`active`?Array.from(m.watchers.entries()):[]}function xe(e,t){if(console.log(`determinePath START`,{url:e.href,pathname:e.pathname,appSlug:t||`none`}),!t)throw console.error(`determinePath - NO APP SLUG SET`),Error(`No app slug available for ${e.pathname}`);let n=new URL(self.registration?.scope??self.location.href).pathname,r=e.pathname.startsWith(n)?e.pathname.slice(n.length):e.pathname,i=r.replace(/^\/+/,``).split(`/`).filter(Boolean);console.log(`determinePath - segments`,{scopePath:n,strippedPath:r,segments:[...i],firstSegment:i[0]||`none`});let a=i;if(i[0]===t?(a=i.slice(1),console.log(`determinePath - appSlug already present, using remaining segments`,{pathSegments:[...a]})):console.log(`determinePath - appSlug not present, using all segments as path`,{pathSegments:[...a]}),a.length===0||e.pathname.endsWith(`/`)){let e=`${t}/index.html`;return console.log(`determinePath - defaulting to index.html`,{result:e}),e}let o=`${t}/${a.join(`/`)}`;return console.log(`determinePath - returning file path`,{result:o}),o}async function y(e){l(`info`,`Posting response to main thread`,{type:e.type,success:`success`in e?e.success:`N/A`}),(await self.clients.matchAll()).forEach(t=>{t.postMessage(e)})}async function Se(e){if(e.bytes){let t=atob(e.bytes),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return new Response(n,{headers:{"Content-Type":e.content.mime||`application/octet-stream`}})}else return new Response(e.content,{headers:{"Content-Type":`application/json`}})}function Ce(e){let t=new URL(e.request.url),n=e.request.referrer,r=h(),i=g()?.appSlug||null;u.debug(`Fetch event`,{url:t.href,pathname:t.pathname,state:r.status,appSlug:i});let a=e.request.headers.get(`upgrade`);if(a&&a.toLowerCase()===`websocket`){u.debug(`WebSocket upgrade request - passing through`,{url:t.href});return}let o=t.pathname===`/`||t.pathname===``;o&&i&&Promise.all([re(null),f(null)]).catch(e=>{u.error(`Failed to persist state reset`,{error:e})});let s=t.pathname.startsWith(`/app/`),c=t.searchParams.has(`bundleId`),l=[`/app/index.html`,`/app/main.js`,`/app/main.css`,`/app/service-worker-bundled.js`].some(e=>t.pathname===e),d=t.pathname.startsWith(`/app/`)&&[`.otf`,`.ttf`,`.woff`,`.woff2`,`.eot`].some(e=>t.pathname.endsWith(e));if(s&&(c||l||d)){u.debug(`Runtime static asset - passing through`,{pathname:t.pathname});return}if(s&&i!==`app`){u.debug(`Runtime path with non-app slug - passing through`,{pathname:t.pathname});return}if(i&&!o){if(t.pathname.startsWith(`/@vite`)||t.pathname.startsWith(`/@react-refresh`)||t.pathname.startsWith(`/src/`)||t.pathname.startsWith(`/${i}/@vite`)||t.pathname.startsWith(`/${i}/node_modules`)||t.pathname.startsWith(`/${i}/src/`)||t.pathname.startsWith(`/node_modules`)||t.pathname.includes(`__vite__`)||t.searchParams.has(`t`)){u.debug(`Vite HMR asset - proxying to dev server`,{pathname:t.pathname}),e.respondWith((async()=>{try{let e=`http://localhost:4001${t.pathname}${t.search}`,n=await fetch(e),r=new Headers(n.headers);return r.set(`Cache-Control`,`no-cache, no-store, must-revalidate`),r.set(`Pragma`,`no-cache`),r.set(`Expires`,`0`),new Response(n.body,{status:n.status,statusText:n.statusText,headers:r})}catch(e){return u.error(`Failed to fetch Vite asset`,{error:e instanceof Error?e.message:String(e),pathname:t.pathname}),new Response(`Vite dev server unreachable`,{status:502,headers:{"Content-Type":`text/plain`}})}})());return}u.debug(`TONK_SERVE_LOCAL - proxying to dev server`,{pathname:t.pathname}),e.respondWith((async()=>{try{let e=`http://localhost:4001${t.pathname}${t.search}`,n=await fetch(e),r=new Headers(n.headers);return r.set(`Cache-Control`,`no-cache, no-store, must-revalidate`),r.set(`Pragma`,`no-cache`),r.set(`Expires`,`0`),new Response(n.body,{status:n.status,statusText:n.statusText,headers:r})}catch(e){return u.error(`Failed to fetch from local dev server`,{error:e instanceof Error?e.message:String(e),pathname:t.pathname}),new Response(`Local dev server unreachable on port 4001`,{status:502,headers:{"Content-Type":`text/plain`}})}})());return}i&&t.origin===location.origin&&!o?(u.debug(`Processing VFS request`,{pathname:t.pathname,referrer:n}),e.respondWith((async()=>{try{let e=xe(t,i);u.debug(`Resolved VFS path`,{path:e,url:t.pathname});let n=le();if(n&&h().status!==`active`){u.debug(`Waiting for initialization`,{status:h().status});try{await Promise.race([n,new Promise((e,t)=>setTimeout(()=>t(Error(`Initialization timeout`)),15e3))])}catch(e){u.warn(`Initialization wait failed or timed out`,{error:e instanceof Error?e.message:String(e)})}}let r=g();if(!r)throw u.error(`Tonk not initialized - cannot handle request`,{status:h().status,path:e}),Error(`Tonk not initialized`);let a=`/${e}`;if(!await r.tonk.exists(a)){u.debug(`File not found, falling back to index.html`,{path:a});let e=`/${i}/index.html`,t=await r.tonk.readFile(e);return Se(t)}u.debug(`Serving file from VFS`,{path:a});let o=await r.tonk.readFile(a);return await Se(o)}catch(n){return u.error(`Failed to fetch from VFS`,{error:n instanceof Error?n.message:String(n),url:t.href,status:h().status}),u.debug(`Falling back to network request`,{url:t.href}),fetch(e.request)}})())):u.debug(`Ignoring fetch - different origin or root`,{requestOrigin:t.origin,swOrigin:location.origin,isRoot:o})}var we=`modulepreload`,Te=function(e){return`/`+e},Ee={};const b=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let e=document.getElementsByTagName(`link`),i=document.querySelector(`meta[property=csp-nonce]`),a=i?.nonce||i?.getAttribute(`nonce`);function o(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:`fulfilled`,value:e}),e=>({status:`rejected`,reason:e}))))}r=o(t.map(t=>{if(t=Te(t,n),t in Ee)return;Ee[t]=!0;let r=t.endsWith(`.css`),i=r?`[rel="stylesheet"]`:``;if(n)for(let n=e.length-1;n>=0;n--){let i=e[n];if(i.href===t&&(!r||i.rel===`stylesheet`))return}else if(document.querySelector(`link[href="${t}"]${i}`))return;let o=document.createElement(`link`);if(o.rel=r?`stylesheet`:we,r||(o.as=`script`),o.crossOrigin=``,o.href=t,a&&o.setAttribute(`nonce`,a),document.head.appendChild(o),r)return new Promise((e,n)=>{o.addEventListener(`load`,e),o.addEventListener(`error`,()=>n(Error(`Unable to preload CSS for ${t}`)))})}))}function i(e){let t=new Event(`vite:preloadError`,{cancelable:!0});if(t.payload=e,self.dispatchEvent(t),!t.defaultPrevented)throw e}return r.then(t=>{for(let e of t||[])e.status===`rejected`&&i(e.reason);return e().catch(i)})};var x=n({WasmBundle:()=>R,WasmDocHandle:()=>ct,WasmDocumentWatcher:()=>ut,WasmError:()=>ft,WasmRepo:()=>mt,WasmTonkCore:()=>gt,WasmWebSocketHandle:()=>vt,create_bundle_from_bytes:()=>Fe,create_tonk:()=>Be,create_tonk_from_bundle:()=>Me,create_tonk_from_bundle_with_storage:()=>Ne,create_tonk_from_bytes:()=>Pe,create_tonk_from_bytes_with_storage:()=>Ie,create_tonk_with_config:()=>Le,create_tonk_with_peer_id:()=>Re,create_tonk_with_storage:()=>ze,default:()=>z,init:()=>Ve,initSync:()=>Qe,set_time_provider:()=>He});function S(){return(M===null||M.byteLength===0)&&(M=new Uint8Array(j.memory.buffer)),M}function De(e,t){return P+=t,P>=et&&(N=typeof TextDecoder<`u`?new TextDecoder(`utf-8`,{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error(`TextDecoder not available`)}},N.decode(),P=t),N.decode(S().subarray(e,e+t))}function C(e,t){return e>>>=0,De(e,t)}function w(e,t,n){if(n===void 0){let n=I.encode(e),r=t(n.length,1)>>>0;return S().subarray(r,r+n.length).set(n),F=n.length,r}let r=e.length,i=t(r,1)>>>0,a=S(),o=0;for(;o<r;o++){let t=e.charCodeAt(o);if(t>127)break;a[i+o]=t}if(o!==r){o!==0&&(e=e.slice(o)),i=n(i,r,r=o+e.length*3,1)>>>0;let t=S().subarray(i+o,i+r),a=tt(e,t);o+=a.written,i=n(i,r,o,1)>>>0}return F=o,i}function T(){return(L===null||L.buffer.detached===!0||L.buffer.detached===void 0&&L.buffer!==j.memory.buffer)&&(L=new DataView(j.memory.buffer)),L}function E(e){let t=j.__externref_table_alloc();return j.__wbindgen_export_4.set(t,e),t}function D(e,t){try{return e.apply(this,t)}catch(e){let t=E(e);j.__wbindgen_exn_store(t)}}function O(e){return e==null}function Oe(e,t){return e>>>=0,S().subarray(e/1,e/1+t)}function k(e,t,n,r){let i={a:e,b:t,cnt:1,dtor:n},a=(...e)=>{i.cnt++;let t=i.a;i.a=0;try{return r(t,i.b,...e)}finally{--i.cnt===0?(j.__wbindgen_export_6.get(i.dtor)(t,i.b),nt.unregister(i)):i.a=t}};return a.original=i,nt.register(a,i,i),a}function ke(e){let t=typeof e;if(t==`number`||t==`boolean`||e==null)return`${e}`;if(t==`string`)return`"${e}"`;if(t==`symbol`){let t=e.description;return t==null?`Symbol`:`Symbol(${t})`}if(t==`function`){let t=e.name;return typeof t==`string`&&t.length>0?`Function(${t})`:`Function`}if(Array.isArray(e)){let t=e.length,n=`[`;t>0&&(n+=ke(e[0]));for(let r=1;r<t;r++)n+=`, `+ke(e[r]);return n+=`]`,n}let n=/\[object ([^\]]+)\]/.exec(toString.call(e)),r;if(n&&n.length>1)r=n[1];else return toString.call(e);if(r==`Object`)try{return`Object(`+JSON.stringify(e)+`)`}catch{return`Object`}return e instanceof Error?`${e.name}: ${e.message}\n${e.stack}`:r}function A(e){let t=j.__wbindgen_export_4.get(e);return j.__externref_table_dealloc(e),t}function Ae(e,t){if(!(e instanceof t))throw Error(`expected instance of ${t.name}`)}function je(e,t){let n=t(e.length*1,1)>>>0;return S().set(e,n/1),F=e.length,n}function Me(e){return Ae(e,R),j.create_tonk_from_bundle(e.__wbg_ptr)}function Ne(e,t){return Ae(e,R),j.create_tonk_from_bundle_with_storage(e.__wbg_ptr,t)}function Pe(e){return j.create_tonk_from_bytes(e)}function Fe(e){let t=j.create_bundle_from_bytes(e);if(t[2])throw A(t[1]);return R.__wrap(t[0])}function Ie(e,t){return j.create_tonk_from_bytes_with_storage(e,t)}function Le(e,t){let n=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),r=F;return j.create_tonk_with_config(n,r,t)}function Re(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.create_tonk_with_peer_id(t,n)}function ze(e){return j.create_tonk_with_storage(e)}function Be(){return j.create_tonk()}function Ve(){j.init()}function He(e){j.set_time_provider(e)}function Ue(e,t,n){j.closure721_externref_shim(e,t,n)}function We(e,t,n){let r=j.closure723_externref_shim_multivalue_shim(e,t,n);if(r[1])throw A(r[0])}function Ge(e,t,n){j.closure1001_externref_shim(e,t,n)}function Ke(e,t){j.wasm_bindgen__convert__closures_____invoke__h038a891901e51a38(e,t)}function qe(e,t,n){j.closure1019_externref_shim(e,t,n)}function Je(e,t,n,r){j.closure1277_externref_shim(e,t,n,r)}async function Ye(e,t){if(typeof Response==`function`&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming==`function`)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if(e.ok&&yt.has(e.type)&&e.headers.get(`Content-Type`)!==`application/wasm`)console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t);else throw t}let n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{let n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function Xe(){let e={};return e.wbg={},e.wbg.__wbg_Error_0497d5bdba9362e5=function(e,t){return Error(C(e,t))},e.wbg.__wbg_String_8f0eb39a4a4c2f66=function(e,t){let n=w(String(t),j.__wbindgen_malloc,j.__wbindgen_realloc),r=F;T().setInt32(e+4,r,!0),T().setInt32(e+0,n,!0)},e.wbg.__wbg_Window_41559019033ede94=function(e){return e.Window},e.wbg.__wbg_WorkerGlobalScope_d324bffbeaef9f3a=function(e){return e.WorkerGlobalScope},e.wbg.__wbg_abort_601b12a63a2f3a3a=function(){return D(function(e){e.abort()},arguments)},e.wbg.__wbg_bound_eb572b424befade3=function(){return D(function(e,t,n,r){return IDBKeyRange.bound(e,t,n!==0,r!==0)},arguments)},e.wbg.__wbg_buffer_a1a27a0dfa70165d=function(e){return e.buffer},e.wbg.__wbg_buffer_e495ba54cee589cc=function(e){return e.buffer},e.wbg.__wbg_call_f2db6205e5c51dc8=function(){return D(function(e,t,n){return e.call(t,n)},arguments)},e.wbg.__wbg_call_fbe8be8bf6436ce5=function(){return D(function(e,t){return e.call(t)},arguments)},e.wbg.__wbg_close_b08c03c920ee0bba=function(){return D(function(e){e.close()},arguments)},e.wbg.__wbg_commit_a54edce65f3858f2=function(){return D(function(e){e.commit()},arguments)},e.wbg.__wbg_continue_7d9cdafc888cb902=function(){return D(function(e){e.continue()},arguments)},e.wbg.__wbg_createObjectStore_b1f08961900155dd=function(){return D(function(e,t,n){return e.createObjectStore(C(t,n))},arguments)},e.wbg.__wbg_data_fffd43bf0ca75fff=function(e){return e.data},e.wbg.__wbg_delete_71b7921c73aa9378=function(){return D(function(e,t){return e.delete(t)},arguments)},e.wbg.__wbg_done_4d01f352bade43b7=function(e){return e.done},e.wbg.__wbg_entries_41651c850143b957=function(e){return Object.entries(e)},e.wbg.__wbg_error_31d7961b8e0d3f6c=function(e,t){console.error(C(e,t))},e.wbg.__wbg_error_4e978abc9692c0c5=function(){return D(function(e){let t=e.error;return O(t)?0:E(t)},arguments)},e.wbg.__wbg_error_51ecdd39ec054205=function(e){console.error(e)},e.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let n,r;try{n=e,r=t,console.error(C(e,t))}finally{j.__wbindgen_free(n,r,1)}},e.wbg.__wbg_from_12ff8e47307bd4c7=function(e){return Array.from(e)},e.wbg.__wbg_getRandomValues_1c61fac11405ffdc=function(){return D(function(e,t){globalThis.crypto.getRandomValues(Oe(e,t))},arguments)},e.wbg.__wbg_getTime_2afe67905d873e92=function(e){return e.getTime()},e.wbg.__wbg_get_92470be87867c2e5=function(){return D(function(e,t){return Reflect.get(e,t)},arguments)},e.wbg.__wbg_get_a131a44bd1eb6979=function(e,t){return e[t>>>0]},e.wbg.__wbg_get_d37904b955701f99=function(){return D(function(e,t){return e.get(t)},arguments)},e.wbg.__wbg_getwithrefkey_1dc361bd10053bfe=function(e,t){return e[t]},e.wbg.__wbg_global_f5c2926e57ba457f=function(e){return e.global},e.wbg.__wbg_indexedDB_317016dcb8a872d6=function(){return D(function(e){let t=e.indexedDB;return O(t)?0:E(t)},arguments)},e.wbg.__wbg_indexedDB_54f01430b1e194e8=function(){return D(function(e){let t=e.indexedDB;return O(t)?0:E(t)},arguments)},e.wbg.__wbg_indexedDB_63b82e158eb67cbd=function(){return D(function(e){let t=e.indexedDB;return O(t)?0:E(t)},arguments)},e.wbg.__wbg_instanceof_ArrayBuffer_a8b6f580b363f2bc=function(e){let t;try{t=e instanceof ArrayBuffer}catch{t=!1}return t},e.wbg.__wbg_instanceof_CursorSys_4b6a8aba0e823e75=function(e){let t;try{t=e instanceof IDBCursorWithValue}catch{t=!1}return t},e.wbg.__wbg_instanceof_DomException_77720ed8752d7409=function(e){let t;try{t=e instanceof DOMException}catch{t=!1}return t},e.wbg.__wbg_instanceof_Error_58a92d81483a4b16=function(e){let t;try{t=e instanceof Error}catch{t=!1}return t},e.wbg.__wbg_instanceof_IdbCursor_07be219dc9364535=function(e){let t;try{t=e instanceof IDBCursor}catch{t=!1}return t},e.wbg.__wbg_instanceof_IdbDatabase_0ed56ed115d533bc=function(e){let t;try{t=e instanceof IDBDatabase}catch{t=!1}return t},e.wbg.__wbg_instanceof_IdbRequest_c4498c7b5a3a0fa3=function(e){let t;try{t=e instanceof IDBRequest}catch{t=!1}return t},e.wbg.__wbg_instanceof_Map_80cc65041c96417a=function(e){let t;try{t=e instanceof Map}catch{t=!1}return t},e.wbg.__wbg_instanceof_Uint8Array_ca460677bc155827=function(e){let t;try{t=e instanceof Uint8Array}catch{t=!1}return t},e.wbg.__wbg_isArray_5f090bed72bd4f89=function(e){return Array.isArray(e)},e.wbg.__wbg_isSafeInteger_90d7c4674047d684=function(e){return Number.isSafeInteger(e)},e.wbg.__wbg_item_15285ca2d766f142=function(e,t,n){let r=t.item(n>>>0);var i=O(r)?0:w(r,j.__wbindgen_malloc,j.__wbindgen_realloc),a=F;T().setInt32(e+4,a,!0),T().setInt32(e+0,i,!0)},e.wbg.__wbg_iterator_4068add5b2aef7a6=function(){return Symbol.iterator},e.wbg.__wbg_key_a17a68df9ec1b180=function(){return D(function(e){return e.key},arguments)},e.wbg.__wbg_keys_42062809bf87339e=function(e){return Object.keys(e)},e.wbg.__wbg_length_ab6d22b5ead75c72=function(e){return e.length},e.wbg.__wbg_length_f00ec12454a5d9fd=function(e){return e.length},e.wbg.__wbg_log_0cc1b7768397bcfe=function(e,t,n,r,i,a,o,s){let c,l;try{c=e,l=t,console.log(C(e,t),C(n,r),C(i,a),C(o,s))}finally{j.__wbindgen_free(c,l,1)}},e.wbg.__wbg_log_cb9e190acc5753fb=function(e,t){let n,r;try{n=e,r=t,console.log(C(e,t))}finally{j.__wbindgen_free(n,r,1)}},e.wbg.__wbg_log_ea240990d83e374e=function(e){console.log(e)},e.wbg.__wbg_lowerBound_13c8e875a3fb9f7d=function(){return D(function(e,t){return IDBKeyRange.lowerBound(e,t!==0)},arguments)},e.wbg.__wbg_mark_7438147ce31e9d4b=function(e,t){performance.mark(C(e,t))},e.wbg.__wbg_measure_fb7825c11612c823=function(){return D(function(e,t,n,r){let i,a,o,s;try{i=e,a=t,o=n,s=r,performance.measure(C(e,t),C(n,r))}finally{j.__wbindgen_free(i,a,1),j.__wbindgen_free(o,s,1)}},arguments)},e.wbg.__wbg_message_2d95ea5aff0d63b9=function(e,t){let n=t.message,r=w(n,j.__wbindgen_malloc,j.__wbindgen_realloc),i=F;T().setInt32(e+4,i,!0),T().setInt32(e+0,r,!0)},e.wbg.__wbg_message_4159c15dac08c5e9=function(e){return e.message},e.wbg.__wbg_message_44ef9b801b7d8bc3=function(e,t){let n=t.message,r=w(n,j.__wbindgen_malloc,j.__wbindgen_realloc),i=F;T().setInt32(e+4,i,!0),T().setInt32(e+0,r,!0)},e.wbg.__wbg_name_2acff1e83d9735f9=function(e,t){let n=t.name,r=w(n,j.__wbindgen_malloc,j.__wbindgen_realloc),i=F;T().setInt32(e+4,i,!0),T().setInt32(e+0,r,!0)},e.wbg.__wbg_new0_97314565408dea38=function(){return new Date},e.wbg.__wbg_new_07b483f72211fd66=function(){return{}},e.wbg.__wbg_new_476169e6d59f23ae=function(e,t){return Error(C(e,t))},e.wbg.__wbg_new_58353953ad2097cc=function(){return[]},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return Error()},e.wbg.__wbg_new_a979b4b45bd55c7f=function(){return new Map},e.wbg.__wbg_new_e30c39c06edaabf2=function(e,t){try{var n={a:e,b:t};return new Promise((e,t)=>{let r=n.a;n.a=0;try{return Je(r,n.b,e,t)}finally{n.a=r}})}finally{n.a=n.b=0}},e.wbg.__wbg_new_e52b3efaaa774f96=function(e){return new Uint8Array(e)},e.wbg.__wbg_new_f42a001532528172=function(){return D(function(e,t){return new WebSocket(C(e,t))},arguments)},e.wbg.__wbg_newfromslice_7c05ab1297cb2d88=function(e,t){return new Uint8Array(Oe(e,t))},e.wbg.__wbg_newnoargs_ff528e72d35de39a=function(e,t){return Function(C(e,t))},e.wbg.__wbg_newwithbyteoffsetandlength_3b01ecda099177e8=function(e,t,n){return new Uint8Array(e,t>>>0,n>>>0)},e.wbg.__wbg_newwithlength_08f872dc1e3ada2e=function(e){return new Uint8Array(e>>>0)},e.wbg.__wbg_next_8bb824d217961b5d=function(e){return e.next},e.wbg.__wbg_next_e2da48d8fff7439a=function(){return D(function(e){return e.next()},arguments)},e.wbg.__wbg_now_eb0821f3bd9f6529=function(){return Date.now()},e.wbg.__wbg_objectStoreNames_e82275eb2d403a92=function(e){return e.objectStoreNames},e.wbg.__wbg_objectStore_b463d32c86d6b543=function(){return D(function(e,t,n){return e.objectStore(C(t,n))},arguments)},e.wbg.__wbg_openCursor_7c13a2cd32c6258b=function(){return D(function(e){return e.openCursor()},arguments)},e.wbg.__wbg_open_0f04f50fa4d98f67=function(){return D(function(e,t,n,r){return e.open(C(t,n),r>>>0)},arguments)},e.wbg.__wbg_push_73fd7b5550ebf707=function(e,t){return e.push(t)},e.wbg.__wbg_put_7f0b4dcc666f09e3=function(){return D(function(e,t,n){return e.put(t,n)},arguments)},e.wbg.__wbg_queueMicrotask_46c1df247678729f=function(e){queueMicrotask(e)},e.wbg.__wbg_queueMicrotask_8acf3ccb75ed8d11=function(e){return e.queueMicrotask},e.wbg.__wbg_readyState_249e5707a38b7a7a=function(e){let t=e.readyState;return(it.indexOf(t)+1||3)-1},e.wbg.__wbg_request_5079471e06223120=function(e){return e.request},e.wbg.__wbg_request_fada8c23b78b3a02=function(e){return e.request},e.wbg.__wbg_resolve_0dac8c580ffd4678=function(e){return Promise.resolve(e)},e.wbg.__wbg_result_a0f1bf2fe64a516c=function(){return D(function(e){return e.result},arguments)},e.wbg.__wbg_send_05456d2bf190b017=function(){return D(function(e,t){e.send(t)},arguments)},e.wbg.__wbg_set_3f1d0b984ed272ed=function(e,t,n){e[t]=n},e.wbg.__wbg_set_7422acbe992d64ab=function(e,t,n){e[t>>>0]=n},e.wbg.__wbg_set_c43293f93a35998a=function(){return D(function(e,t,n){return Reflect.set(e,t,n)},arguments)},e.wbg.__wbg_set_d6bdfd275fb8a4ce=function(e,t,n){return e.set(t,n)},e.wbg.__wbg_set_fe4e79d1ed3b0e9b=function(e,t,n){e.set(t,n>>>0)},e.wbg.__wbg_setbinaryType_52787d6025601cc5=function(e,t){e.binaryType=rt[t]},e.wbg.__wbg_setonabort_479ebb5884fcb171=function(e,t){e.onabort=t},e.wbg.__wbg_setonclose_c6db38f935250174=function(e,t){e.onclose=t},e.wbg.__wbg_setoncomplete_27bdbca012e45c05=function(e,t){e.oncomplete=t},e.wbg.__wbg_setonerror_537b68f474e27d4e=function(e,t){e.onerror=t},e.wbg.__wbg_setonerror_ab02451cd01cb480=function(e,t){e.onerror=t},e.wbg.__wbg_setonerror_ce5c4d34aed931bb=function(e,t){e.onerror=t},e.wbg.__wbg_setonmessage_49ca623a77cfb3e6=function(e,t){e.onmessage=t},e.wbg.__wbg_setonopen_1475cbeb761c101f=function(e,t){e.onopen=t},e.wbg.__wbg_setonsuccess_0b2b45bd8cc13b95=function(e,t){e.onsuccess=t},e.wbg.__wbg_setonupgradeneeded_be2e0ae927917f82=function(e,t){e.onupgradeneeded=t},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){let n=t.stack,r=w(n,j.__wbindgen_malloc,j.__wbindgen_realloc),i=F;T().setInt32(e+4,i,!0),T().setInt32(e+0,r,!0)},e.wbg.__wbg_static_accessor_GLOBAL_487c52c58d65314d=function(){let e=typeof globalThis>`u`?null:globalThis;return O(e)?0:E(e)},e.wbg.__wbg_static_accessor_GLOBAL_THIS_ee9704f328b6b291=function(){let e=typeof globalThis>`u`?null:globalThis;return O(e)?0:E(e)},e.wbg.__wbg_static_accessor_SELF_78c9e3071b912620=function(){let e=typeof self>`u`?null:self;return O(e)?0:E(e)},e.wbg.__wbg_static_accessor_WINDOW_a093d21393777366=function(){let e=typeof self>`u`?null:self;return O(e)?0:E(e)},e.wbg.__wbg_target_15f1da583855ac4e=function(e){let t=e.target;return O(t)?0:E(t)},e.wbg.__wbg_then_82ab9fb4080f1707=function(e,t,n){return e.then(t,n)},e.wbg.__wbg_then_db882932c0c714c6=function(e,t){return e.then(t)},e.wbg.__wbg_toString_bc7a05a172b5cf14=function(e){return e.toString()},e.wbg.__wbg_transaction_36c8b28ed4349a9a=function(){return D(function(e,t,n,r){return e.transaction(C(t,n),at[r])},arguments)},e.wbg.__wbg_transaction_d1f21f4378880521=function(e){return e.transaction},e.wbg.__wbg_upperBound_a0bd8ece19d98580=function(){return D(function(e,t){return IDBKeyRange.upperBound(e,t!==0)},arguments)},e.wbg.__wbg_value_17b896954e14f896=function(e){return e.value},e.wbg.__wbg_value_648dc44894c8dc95=function(){return D(function(e){return e.value},arguments)},e.wbg.__wbg_wasmdochandle_new=function(e){return ct.__wrap(e)},e.wbg.__wbg_wasmdocumentwatcher_new=function(e){return ut.__wrap(e)},e.wbg.__wbg_wasmerror_new=function(e){return ft.__wrap(e)},e.wbg.__wbg_wasmrepo_new=function(e){return mt.__wrap(e)},e.wbg.__wbg_wasmtonkcore_new=function(e){return gt.__wrap(e)},e.wbg.__wbindgen_bigint_from_i64=function(e){return e},e.wbg.__wbindgen_bigint_from_u64=function(e){return BigInt.asUintN(64,e)},e.wbg.__wbindgen_bigint_get_as_i64=function(e,t){let n=t,r=typeof n==`bigint`?n:void 0;T().setBigInt64(e+8,O(r)?BigInt(0):r,!0),T().setInt32(e+0,!O(r),!0)},e.wbg.__wbindgen_boolean_get=function(e){let t=e;return typeof t==`boolean`?t?1:0:2},e.wbg.__wbindgen_cb_drop=function(e){let t=e.original;return t.cnt--==1?(t.a=0,!0):!1},e.wbg.__wbindgen_closure_wrapper1907=function(e,t,n){return k(e,t,720,Ue)},e.wbg.__wbindgen_closure_wrapper1909=function(e,t,n){return k(e,t,720,We)},e.wbg.__wbindgen_closure_wrapper1911=function(e,t,n){return k(e,t,720,Ue)},e.wbg.__wbindgen_closure_wrapper1913=function(e,t,n){return k(e,t,720,Ue)},e.wbg.__wbindgen_closure_wrapper2608=function(e,t,n){return k(e,t,1e3,Ge)},e.wbg.__wbindgen_closure_wrapper2610=function(e,t,n){return k(e,t,1e3,Ke)},e.wbg.__wbindgen_closure_wrapper2638=function(e,t,n){return k(e,t,1018,qe)},e.wbg.__wbindgen_debug_string=function(e,t){let n=ke(t),r=w(n,j.__wbindgen_malloc,j.__wbindgen_realloc),i=F;T().setInt32(e+4,i,!0),T().setInt32(e+0,r,!0)},e.wbg.__wbindgen_in=function(e,t){return e in t},e.wbg.__wbindgen_init_externref_table=function(){let e=j.__wbindgen_export_4,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},e.wbg.__wbindgen_is_bigint=function(e){return typeof e==`bigint`},e.wbg.__wbindgen_is_function=function(e){return typeof e==`function`},e.wbg.__wbindgen_is_null=function(e){return e===null},e.wbg.__wbindgen_is_object=function(e){let t=e;return typeof t==`object`&&!!t},e.wbg.__wbindgen_is_string=function(e){return typeof e==`string`},e.wbg.__wbindgen_is_undefined=function(e){return e===void 0},e.wbg.__wbindgen_jsval_eq=function(e,t){return e===t},e.wbg.__wbindgen_jsval_loose_eq=function(e,t){return e==t},e.wbg.__wbindgen_memory=function(){return j.memory},e.wbg.__wbindgen_number_get=function(e,t){let n=t,r=typeof n==`number`?n:void 0;T().setFloat64(e+8,O(r)?0:r,!0),T().setInt32(e+0,!O(r),!0)},e.wbg.__wbindgen_number_new=function(e){return e},e.wbg.__wbindgen_string_get=function(e,t){let n=t,r=typeof n==`string`?n:void 0;var i=O(r)?0:w(r,j.__wbindgen_malloc,j.__wbindgen_realloc),a=F;T().setInt32(e+4,a,!0),T().setInt32(e+0,i,!0)},e.wbg.__wbindgen_string_new=function(e,t){return C(e,t)},e.wbg.__wbindgen_throw=function(e,t){throw Error(C(e,t))},e}function Ze(e,t){return j=e.exports,$e.__wbindgen_wasm_module=t,L=null,M=null,j.__wbindgen_start(),j}function Qe(e){if(j!==void 0)return j;e!==void 0&&(Object.getPrototypeOf(e)===Object.prototype?{module:e}=e:console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));let t=Xe();e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e));let n=new WebAssembly.Instance(e,t);return Ze(n,e)}async function $e(e){if(j!==void 0)return j;e!==void 0&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn(`using deprecated parameters for the initialization function; pass a single object instead`)),e===void 0&&(e=new URL(`/tonk_core_bg.wasm`,``+import.meta.url));let t=Xe();(typeof e==`string`||typeof Request==`function`&&e instanceof Request||typeof URL==`function`&&e instanceof URL)&&(e=fetch(e));let{instance:n,module:r}=await Ye(await e,t);return Ze(n,r)}var j,M,N,et,P,F,I,tt,L,nt,rt,it,at,ot,R,st,ct,lt,ut,dt,ft,pt,mt,ht,gt,_t,vt,yt,z,B=t((()=>{M=null,N=typeof TextDecoder<`u`?new TextDecoder(`utf-8`,{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error(`TextDecoder not available`)}},typeof TextDecoder<`u`&&N.decode(),et=2146435072,P=0,F=0,I=typeof TextEncoder<`u`?new TextEncoder(`utf-8`):{encode:()=>{throw Error(`TextEncoder not available`)}},tt=typeof I.encodeInto==`function`?function(e,t){return I.encodeInto(e,t)}:function(e,t){let n=I.encode(e);return t.set(n),{read:e.length,written:n.length}},L=null,nt=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>{j.__wbindgen_export_6.get(e.dtor)(e.a,e.b)}),rt=[`blob`,`arraybuffer`],it=[`pending`,`done`],at=[`readonly`,`readwrite`,`versionchange`,`readwriteflush`,`cleanup`],ot=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>j.__wbg_wasmbundle_free(e>>>0,1)),R=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,ot.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,ot.unregister(this),e}free(){let e=this.__destroy_into_raw();j.__wbg_wasmbundle_free(e,0)}static fromBytes(t){let n=j.wasmbundle_fromBytes(t);if(n[2])throw A(n[1]);return e.__wrap(n[0])}getPrefix(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmbundle_getPrefix(this.__wbg_ptr,t,n)}getRootId(){return j.wasmbundle_getRootId(this.__wbg_ptr)}getManifest(){return j.wasmbundle_getManifest(this.__wbg_ptr)}setManifest(e){return j.wasmbundle_setManifest(this.__wbg_ptr,e)}get(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmbundle_get(this.__wbg_ptr,t,n)}toBytes(){return j.wasmbundle_toBytes(this.__wbg_ptr)}listKeys(){return j.wasmbundle_listKeys(this.__wbg_ptr)}},st=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>j.__wbg_wasmdochandle_free(e>>>0,1)),ct=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,st.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,st.unregister(this),e}free(){let e=this.__destroy_into_raw();j.__wbg_wasmdochandle_free(e,0)}documentId(){let e,t;try{let n=j.wasmdochandle_documentId(this.__wbg_ptr);return e=n[0],t=n[1],C(n[0],n[1])}finally{j.__wbindgen_free(e,t,1)}}getDocument(){let e=j.wasmdochandle_getDocument(this.__wbg_ptr);if(e[2])throw A(e[1]);return A(e[0])}url(){let e,t;try{let n=j.wasmdochandle_url(this.__wbg_ptr);return e=n[0],t=n[1],C(n[0],n[1])}finally{j.__wbindgen_free(e,t,1)}}},lt=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>j.__wbg_wasmdocumentwatcher_free(e>>>0,1)),ut=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,lt.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,lt.unregister(this),e}free(){let e=this.__destroy_into_raw();j.__wbg_wasmdocumentwatcher_free(e,0)}documentId(){let e,t;try{let n=j.wasmdocumentwatcher_documentId(this.__wbg_ptr);return e=n[0],t=n[1],C(n[0],n[1])}finally{j.__wbindgen_free(e,t,1)}}stop(){return j.wasmdocumentwatcher_stop(this.__wbg_ptr)}},dt=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>j.__wbg_wasmerror_free(e>>>0,1)),ft=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,dt.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,dt.unregister(this),e}free(){let e=this.__destroy_into_raw();j.__wbg_wasmerror_free(e,0)}get message(){let e,t;try{let n=j.wasmerror_message(this.__wbg_ptr);return e=n[0],t=n[1],C(n[0],n[1])}finally{j.__wbindgen_free(e,t,1)}}},pt=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>j.__wbg_wasmrepo_free(e>>>0,1)),mt=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,pt.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,pt.unregister(this),e}free(){let e=this.__destroy_into_raw();j.__wbg_wasmrepo_free(e,0)}findDocument(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmrepo_findDocument(this.__wbg_ptr,t,n)}listDocuments(){let e=j.wasmrepo_listDocuments(this.__wbg_ptr);if(e[2])throw A(e[1]);return A(e[0])}createDocument(e){return j.wasmrepo_createDocument(this.__wbg_ptr,e)}connectWebSocket(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F,r=j.wasmrepo_connectWebSocket(this.__wbg_ptr,t,n);if(r[2])throw A(r[1]);return vt.__wrap(r[0])}connectWebSocketAsync(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmrepo_connectWebSocketAsync(this.__wbg_ptr,t,n)}constructor(){return j.wasmrepo_new()}stop(){return j.wasmrepo_stop(this.__wbg_ptr)}peerId(){let e,t;try{let n=j.wasmrepo_peerId(this.__wbg_ptr);return e=n[0],t=n[1],C(n[0],n[1])}finally{j.__wbindgen_free(e,t,1)}}},ht=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>j.__wbg_wasmtonkcore_free(e>>>0,1)),gt=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,ht.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,ht.unregister(this),e}free(){let e=this.__destroy_into_raw();j.__wbg_wasmtonkcore_free(e,0)}static fromBytes(e){return j.wasmtonkcore_fromBytes(e)}patchFile(e,t,n){let r=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),i=F;return j.wasmtonkcore_patchFile(this.__wbg_ptr,r,i,t,n)}createFile(e,t){let n=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),r=F;return j.wasmtonkcore_createFile(this.__wbg_ptr,n,r,t)}deleteFile(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmtonkcore_deleteFile(this.__wbg_ptr,t,n)}static fromBundle(e){return Ae(e,R),j.wasmtonkcore_fromBundle(e.__wbg_ptr)}getPeerId(){return j.wasmtonkcore_getPeerId(this.__wbg_ptr)}spliceText(e,t,n,r,i){let a=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),o=F,s=w(i,j.__wbindgen_malloc,j.__wbindgen_realloc),c=F;return j.wasmtonkcore_spliceText(this.__wbg_ptr,a,o,t,n,r,s,c)}updateFile(e,t){let n=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),r=F;return j.wasmtonkcore_updateFile(this.__wbg_ptr,n,r,t)}getMetadata(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmtonkcore_getMetadata(this.__wbg_ptr,t,n)}isConnected(){return j.wasmtonkcore_isConnected(this.__wbg_ptr)}static withPeerId(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmtonkcore_withPeerId(t,n)}forkToBytes(e){return j.wasmtonkcore_forkToBytes(this.__wbg_ptr,e)}listDirectory(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmtonkcore_listDirectory(this.__wbg_ptr,t,n)}watchDocument(e,t){let n=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),r=F;return j.wasmtonkcore_watchDocument(this.__wbg_ptr,n,r,t)}watchDirectory(e,t){let n=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),r=F;return j.wasmtonkcore_watchDirectory(this.__wbg_ptr,n,r,t)}createDirectory(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmtonkcore_createDirectory(this.__wbg_ptr,t,n)}connectWebsocket(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmtonkcore_connectWebsocket(this.__wbg_ptr,t,n)}setFileWithBytes(e,t,n){let r=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),i=F,a=je(n,j.__wbindgen_malloc),o=F;return j.wasmtonkcore_setFileWithBytes(this.__wbg_ptr,r,i,t,a,o)}getConnectionState(){return j.wasmtonkcore_getConnectionState(this.__wbg_ptr)}createFileWithBytes(e,t,n){let r=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),i=F,a=je(n,j.__wbindgen_malloc),o=F;return j.wasmtonkcore_createFileWithBytes(this.__wbg_ptr,r,i,t,a,o)}constructor(){return j.wasmtonkcore_new()}exists(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmtonkcore_exists(this.__wbg_ptr,t,n)}rename(e,t){let n=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),r=F,i=w(t,j.__wbindgen_malloc,j.__wbindgen_realloc),a=F;return j.wasmtonkcore_rename(this.__wbg_ptr,n,r,i,a)}setFile(e,t){let n=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),r=F;return j.wasmtonkcore_setFile(this.__wbg_ptr,n,r,t)}toBytes(e){return j.wasmtonkcore_toBytes(this.__wbg_ptr,e)}readFile(e){let t=w(e,j.__wbindgen_malloc,j.__wbindgen_realloc),n=F;return j.wasmtonkcore_readFile(this.__wbg_ptr,t,n)}},_t=typeof FinalizationRegistry>`u`?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>j.__wbg_wasmwebsockethandle_free(e>>>0,1)),vt=class e{static __wrap(t){t>>>=0;let n=Object.create(e.prototype);return n.__wbg_ptr=t,_t.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,_t.unregister(this),e}free(){let e=this.__destroy_into_raw();j.__wbg_wasmwebsockethandle_free(e,0)}waitForDisconnect(){return j.wasmwebsockethandle_waitForDisconnect(this.__wbg_ptr)}close(){j.wasmwebsockethandle_close(this.__wbg_ptr)}},yt=new Set([`basic`,`cors`,`default`]),z=$e})),bt=function(e,t,n,r,i){if(r===`m`)throw TypeError(`Private method is not writable`);if(r===`a`&&!i)throw TypeError(`Private accessor was defined without a setter`);if(typeof t==`function`?e!==t||!i:!t.has(e))throw TypeError(`Cannot write private member to an object whose class did not declare it`);return r===`a`?i.call(e,n):i?i.value=n:t.set(e,n),n},V=function(e,t,n,r){if(n===`a`&&!r)throw TypeError(`Private accessor was defined without a getter`);if(typeof t==`function`?e!==t||!r:!t.has(e))throw TypeError(`Cannot read private member from an object whose class did not declare it`);return n===`m`?r:n===`a`?r.call(e):r?r.value:t.get(e)},H,U,W=class extends Error{constructor(e,t){super(e),this.code=t,this.name=`TonkError`}},xt=class extends W{constructor(e){super(e,`CONNECTION_ERROR`),this.name=`ConnectionError`}},G=class extends W{constructor(e){super(e,`FILESYSTEM_ERROR`),this.name=`FileSystemError`}},K=class extends W{constructor(e){super(e,`BUNDLE_ERROR`),this.name=`BundleError`}},q=class e{constructor(e){H.set(this,void 0),bt(this,H,e,`f`)}static async fromBytes(t,n){try{let{create_bundle_from_bytes:r}=n||await b(()=>Promise.resolve().then(()=>(B(),x)),void 0);return new e(r(t))}catch(e){throw new K(`Failed to create bundle from bytes: ${e}`)}}async getRootId(){try{return await V(this,H,`f`).getRootId()}catch(e){throw new K(`Failed to get root ID: ${e}`)}}async get(e){try{let t=await V(this,H,`f`).get(e);return t===null?null:t}catch(t){throw new K(`Failed to get key ${e}: ${t}`)}}async getPrefix(e){try{return(await V(this,H,`f`).getPrefix(e)).map(e=>({key:e.key,value:e.value}))}catch(t){throw new K(`Failed to get prefix ${e}: ${t}`)}}async listKeys(){try{return await V(this,H,`f`).listKeys()}catch(e){throw new K(`Failed to list keys: ${e}`)}}async getManifest(){try{return await V(this,H,`f`).getManifest()}catch(e){throw new K(`Failed to retrieve manifest: ${e}`)}}async setManifest(e){try{await V(this,H,`f`).setManifest(e)}catch(e){throw new K(`Failed to set manifest: ${e}`)}}async toBytes(){try{return await V(this,H,`f`).toBytes()}catch(e){throw new K(`Failed to serialize bundle: ${e}`)}}free(){V(this,H,`f`).free()}};H=new WeakMap;var J=class e{constructor(e){U.set(this,void 0),bt(this,U,e,`f`)}static async create(t,n){let r=n||await b(()=>Promise.resolve().then(()=>(B(),x)),void 0);if(t?.peerId&&t?.storage){let{create_tonk_with_config:n}=r,i=await n(t.peerId,t.storage.type===`indexeddb`);return new e(i)}else if(t?.peerId){let{create_tonk_with_peer_id:n}=r,i=await n(t.peerId);return new e(i)}else if(t?.storage){let{create_tonk_with_storage:n}=r,i=await n(t.storage.type===`indexeddb`);return new e(i)}else{let{create_tonk:t}=r,n=await t();return new e(n)}}static async createWithPeerId(t,n){let{create_tonk_with_peer_id:r}=n||await b(()=>Promise.resolve().then(()=>(B(),x)),void 0),i=await r(t);return new e(i)}static async fromBundle(t,n,r){let i=r||await b(()=>Promise.resolve().then(()=>(B(),x)),void 0);if(n?.storage){let{create_tonk_from_bundle_with_storage:r}=i,a=await r(t,n.storage.type===`indexeddb`);return new e(a)}else{let{create_tonk_from_bundle:n}=i,r=await n(t);return new e(r)}}static async fromBytes(t,n,r){let i=r||await b(()=>Promise.resolve().then(()=>(B(),x)),void 0);if(n?.storage){let{create_tonk_from_bytes_with_storage:r}=i,a=await r(t,n.storage.type===`indexeddb`);return new e(a)}else{let{create_tonk_from_bytes:n}=i,r=await n(t);return new e(r)}}getPeerId(){return V(this,U,`f`).getPeerId()}async connectWebsocket(e){try{await V(this,U,`f`).connectWebsocket(e)}catch(t){throw new xt(`Failed to connect to ${e}: ${t}`)}}async isConnected(){try{return await V(this,U,`f`).isConnected()}catch(e){return console.error(`ðŸ”Œ [CORE-JS] isConnected() error:`,e),!1}}async getConnectionState(){try{return await V(this,U,`f`).getConnectionState()}catch(e){return console.error(`ðŸ“¡ [CORE-JS] getConnectionState() error:`,e),`failed:`+String(e)}}async forkToBytes(e){try{return await V(this,U,`f`).forkToBytes(e)}catch(e){throw new W(`Failed to serialize to bundle data: ${e}`)}}async toBytes(e){try{return await V(this,U,`f`).toBytes(e)}catch(e){throw new W(`Failed to serialize to bundle data: ${e}`)}}async createFile(e,t){try{await V(this,U,`f`).createFile(e,t)}catch(t){throw new G(`Failed to create file at ${e}: ${t}`)}}async createFileWithBytes(e,t,n){try{let r=typeof n==`string`?St(n):n;await V(this,U,`f`).createFileWithBytes(e,t,r)}catch(t){throw new G(`Failed to create file at ${e}: ${t}`)}}async readFile(e){try{let t=await V(this,U,`f`).readFile(e);if(t===null)throw new G(`File not found: ${e}`);let n;return t.bytes&&(n=Ct(t.bytes)),{...t,content:typeof t.content==`string`?JSON.parse(t.content):t.content,bytes:n}}catch(t){throw t instanceof G?t:new G(`Failed to read file at ${e}: ${t}`)}}async setFile(e,t){try{return await V(this,U,`f`).setFile(e,t)}catch(t){throw new G(`Failed to set file at ${e}: ${t}`)}}async setFileWithBytes(e,t,n){try{let r=typeof n==`string`?St(n):n;return await V(this,U,`f`).setFileWithBytes(e,t,r)}catch(t){throw new G(`Failed to set file at ${e}: ${t}`)}}async updateFile(e,t){try{return await V(this,U,`f`).updateFile(e,t)}catch(t){throw new G(`Failed to update file at ${e}: ${t}`)}}async patchFile(e,t,n){try{return await V(this,U,`f`).patchFile(e,t,n)}catch(t){throw new G(`Failed to patch file at ${e}: ${t}`)}}async spliceText(e,t,n,r,i){try{return await V(this,U,`f`).spliceText(e,t,n,r,i)}catch(t){throw new G(`Failed to splice text at ${e}: ${t}`)}}async deleteFile(e){try{return await V(this,U,`f`).deleteFile(e)}catch(t){throw new G(`Failed to delete file at ${e}: ${t}`)}}async createDirectory(e){try{await V(this,U,`f`).createDirectory(e)}catch(t){throw new G(`Failed to create directory at ${e}: ${t}`)}}async listDirectory(e){try{return(await V(this,U,`f`).listDirectory(e)).map(e=>({name:e.name,type:e.type,timestamps:e.timestamps,pointer:e.pointer}))}catch(t){throw new G(`Failed to list directory at ${e}: ${t}`)}}async exists(e){try{return await V(this,U,`f`).exists(e)}catch(t){throw new G(`Failed to check existence of ${e}: ${t}`)}}async rename(e,t){try{return await V(this,U,`f`).rename(e,t)}catch(n){throw new G(`Failed to rename ${e} to ${t}: ${n}`)}}async getMetadata(e){try{let t=await V(this,U,`f`).getMetadata(e);if(t===null)throw new G(`File or directory not found: ${e}`);return t}catch(t){throw t instanceof G?t:new G(`Failed to get metadata for ${e}: ${t}`)}}async watchFile(e,t){try{let n=await V(this,U,`f`).watchDocument(e,e=>{let n;e.bytes&&(n=Ct(e.bytes)),t({...e,content:typeof e.content==`string`?JSON.parse(e.content):e.content,bytes:n})});if(n===null)throw new G(`File not found: ${e}`);return n}catch(t){throw t instanceof G?t:new G(`Failed to watch file at path ${e}: ${t}`)}}async watchDirectory(e,t){try{let n=await V(this,U,`f`).watchDirectory(e,t);if(n===null)throw new G(`Directory not found: ${e}`);return n}catch(t){throw t instanceof G?t:new G(`Failed to watch directory at path ${e}: ${t}`)}}free(){V(this,U,`f`).free()}};U=new WeakMap;var St=e=>{let t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n},Ct=e=>{if(typeof e==`string`)return e;if(Array.isArray(e)){let t=8192,n=``;for(let r=0;r<e.length;r+=t){let i=e.slice(r,r+t);n+=String.fromCharCode(...i)}return btoa(n)}else throw new G(`Unrecognized bytes type in readFile ${typeof e}`)};B();var wt=!1,Y=null;async function Tt(e){if(!wt)return Y||(Y=(async()=>{try{e?.wasmPath?await z({module_or_path:e.wasmPath}):await z(),wt=!0}catch(e){throw Y=null,e}})(),Y)}async function Et(){let e=g();if(!e)return!1;try{return await e.tonk.isConnected()}catch(e){return u.error(`performHealthCheck() failed`,{error:e instanceof Error?e.message:String(e)}),!1}}async function Dt(){let e=g();if(!e){u.error(`Cannot reconnect: no active bundle`);return}let t=e.wsUrl;if(!t){u.error(`Cannot reconnect: wsUrl not stored`);return}let n=me();n>=10&&he(),u.debug(`Attempting to reconnect`,{attempt:n,maxAttempts:10,wsUrl:t}),await y({type:`reconnecting`,attempt:n});try{if(await e.tonk.connectWebsocket(t),await new Promise(e=>setTimeout(e,1e3)),await e.tonk.isConnected())pe(!0),he(),u.info(`Reconnection successful`),await y({type:`reconnected`}),await Ot();else throw Error(`Connection check failed after reconnect attempt`)}catch(e){u.warn(`Reconnection failed`,{error:e instanceof Error?e.message:String(e),attempt:n});let t=Math.min(1e3*2**(n-1),3e4);u.debug(`Scheduling next reconnect attempt`,{delayMs:t,nextAttempt:n+1}),setTimeout(Dt,t)}}async function Ot(){let e=be();u.debug(`Re-establishing watchers after reconnection`,{watcherCount:e.length}),u.debug(`Watcher re-establishment complete`,{watcherCount:e.length}),await y({type:`watchersReestablished`,count:e.length})}function X(){let e=g();if(!e){u.warn(`Cannot start health monitoring: no active bundle`);return}e.healthCheckInterval&&clearInterval(e.healthCheckInterval),u.debug(`Starting health monitoring`,{intervalMs:r});let t=setInterval(async()=>{let e=await Et(),n=g();if(!n){clearInterval(t);return}!e&&n.connectionHealthy?(pe(!1),u.warn(`Connection lost, starting reconnection attempts`),await y({type:`disconnected`}),Dt()):e&&!n.connectionHealthy&&(pe(!0),he(),u.debug(`Connection health restored`))},r);ge(t)}var Z=null,kt=!1;async function Q(){if(kt){u.debug(`WASM already initialized`);return}return Z?(u.debug(`WASM initialization in progress, waiting...`),Z):(u.debug(`Starting WASM initialization`),Z=(async()=>{try{let e=`/tonk_core_bg.wasm?t=${Date.now()}`;await Tt({wasmPath:e}),kt=!0,u.info(`WASM initialization completed`)}catch(e){throw Z=null,kt=!1,u.error(`WASM initialization failed`,{error:e instanceof Error?e.message:String(e)}),e}})(),Z)}async function $(e){return u.debug(`Waiting for PathIndex to sync from remote...`),new Promise(t=>{let n=!1,r=null,i=setTimeout(()=>{if(r)try{r.stop()}catch(e){u.warn(`Error stopping PathIndex watcher on timeout`,{error:e instanceof Error?e.message:String(e)})}n||(u.debug(`No PathIndex changes detected after 1s - proceeding`),t())},1e3);e.watchDirectory(`/`,e=>{if(!n){if(n=!0,u.debug(`PathIndex synced from remote`,{documentType:e.type}),clearTimeout(i),r)try{r.stop()}catch(e){u.warn(`Error stopping PathIndex watcher after sync`,{error:e instanceof Error?e.message:String(e)})}t()}}).then(e=>{r=e,u.debug(`PathIndex watcher established`,{watcherId:e?.document_id||`unknown`})}).catch(e=>{u.error(`Failed to establish PathIndex watcher`,{error:e.message}),clearTimeout(i),t()})})}async function At(){try{let e=await ie(),t=await ae(),n=await oe();if(!e||!t){u.debug(`No cached state found, waiting for initialization message`,{hasSlug:!!e,hasBundle:!!t});return}u.info(`Auto-initializing from cache`,{slug:e,bundleSize:t.length}),await Q();let r=await(await q.fromBytes(t)).getManifest();u.debug(`Bundle and manifest restored from cache`,{rootId:r.rootId});let i=await J.fromBytes(t,{storage:{type:`indexeddb`}});u.debug(`TonkCore created from cached bundle`);let a=n||`${`http://localhost:8081`.replace(/^http/,`ws`)}`;!n&&a&&await p(a),u.debug(`Connecting to websocket...`,{wsUrl:a,localRootId:r.rootId}),await i.connectWebsocket(a),u.debug(`Websocket connected`),await $(i),u.info(`Auto-initialization complete`),v({status:`active`,bundleId:r.rootId,tonk:i,manifest:r,appSlug:e,wsUrl:a,healthCheckInterval:null,watchers:new Map,connectionHealthy:!0,reconnectAttempts:0}),X()}catch(e){u.error(`Auto-initialization failed`,{error:e instanceof Error?e.message:String(e)}),v({status:`idle`}),await se(),(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:`needsReinit`,appSlug:null,reason:`Auto-initialization failed`})})}}async function jt(e,t,n,r){u.debug(`Loading new bundle`,{byteLength:e.length,serverUrl:t,hasCachedManifest:!!r});try{let n=h();await Q();let i;if(r)u.info(`Using cached manifest, skipping Bundle.fromBytes`,{rootId:r.rootId}),i=r;else{u.debug(`No cached manifest, parsing bundle`,{byteLength:e.length});let t=await q.fromBytes(e);i=await t.getManifest(),t.free(),u.debug(`Bundle manifest extracted`,{rootId:i.rootId})}if(n.status===`active`&&n.manifest.rootId===i.rootId)return u.debug(`Bundle already loaded with same rootId, skipping reload`,{rootId:i.rootId}),{success:!0,skipped:!0};u.debug(`Creating new TonkCore from bundle bytes`);let a=await J.fromBytes(e,{storage:{type:`indexeddb`}});u.debug(`New TonkCore created successfully`,{rootId:i.rootId});let o=new URLSearchParams(self.location.search).get(`bundle`),s=`${t.replace(/^http/,`ws`)}`;if(o)try{let e=atob(o),t=JSON.parse(e);t.wsUrl&&(s=t.wsUrl)}catch(e){u.warn(`Could not parse bundle config for wsUrl`,{error:e instanceof Error?e.message:String(e)})}u.debug(`Determined websocket URL`,{wsUrl:s,serverUrl:t}),await p(s),u.debug(`Connecting new tonk to websocket`,{wsUrl:s,localRootId:i.rootId}),s&&(await a.connectWebsocket(s),u.debug(`Websocket connection established`),await $(a),u.debug(`PathIndex sync complete after loadBundle`));let c=h(),l=c.status===`active`?c.appSlug:i.entrypoints?.[0]||`app`;return v({status:`active`,bundleId:i.rootId,tonk:a,manifest:i,appSlug:l,wsUrl:s,healthCheckInterval:null,watchers:new Map,connectionHealthy:!0,reconnectAttempts:0}),X(),await f(e),u.debug(`Bundle bytes persisted to cache`),u.info(`Bundle loaded successfully`,{rootId:i.rootId}),{success:!0}}catch(e){return u.error(`Failed to load bundle`,{error:e instanceof Error?e.message:String(e)}),v({status:`error`,error:e instanceof Error?e:Error(String(e))}),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function Mt(e){u.debug(`Loading new bundle`,{byteLength:e.bundleBytes.byteLength,serverUrl:e.serverUrl,hasCachedManifest:!!e.manifest});let t=e.serverUrl||`http://localhost:8081`,n=new Uint8Array(e.bundleBytes),r=await jt(n,t,e.id,e.manifest);y({type:`loadBundle`,id:e.id,success:r.success,skipped:r.skipped,error:r.error})}async function Nt(e){u.debug(`Converting tonk to bytes`);try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.toBytes(),r=t.manifest.rootId;u.debug(`Tonk converted to bytes`,{byteLength:n.length,rootId:r}),y({type:`toBytes`,id:e.id,success:!0,data:n,rootId:r})}catch(t){u.error(`Failed to convert tonk to bytes`,{error:t instanceof Error?t.message:String(t)}),y({type:`toBytes`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Pt(e){u.debug(`Forking tonk to bytes`);try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.forkToBytes(),r=(await(await q.fromBytes(n)).getManifest()).rootId;u.debug(`Tonk forked to bytes`,{byteLength:n.length,rootId:r}),y({type:`forkToBytes`,id:e.id,success:!0,data:n,rootId:r})}catch(t){u.error(`Failed to fork tonk to bytes`,{error:t instanceof Error?t.message:String(t)}),y({type:`forkToBytes`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Ft(e){u.debug(`Listing directory`,{path:e.path});try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.listDirectory(e.path);u.debug(`Directory listed`,{path:e.path,fileCount:Array.isArray(n)?n.length:`unknown`}),y({type:`listDirectory`,id:e.id,success:!0,data:n})}catch(t){u.error(`Failed to list directory`,{path:e.path,error:t instanceof Error?t.message:String(t)}),y({type:`listDirectory`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function It(e){u.debug(`Reading file`,{path:e.path});try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.readFile(e.path);u.debug(`File read successfully`,{path:e.path}),y({type:`readFile`,id:e.id,success:!0,data:n})}catch(t){u.error(`Failed to read file`,{path:e.path,error:t instanceof Error?t.message:String(t)}),y({type:`readFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Lt(e){u.debug(`Writing file`,{path:e.path,create:e.create,hasBytes:!!e.content.bytes});try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=e.content.content;e.create?(u.debug(`Creating new file`,{path:e.path}),e.content.bytes?await t.tonk.createFileWithBytes(e.path,n,e.content.bytes):await t.tonk.createFile(e.path,n)):(u.debug(`Setting existing file`,{path:e.path}),e.content.bytes?await t.tonk.setFileWithBytes(e.path,n,e.content.bytes):await t.tonk.setFile(e.path,n)),u.debug(`File write completed`,{path:e.path}),y({type:`writeFile`,id:e.id,success:!0})}catch(t){u.error(`Failed to write file`,{path:e.path,create:e.create,error:t instanceof Error?t.message:String(t)}),y({type:`writeFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Rt(e){u.debug(`Deleting file`,{path:e.path});try{let t=_();if(!t)throw Error(`Tonk not initialized`);await t.tonk.deleteFile(e.path),u.debug(`File deleted successfully`,{path:e.path}),y({type:`deleteFile`,id:e.id,success:!0})}catch(t){u.error(`Failed to delete file`,{path:e.path,error:t instanceof Error?t.message:String(t)}),y({type:`deleteFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function zt(e){u.debug(`Renaming file or directory`,{oldPath:e.oldPath,newPath:e.newPath});try{let t=_();if(!t)throw Error(`Tonk not initialized`);await t.tonk.rename(e.oldPath,e.newPath),u.debug(`Rename completed`,{oldPath:e.oldPath,newPath:e.newPath}),y({type:`rename`,id:e.id,success:!0})}catch(t){u.error(`Failed to rename`,{oldPath:e.oldPath,newPath:e.newPath,error:t instanceof Error?t.message:String(t)}),y({type:`rename`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Bt(e){u.debug(`Checking file existence`,{path:e.path});try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.exists(e.path);u.debug(`File existence check completed`,{path:e.path,exists:n}),y({type:`exists`,id:e.id,success:!0,data:n})}catch(t){u.error(`Failed to check file existence`,{path:e.path,error:t instanceof Error?t.message:String(t)}),y({type:`exists`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Vt(e){u.debug(`Updating file with smart diff`,{path:e.path});try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=e.content,r=await t.tonk.updateFile(e.path,n);u.debug(`File update completed`,{path:e.path,changed:r}),y({type:`updateFile`,id:e.id,success:!0,data:r})}catch(t){u.error(`Failed to update file`,{path:e.path,error:t instanceof Error?t.message:String(t)}),y({type:`updateFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Ht(e){u.debug(`Patching file`,{path:e.path,jsonPath:e.jsonPath});try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=e.value,r=await t.tonk.patchFile(e.path,e.jsonPath,n);u.debug(`File patch completed`,{path:e.path,result:r}),y({type:`patchFile`,id:e.id,success:!0,data:r})}catch(t){u.error(`Failed to patch file`,{path:e.path,error:t instanceof Error?t.message:String(t)}),y({type:`patchFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Ut(e){u.debug(`Handling VFS init message`,{manifestSize:e.manifest.byteLength,wsUrl:e.wsUrl});try{let e=h();if(e.status===`active`){u.debug(`Tonk already initialized`),y({type:`init`,success:!0});return}if(e.status===`loading`){u.debug(`Tonk is loading, waiting for completion`);try{await e.promise,u.debug(`Tonk loading completed`),y({type:`init`,success:!0})}catch(e){u.error(`Tonk loading failed`,{error:e instanceof Error?e.message:String(e)}),y({type:`init`,success:!1,error:e instanceof Error?e.message:String(e)})}return}if(e.status===`error`){u.error(`Tonk initialization failed previously`,{error:e.error.message}),y({type:`init`,success:!1,error:e.error.message});return}u.warn(`Tonk is uninitialized, this is unexpected`),y({type:`init`,success:!1,error:`Tonk not initialized`})}catch(e){u.error(`Failed to handle init message`,{error:e instanceof Error?e.message:String(e)}),y({type:`init`,success:!1,error:e instanceof Error?e.message:String(e)})}}async function Wt(e){u.debug(`Initializing from URL`,{manifestUrl:e.manifestUrl,wasmUrl:e.wasmUrl});try{let t=e.manifestUrl||`http://localhost:8081/.manifest.tonk`,n=e.wsUrl||`http://localhost:8081`.replace(/^http/,`ws`);await Q(),u.debug(`Fetching manifest from URL`,{manifestUrl:t});let r=await fetch(t),i=new Uint8Array(await r.arrayBuffer());u.debug(`Manifest bytes loaded`,{byteLength:i.length});let a=await(await q.fromBytes(i)).getManifest();u.debug(`Bundle and manifest created`),u.debug(`Creating TonkCore from manifest bytes`);let o=await J.fromBytes(i,{storage:{type:`indexeddb`}});u.debug(`TonkCore created`),await p(n),u.debug(`Connecting to websocket`,{wsUrl:n}),await o.connectWebsocket(n),u.debug(`Websocket connection established`),await $(o),u.debug(`PathIndex sync complete`),v({status:`active`,bundleId:a.rootId,tonk:o,manifest:a,appSlug:a.entrypoints?.[0]||`app`,wsUrl:n,healthCheckInterval:null,watchers:new Map,connectionHealthy:!0,reconnectAttempts:0}),X(),await f(i),u.debug(`Bundle bytes persisted`),u.info(`Initialized from URL successfully`),y({type:`initializeFromUrl`,id:e.id,success:!0})}catch(t){u.error(`Failed to initialize from URL`,{error:t instanceof Error?t.message:String(t)}),v({status:`error`,error:t instanceof Error?t:Error(String(t))}),y({type:`initializeFromUrl`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Gt(e){u.debug(`Initializing from bytes`,{byteLength:e.bundleBytes.byteLength,serverUrl:e.serverUrl});try{let t=e.serverUrl||`http://localhost:8081`,n=e.wsUrl||t.replace(/^http/,`ws`);u.debug(`Using server URL`,{serverUrl:t}),await Q();let r=new Uint8Array(e.bundleBytes);u.debug(`Creating bundle from bytes`,{byteLength:r.length});let i=await(await q.fromBytes(r)).getManifest();u.debug(`Bundle and manifest created`,{rootId:i.rootId}),u.debug(`Creating TonkCore from bundle bytes`);let a=await J.fromBytes(r,{storage:{type:`indexeddb`}});u.debug(`TonkCore created`),u.debug(`Connecting to websocket`,{wsUrl:n}),n&&(await a.connectWebsocket(n),u.debug(`Websocket connection established`),await $(a),u.debug(`PathIndex sync complete`)),v({status:`active`,bundleId:i.rootId,tonk:a,manifest:i,appSlug:i.entrypoints?.[0]||`app`,wsUrl:n,healthCheckInterval:null,watchers:new Map,connectionHealthy:!0,reconnectAttempts:0}),X(),await f(r),u.debug(`Bundle bytes persisted`),u.info(`Initialized from bytes successfully`),y({type:`initializeFromBytes`,id:e.id,success:!0})}catch(t){u.error(`Failed to initialize from bytes`,{error:t instanceof Error?t.message:String(t)}),v({status:`error`,error:t instanceof Error?t:Error(String(t))}),y({type:`initializeFromBytes`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Kt(e){u.debug(`Getting server URL`),y({type:`getServerUrl`,id:e.id,success:!0,data:`http://localhost:8081`})}async function qt(e){u.debug(`Getting manifest`);try{let t=_();if(!t)throw Error(`Tonk not initialized`);y({type:`getManifest`,id:e.id,success:!0,data:t.manifest})}catch(t){u.error(`Failed to get manifest`,{error:t instanceof Error?t.message:String(t)}),y({type:`getManifest`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Jt(){let e=h();u.debug(`Ping received`),y({type:`ready`,status:e.status,needsBundle:e.status!==`active`})}async function Yt(e){h().status===`active`&&fe(e.slug),await re(e.slug),u.debug(`App slug set and persisted`,{slug:e.slug})}async function Xt(e){u.debug(`Starting file watch`,{path:e.path,watchId:e.id});try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.watchFile(e.path,t=>{u.debug(`File change detected`,{watchId:e.id,path:e.path}),y({type:`fileChanged`,watchId:e.id,documentData:t})});n&&_e(e.id,n),u.debug(`File watch started`,{path:e.path,watchId:e.id}),y({type:`watchFile`,id:e.id,success:!0})}catch(t){u.error(`Failed to start file watch`,{path:e.path,error:t instanceof Error?t.message:String(t)}),y({type:`watchFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Zt(e){u.debug(`Stopping file watch`,{watchId:e.id});try{ye(e.id)?(u.debug(`Found watcher, stopping it`,{watchId:e.id}),ve(e.id),u.debug(`File watch stopped`,{watchId:e.id})):u.debug(`No watcher found for ID`,{watchId:e.id}),y({type:`unwatchFile`,id:e.id,success:!0})}catch(t){u.error(`Failed to stop file watch`,{watchId:e.id,error:t instanceof Error?t.message:String(t)}),y({type:`unwatchFile`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Qt(e){u.debug(`Starting directory watch`,{path:e.path,watchId:e.id});try{let t=_();if(!t)throw Error(`Tonk not initialized`);let n=await t.tonk.watchDirectory(e.path,t=>{u.debug(`Directory change detected`,{watchId:e.id,path:e.path}),y({type:`directoryChanged`,watchId:e.id,path:e.path,changeData:t})});n&&_e(e.id,n),u.debug(`Directory watch started`,{path:e.path,watchId:e.id}),y({type:`watchDirectory`,id:e.id,success:!0})}catch(t){u.error(`Failed to start directory watch`,{path:e.path,error:t instanceof Error?t.message:String(t)}),y({type:`watchDirectory`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}async function $t(e){u.debug(`Stopping directory watch`,{watchId:e.id});try{ye(e.id)?(u.debug(`Found directory watcher, stopping it`,{watchId:e.id}),ve(e.id),u.debug(`Directory watch stopped`,{watchId:e.id})):u.debug(`No directory watcher found for ID`,{watchId:e.id}),y({type:`unwatchDirectory`,id:e.id,success:!0})}catch(t){u.error(`Failed to stop directory watch`,{watchId:e.id,error:t instanceof Error?t.message:String(t)}),y({type:`unwatchDirectory`,id:e.id,success:!1,error:t instanceof Error?t.message:String(t)})}}var en=[`init`,`loadBundle`,`initializeFromUrl`,`initializeFromBytes`,`getServerUrl`,`ping`,`setAppSlug`];async function tn(e){let t=e.type,n=e.id;u.debug(`Received message`,{type:t,id:n||`N/A`});let r=h();if(t===`setAppSlug`){await Yt({slug:e.slug});return}if(t===`ping`){await Jt();return}if(r.status!==`active`&&!en.includes(t)){u.warn(`Operation attempted before VFS initialization`,{type:t,status:r.status}),n&&y({type:t,id:n,success:!1,error:`VFS not initialized. Please load a bundle first.`});return}switch(t){case`init`:await Ut({...n!==void 0&&{id:n},manifest:e.manifest,...e.wsUrl!==void 0&&{wsUrl:e.wsUrl}});break;case`initializeFromUrl`:await Wt({...n!==void 0&&{id:n},...e.manifestUrl!==void 0&&{manifestUrl:e.manifestUrl},...e.wasmUrl!==void 0&&{wasmUrl:e.wasmUrl},...e.wsUrl!==void 0&&{wsUrl:e.wsUrl}});break;case`initializeFromBytes`:await Gt({...n!==void 0&&{id:n},bundleBytes:e.bundleBytes,...e.serverUrl!==void 0&&{serverUrl:e.serverUrl},...e.wsUrl!==void 0&&{wsUrl:e.wsUrl}});break;case`getServerUrl`:await Kt({id:n});break;case`getManifest`:await qt({id:n});break;case`loadBundle`:await Mt({...n!==void 0&&{id:n},bundleBytes:e.bundleBytes,...e.serverUrl!==void 0&&{serverUrl:e.serverUrl},...e.manifest!==void 0&&{manifest:e.manifest}});break;case`toBytes`:await Nt({id:n});break;case`forkToBytes`:await Pt({id:n});break;case`readFile`:await It({id:n,path:e.path});break;case`writeFile`:await Lt({id:n,path:e.path,...e.create!==void 0&&{create:e.create},content:e.content});break;case`deleteFile`:await Rt({id:n,path:e.path});break;case`rename`:await zt({id:n,oldPath:e.oldPath,newPath:e.newPath});break;case`exists`:await Bt({id:n,path:e.path});break;case`patchFile`:await Ht({id:n,path:e.path,jsonPath:e.jsonPath,value:e.value});break;case`updateFile`:await Vt({id:n,path:e.path,content:e.content});break;case`listDirectory`:await Ft({id:n,path:e.path});break;case`watchFile`:await Xt({id:n,path:e.path});break;case`unwatchFile`:await Zt({id:n});break;case`watchDirectory`:await Qt({id:n,path:e.path});break;case`unwatchDirectory`:await $t({id:n});break;default:u.warn(`Unknown message type`,{type:t}),n&&y({type:t,id:n,success:!1,error:`Unknown message type: ${t}`})}}var nn=self;u.info(`Service worker starting`,{version:`mj1hy086`,buildTime:`2025-12-11T13:51:20.741Z`,location:self.location.href}),u.debug(`Checking for cached state`),ue(At()),self.addEventListener(`install`,e=>{u.info(`Service worker installing`),nn.skipWaiting(),u.debug(`skipWaiting called`)}),self.addEventListener(`activate`,e=>{u.info(`Service worker activating`),e.waitUntil((async()=>{await nn.clients.claim(),u.debug(`Clients claimed`);let e=await nn.clients.matchAll();e.forEach(e=>{e.postMessage({type:`ready`,needsBundle:!0})}),u.info(`Service worker activated`,{clientCount:e.length})})())}),self.addEventListener(`message`,async e=>{u.debug(`Message received`,{type:e.data?.type});try{await tn(e.data)}catch(e){u.error(`Error handling message`,{error:e instanceof Error?e.message:String(e)})}}),self.addEventListener(`fetch`,e=>{Ce(e)}),u.debug(`VFS Service Worker initialized`);