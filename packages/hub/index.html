<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Tonk Project Launcher</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #2c3e50;
      margin-top: 0;
    }

    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .status {
      margin: 20px 0;
      padding: 10px;
      border-radius: 4px;
    }

    .status.loading {
      background-color: #f0f8ff;
      border-left: 4px solid #1e90ff;
    }

    .status.ready {
      background-color: #f0fff0;
      border-left: 4px solid #4CAF50;
    }

    .status.error {
      background-color: #fff0f0;
      border-left: 4px solid #f44336;
    }

    .log-container {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Tonk Project Launcher</h1>

    <div>
      <button id="selectProjectBtn">Select Project Directory</button>
      <div id="projectPath"></div>
    </div>

    <div>
      <label for="docIdInput">Document ID (optional):</label>
      <input type="text" id="docIdInput" placeholder="Enter document ID">
    </div>

    <div>
      <button id="launchBtn" disabled>Launch Tonk App</button>
    </div>

    <div id="statusContainer" class="status" style="display: none;"></div>

    <div class="log-container" id="logContainer"></div>
  </div>

  <script>
    // DOM elements
    const selectProjectBtn = document.getElementById('selectProjectBtn');
    const projectPathDiv = document.getElementById('projectPath');
    const docIdInput = document.getElementById('docIdInput');
    const launchBtn = document.getElementById('launchBtn');
    const statusContainer = document.getElementById('statusContainer');
    const logContainer = document.getElementById('logContainer');

    // State
    let selectedProjectPath = '';

    // Event listeners
    selectProjectBtn.addEventListener('click', async () => {
      try {
        const result = await window.electronAPI.selectProject();
        if (result.success) {
          selectedProjectPath = result.path;
          projectPathDiv.textContent = `Selected: ${selectedProjectPath}`;
          launchBtn.disabled = false;
        } else {
          projectPathDiv.textContent = result.message;
        }
      } catch (error) {
        console.error('Error selecting project:', error);
        projectPathDiv.textContent = `Error selecting project: ${error.message}`;
      }
    });

    launchBtn.addEventListener('click', async () => {
      if (!selectedProjectPath) {
        alert('Please select a project directory first');
        return;
      }

      const docId = docIdInput.value.trim();

      try {
        await window.electronAPI.launchApp(selectedProjectPath, docId);
        // The status will be updated via the app-status event
      } catch (error) {
        console.error('Error launching app:', error);
        updateStatus('error', `Error launching app: ${error.message}`);
      }
    });

    // Listen for status updates from the main process
    window.electronAPI.onAppStatus((data) => {
      updateStatus(data.status, data.message, data.url);
    });

    // Listen for server logs from the main process
    window.electronAPI.onServerLog((data) => {
      appendLog(data);
    });

    // Helper functions
    function updateStatus(status, message, url) {
      statusContainer.style.display = 'block';
      statusContainer.className = `status ${status}`;
      statusContainer.textContent = message;

      if (status === 'ready' && url) {
        const link = document.createElement('a');
        link.href = '#';
        link.textContent = ` Open ${url}`;
        link.addEventListener('click', (e) => {
          e.preventDefault();
          // The main process will handle opening the app in a new window
        });
        statusContainer.appendChild(link);
      }
    }

    function appendLog(text) {
      const wasAtBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 1;

      logContainer.textContent += text;

      if (wasAtBottom) {
        logContainer.scrollTop = logContainer.scrollHeight;
      }
    }

    // Check if there's a current document ID
    async function checkCurrentDocId() {
      try {
        const currentDocId = await window.electronAPI.getCurrentDocId();
        if (currentDocId) {
          docIdInput.value = currentDocId;
        }
      } catch (error) {
        console.error('Error getting current document ID:', error);
      }
    }

    // Initialize
    checkCurrentDocId();
  </script>
</body>

</html>
