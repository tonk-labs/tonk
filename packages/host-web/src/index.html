<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Opening portal...</title>
    <script>
      async function handleRedirect() {
        // Debug bundle contents first
        console.log("Bundle is ready! Check the service worker console logs to see available directories.")

        // Now redirect to test our React app
        // To remove the need for an augmented url, trigger a fetch instruction to signify to the SW that the app index should be loaded
        console.log("Redirecting...")
        window.location.href = window.location.href
      }
      
      (async () => {
        if ("serviceWorker" in navigator) {
          // If we already have a controller, we can redirect immediately
          if (navigator.serviceWorker.controller) {
            console.log("Service worker is already controlling the page")
            await handleRedirect()
          } else {
            // Otherwise wait for a controller
            navigator.serviceWorker
              .register("./service-worker-bundled.js", { type: "module" })
              .catch((err) => {
                console.log("ServiceWorker registration failed: ", err)
                document.body.innerHTML = `<h1>Trail-Runner proxy failed to load.</h1>
                <p>If you're on Firefox, check this <a href="https://caniuse.com/mdn-api_serviceworker_ecmascript_modules">link</a> to see if support is available yet.</p>`
                handleRedirect()
              })
            console.log("Waiting for service worker to take control...")
            navigator.serviceWorker.addEventListener("controllerchange", async () => {
              console.log("Service worker now controlling the page")
              await handleRedirect()
            })
            try {await handleRedirect()}
            catch (error) {console.log(error)}

            await new Promise(resolve => setTimeout(resolve, 1000))
          }
        }
      })()
    </script>
  </head>
  <body>
    <h1>Trail-Runner: Booting...</h1>
    <p>Standby for control of service worker...</p>
  </body>
</html>
