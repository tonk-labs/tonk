const Ot="modulepreload",Mt=function(n){return"/"+n},wt={},j=function(t,e,r){let o=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),_=s?.nonce||s?.getAttribute("nonce");o=Promise.allSettled(e.map(w=>{if(w=Mt(w),w in wt)return;wt[w]=!0;const p=w.endsWith(".css"),E=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${w}"]${E}`))return;const F=document.createElement("link");if(F.rel=p?"stylesheet":Ot,p||(F.as="script"),F.crossOrigin="",F.href=w,_&&F.setAttribute("nonce",_),document.head.appendChild(F),p)return new Promise((M,$t)=>{F.addEventListener("load",M),F.addEventListener("error",()=>$t(new Error(`Unable to preload CSS for ${w}`)))})}))}function c(s){const _=new Event("vite:preloadError",{cancelable:!0});if(_.payload=s,window.dispatchEvent(_),!_.defaultPrevented)throw s}return o.then(s=>{for(const _ of s||[])_.status==="rejected"&&c(_.reason);return t().catch(c)})};var Ct=function(n,t,e,r,o){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!o)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?n!==t||!o:!t.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?o.call(n,e):o?o.value=e:t.set(n,e),e},b=function(n,t,e,r){if(e==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?n!==t||!r:!t.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?r:e==="a"?r.call(n):r?r.value:t.get(n)},x,y;class K extends Error{constructor(t,e){super(t),this.code=e,this.name="TonkError"}}class Lt extends K{constructor(t){super(t,"CONNECTION_ERROR"),this.name="ConnectionError"}}class m extends K{constructor(t){super(t,"FILESYSTEM_ERROR"),this.name="FileSystemError"}}class D extends K{constructor(t){super(t,"BUNDLE_ERROR"),this.name="BundleError"}}class ${constructor(t){x.set(this,void 0),Ct(this,x,t,"f")}static async fromBytes(t,e){try{const{create_bundle_from_bytes:r}=e||await j(()=>Promise.resolve().then(()=>V),void 0);return new $(r(t))}catch(r){throw new D(`Failed to create bundle from bytes: ${r}`)}}async getRootId(){try{return await b(this,x,"f").getRootId()}catch(t){throw new D(`Failed to get root ID: ${t}`)}}async get(t){try{const e=await b(this,x,"f").get(t);return e===null?null:e}catch(e){throw new D(`Failed to get key ${t}: ${e}`)}}async getPrefix(t){try{return(await b(this,x,"f").getPrefix(t)).map(r=>({key:r.key,value:r.value}))}catch(e){throw new D(`Failed to get prefix ${t}: ${e}`)}}async listKeys(){try{return await b(this,x,"f").listKeys()}catch(t){throw new D(`Failed to list keys: ${t}`)}}async getManifest(){try{return await b(this,x,"f").getManifest()}catch(t){throw new D(`Failed to retrieve manifest: ${t}`)}}async setManifest(t){try{await b(this,x,"f").setManifest(t)}catch(e){throw new D(`Failed to set manifest: ${e}`)}}async toBytes(){try{return await b(this,x,"f").toBytes()}catch(t){throw new D(`Failed to serialize bundle: ${t}`)}}free(){b(this,x,"f").free()}}x=new WeakMap;class T{constructor(t){y.set(this,void 0),Ct(this,y,t,"f")}static async create(t,e){const r=e||await j(()=>Promise.resolve().then(()=>V),void 0);if(t?.peerId&&t?.storage){const{create_tonk_with_config:o}=r,c=await o(t.peerId,t.storage.type==="indexeddb");return new T(c)}else if(t?.peerId){const{create_tonk_with_peer_id:o}=r,c=await o(t.peerId);return new T(c)}else if(t?.storage){const{create_tonk_with_storage:o}=r,c=await o(t.storage.type==="indexeddb");return new T(c)}else{const{create_tonk:o}=r,c=await o();return new T(c)}}static async createWithPeerId(t,e){const{create_tonk_with_peer_id:r}=e||await j(()=>Promise.resolve().then(()=>V),void 0),o=await r(t);return new T(o)}static async fromBundle(t,e,r){const o=r||await j(()=>Promise.resolve().then(()=>V),void 0);if(e?.storage){const{create_tonk_from_bundle_with_storage:c}=o,s=await c(t,e.storage.type==="indexeddb");return new T(s)}else{const{create_tonk_from_bundle:c}=o,s=await c(t);return new T(s)}}static async fromBytes(t,e,r){const o=r||await j(()=>Promise.resolve().then(()=>V),void 0);if(e?.storage){const{create_tonk_from_bytes_with_storage:c}=o,s=await c(t,e.storage.type==="indexeddb");return new T(s)}else{const{create_tonk_from_bytes:c}=o,s=await c(t);return new T(s)}}getPeerId(){return b(this,y,"f").getPeerId()}async connectWebsocket(t){try{await b(this,y,"f").connectWebsocket(t)}catch(e){throw new Lt(`Failed to connect to ${t}: ${e}`)}}async isConnected(){try{return await b(this,y,"f").isConnected()}catch(t){return console.error("ðŸ”Œ [CORE-JS] isConnected() error:",t),!1}}async getConnectionState(){try{return await b(this,y,"f").getConnectionState()}catch(t){return console.error("ðŸ“¡ [CORE-JS] getConnectionState() error:",t),"failed:"+String(t)}}async forkToBytes(t){try{return await b(this,y,"f").forkToBytes(t)}catch(e){throw new K(`Failed to serialize to bundle data: ${e}`)}}async toBytes(t){try{return await b(this,y,"f").toBytes(t)}catch(e){throw new K(`Failed to serialize to bundle data: ${e}`)}}async createFile(t,e){try{await b(this,y,"f").createFile(t,e)}catch(r){throw new m(`Failed to create file at ${t}: ${r}`)}}async createFileWithBytes(t,e,r){try{let o=typeof r=="string"?bt(r):r;await b(this,y,"f").createFileWithBytes(t,e,o)}catch(o){throw new m(`Failed to create file at ${t}: ${o}`)}}async readFile(t){try{const e=await b(this,y,"f").readFile(t);if(e===null)throw new m(`File not found: ${t}`);let r;return e.bytes&&(r=gt(e.bytes)),{...e,content:JSON.parse(e.content),bytes:r}}catch(e){throw e instanceof m?e:new m(`Failed to read file at ${t}: ${e}`)}}async updateFile(t,e){try{return await b(this,y,"f").updateFile(t,e)}catch(r){throw new m(`Failed to update file at ${t}: ${r}`)}}async updateFileWithBytes(t,e,r){try{let o=typeof r=="string"?bt(r):r;return await b(this,y,"f").updateFileWithBytes(t,e,o)}catch(o){throw new m(`Failed to update file at ${t}: ${o}`)}}async deleteFile(t){try{return await b(this,y,"f").deleteFile(t)}catch(e){throw new m(`Failed to delete file at ${t}: ${e}`)}}async createDirectory(t){try{await b(this,y,"f").createDirectory(t)}catch(e){throw new m(`Failed to create directory at ${t}: ${e}`)}}async listDirectory(t){try{return(await b(this,y,"f").listDirectory(t)).map(r=>({name:r.name,type:r.type,timestamps:r.timestamps,pointer:r.pointer}))}catch(e){throw new m(`Failed to list directory at ${t}: ${e}`)}}async exists(t){try{return await b(this,y,"f").exists(t)}catch(e){throw new m(`Failed to check existence of ${t}: ${e}`)}}async rename(t,e){try{return await b(this,y,"f").rename(t,e)}catch(r){throw new m(`Failed to rename ${t} to ${e}: ${r}`)}}async getMetadata(t){try{const e=await b(this,y,"f").getMetadata(t);if(e===null)throw new m(`File or directory not found: ${t}`);return e}catch(e){throw e instanceof m?e:new m(`Failed to get metadata for ${t}: ${e}`)}}async watchFile(t,e){try{const r=await b(this,y,"f").watchDocument(t,o=>{let c;o.bytes&&(c=gt(o.bytes)),e({...o,content:JSON.parse(o.content),bytes:c})});if(r===null)throw new m(`File not found: ${t}`);return r}catch(r){throw r instanceof m?r:new m(`Failed to watch file at path ${t}: ${r}`)}}async watchDirectory(t,e){try{const r=await b(this,y,"f").watchDirectory(t,e);if(r===null)throw new m(`Directory not found: ${t}`);return r}catch(r){throw r instanceof m?r:new m(`Failed to watch directory at path ${t}: ${r}`)}}free(){b(this,y,"f").free()}}y=new WeakMap;const bt=n=>{const t=atob(n),e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e},gt=n=>{if(typeof n=="string")return n;if(Array.isArray(n)){let e="";for(let r=0;r<n.length;r+=8192){const o=n.slice(r,r+8192);e+=String.fromCharCode(...o)}return btoa(e)}else throw new m(`Unrecognized bytes type in readFile ${typeof n}`)};let a,N=null;function O(){return(N===null||N.byteLength===0)&&(N=new Uint8Array(a.memory.buffer)),N}let H=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&H.decode();const jt=2146435072;let ct=0;function Nt(n,t){return ct+=t,ct>=jt&&(H=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}},H.decode(),ct=t),H.decode(O().subarray(n,n+t))}function h(n,t){return n=n>>>0,Nt(n,t)}let d=0;const G=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Vt=typeof G.encodeInto=="function"?function(n,t){return G.encodeInto(n,t)}:function(n,t){const e=G.encode(n);return t.set(e),{read:n.length,written:e.length}};function f(n,t,e){if(e===void 0){const _=G.encode(n),w=t(_.length,1)>>>0;return O().subarray(w,w+_.length).set(_),d=_.length,w}let r=n.length,o=t(r,1)>>>0;const c=O();let s=0;for(;s<r;s++){const _=n.charCodeAt(s);if(_>127)break;c[o+s]=_}if(s!==r){s!==0&&(n=n.slice(s)),o=e(o,r,r=s+n.length*3,1)>>>0;const _=O().subarray(o+s,o+r),w=Vt(n,_);s+=w.written,o=e(o,r,s,1)>>>0}return d=s,o}let z=null;function S(){return(z===null||z.buffer.detached===!0||z.buffer.detached===void 0&&z.buffer!==a.memory.buffer)&&(z=new DataView(a.memory.buffer)),z}function W(n){const t=a.__externref_table_alloc();return a.__wbindgen_export_4.set(t,n),t}function u(n,t){try{return n.apply(this,t)}catch(e){const r=W(e);a.__wbindgen_exn_store(r)}}function R(n){return n==null}function ht(n,t){return n=n>>>0,O().subarray(n/1,n/1+t)}const pt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>{a.__wbindgen_export_6.get(n.dtor)(n.a,n.b)});function U(n,t,e,r){const o={a:n,b:t,cnt:1,dtor:e},c=(...s)=>{o.cnt++;const _=o.a;o.a=0;try{return r(_,o.b,...s)}finally{--o.cnt===0?(a.__wbindgen_export_6.get(o.dtor)(_,o.b),pt.unregister(o)):o.a=_}};return c.original=o,pt.register(c,o,o),c}function lt(n){const t=typeof n;if(t=="number"||t=="boolean"||n==null)return`${n}`;if(t=="string")return`"${n}"`;if(t=="symbol"){const o=n.description;return o==null?"Symbol":`Symbol(${o})`}if(t=="function"){const o=n.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(n)){const o=n.length;let c="[";o>0&&(c+=lt(n[0]));for(let s=1;s<o;s++)c+=", "+lt(n[s]);return c+="]",c}const e=/\[object ([^\]]+)\]/.exec(toString.call(n));let r;if(e&&e.length>1)r=e[1];else return toString.call(n);if(r=="Object")try{return"Object("+JSON.stringify(n)+")"}catch{return"Object"}return n instanceof Error?`${n.name}: ${n.message}
${n.stack}`:r}function P(n){const t=a.__wbindgen_export_4.get(n);return a.__externref_table_dealloc(n),t}function ft(n,t){if(!(n instanceof t))throw new Error(`expected instance of ${t.name}`)}function yt(n,t){const e=t(n.length*1,1)>>>0;return O().set(n,e/1),d=n.length,e}function qt(n){return a.create_tonk_with_storage(n)}function Kt(){return a.create_tonk()}function Ht(n,t){const e=f(n,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.create_tonk_with_config(e,r,t)}function Gt(n){return a.create_tonk_from_bytes(n)}function Jt(n,t){return a.create_tonk_from_bytes_with_storage(n,t)}function Yt(n){const t=f(n,a.__wbindgen_malloc,a.__wbindgen_realloc),e=d;return a.create_tonk_with_peer_id(t,e)}function Xt(){a.init()}function Zt(n){return ft(n,A),a.create_tonk_from_bundle(n.__wbg_ptr)}function Qt(n){const t=a.create_bundle_from_bytes(n);if(t[2])throw P(t[1]);return A.__wrap(t[0])}function te(n,t){return ft(n,A),a.create_tonk_from_bundle_with_storage(n.__wbg_ptr,t)}function ee(n){a.set_time_provider(n)}function st(n,t,e){a.closure713_externref_shim(n,t,e)}function ne(n,t,e){const r=a.closure716_externref_shim_multivalue_shim(n,t,e);if(r[1])throw P(r[0])}function re(n,t,e){a.closure992_externref_shim(n,t,e)}function oe(n,t){a.wasm_bindgen__convert__closures_____invoke__hfd3cca906b115850(n,t)}function ie(n,t,e){a.closure1010_externref_shim(n,t,e)}function ae(n,t,e,r){a.closure1273_externref_shim(n,t,e,r)}const ce=["blob","arraybuffer"],se=["pending","done"],_e=["readonly","readwrite","versionchange","readwriteflush","cleanup"],mt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>a.__wbg_wasmbundle_free(n>>>0,1));class A{static __wrap(t){t=t>>>0;const e=Object.create(A.prototype);return e.__wbg_ptr=t,mt.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,mt.unregister(this),t}free(){const t=this.__destroy_into_raw();a.__wbg_wasmbundle_free(t,0)}static fromBytes(t){const e=a.wasmbundle_fromBytes(t);if(e[2])throw P(e[1]);return A.__wrap(e[0])}getPrefix(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmbundle_getPrefix(this.__wbg_ptr,e,r)}getRootId(){return a.wasmbundle_getRootId(this.__wbg_ptr)}getManifest(){return a.wasmbundle_getManifest(this.__wbg_ptr)}setManifest(t){return a.wasmbundle_setManifest(this.__wbg_ptr,t)}get(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmbundle_get(this.__wbg_ptr,e,r)}toBytes(){return a.wasmbundle_toBytes(this.__wbg_ptr)}listKeys(){return a.wasmbundle_listKeys(this.__wbg_ptr)}}const kt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>a.__wbg_wasmdochandle_free(n>>>0,1));class tt{static __wrap(t){t=t>>>0;const e=Object.create(tt.prototype);return e.__wbg_ptr=t,kt.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,kt.unregister(this),t}free(){const t=this.__destroy_into_raw();a.__wbg_wasmdochandle_free(t,0)}documentId(){let t,e;try{const r=a.wasmdochandle_documentId(this.__wbg_ptr);return t=r[0],e=r[1],h(r[0],r[1])}finally{a.__wbindgen_free(t,e,1)}}getDocument(){const t=a.wasmdochandle_getDocument(this.__wbg_ptr);if(t[2])throw P(t[1]);return P(t[0])}url(){let t,e;try{const r=a.wasmdochandle_url(this.__wbg_ptr);return t=r[0],e=r[1],h(r[0],r[1])}finally{a.__wbindgen_free(t,e,1)}}}const St=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>a.__wbg_wasmdocumentwatcher_free(n>>>0,1));class et{static __wrap(t){t=t>>>0;const e=Object.create(et.prototype);return e.__wbg_ptr=t,St.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,St.unregister(this),t}free(){const t=this.__destroy_into_raw();a.__wbg_wasmdocumentwatcher_free(t,0)}documentId(){let t,e;try{const r=a.wasmdocumentwatcher_documentId(this.__wbg_ptr);return t=r[0],e=r[1],h(r[0],r[1])}finally{a.__wbindgen_free(t,e,1)}}stop(){return a.wasmdocumentwatcher_stop(this.__wbg_ptr)}}const Et=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>a.__wbg_wasmerror_free(n>>>0,1));class nt{static __wrap(t){t=t>>>0;const e=Object.create(nt.prototype);return e.__wbg_ptr=t,Et.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Et.unregister(this),t}free(){const t=this.__destroy_into_raw();a.__wbg_wasmerror_free(t,0)}get message(){let t,e;try{const r=a.wasmerror_message(this.__wbg_ptr);return t=r[0],e=r[1],h(r[0],r[1])}finally{a.__wbindgen_free(t,e,1)}}}const Ft=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>a.__wbg_wasmrepo_free(n>>>0,1));class rt{static __wrap(t){t=t>>>0;const e=Object.create(rt.prototype);return e.__wbg_ptr=t,Ft.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Ft.unregister(this),t}free(){const t=this.__destroy_into_raw();a.__wbg_wasmrepo_free(t,0)}findDocument(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmrepo_findDocument(this.__wbg_ptr,e,r)}listDocuments(){const t=a.wasmrepo_listDocuments(this.__wbg_ptr);if(t[2])throw P(t[1]);return P(t[0])}createDocument(t){return a.wasmrepo_createDocument(this.__wbg_ptr,t)}connectWebSocket(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d,o=a.wasmrepo_connectWebSocket(this.__wbg_ptr,e,r);if(o[2])throw P(o[1]);return it.__wrap(o[0])}connectWebSocketAsync(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmrepo_connectWebSocketAsync(this.__wbg_ptr,e,r)}constructor(){return a.wasmrepo_new()}stop(){return a.wasmrepo_stop(this.__wbg_ptr)}peerId(){let t,e;try{const r=a.wasmrepo_peerId(this.__wbg_ptr);return t=r[0],e=r[1],h(r[0],r[1])}finally{a.__wbindgen_free(t,e,1)}}}const It=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>a.__wbg_wasmtonkcore_free(n>>>0,1));class ot{static __wrap(t){t=t>>>0;const e=Object.create(ot.prototype);return e.__wbg_ptr=t,It.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,It.unregister(this),t}free(){const t=this.__destroy_into_raw();a.__wbg_wasmtonkcore_free(t,0)}static fromBytes(t){return a.wasmtonkcore_fromBytes(t)}createFile(t,e){const r=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),o=d;return a.wasmtonkcore_createFile(this.__wbg_ptr,r,o,e)}deleteFile(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmtonkcore_deleteFile(this.__wbg_ptr,e,r)}static fromBundle(t){return ft(t,A),a.wasmtonkcore_fromBundle(t.__wbg_ptr)}getPeerId(){return a.wasmtonkcore_getPeerId(this.__wbg_ptr)}updateFile(t,e){const r=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),o=d;return a.wasmtonkcore_updateFile(this.__wbg_ptr,r,o,e)}getMetadata(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmtonkcore_getMetadata(this.__wbg_ptr,e,r)}isConnected(){return a.wasmtonkcore_isConnected(this.__wbg_ptr)}static withPeerId(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmtonkcore_withPeerId(e,r)}forkToBytes(t){return a.wasmtonkcore_forkToBytes(this.__wbg_ptr,t)}listDirectory(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmtonkcore_listDirectory(this.__wbg_ptr,e,r)}watchDocument(t,e){const r=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),o=d;return a.wasmtonkcore_watchDocument(this.__wbg_ptr,r,o,e)}watchDirectory(t,e){const r=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),o=d;return a.wasmtonkcore_watchDirectory(this.__wbg_ptr,r,o,e)}createDirectory(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmtonkcore_createDirectory(this.__wbg_ptr,e,r)}connectWebsocket(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmtonkcore_connectWebsocket(this.__wbg_ptr,e,r)}getConnectionState(){return a.wasmtonkcore_getConnectionState(this.__wbg_ptr)}createFileWithBytes(t,e,r){const o=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),c=d,s=yt(r,a.__wbindgen_malloc),_=d;return a.wasmtonkcore_createFileWithBytes(this.__wbg_ptr,o,c,e,s,_)}updateFileWithBytes(t,e,r){const o=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),c=d,s=yt(r,a.__wbindgen_malloc),_=d;return a.wasmtonkcore_updateFileWithBytes(this.__wbg_ptr,o,c,e,s,_)}constructor(){return a.wasmtonkcore_new()}exists(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmtonkcore_exists(this.__wbg_ptr,e,r)}rename(t,e){const r=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),o=d,c=f(e,a.__wbindgen_malloc,a.__wbindgen_realloc),s=d;return a.wasmtonkcore_rename(this.__wbg_ptr,r,o,c,s)}toBytes(t){return a.wasmtonkcore_toBytes(this.__wbg_ptr,t)}readFile(t){const e=f(t,a.__wbindgen_malloc,a.__wbindgen_realloc),r=d;return a.wasmtonkcore_readFile(this.__wbg_ptr,e,r)}}const Rt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>a.__wbg_wasmwebsockethandle_free(n>>>0,1));class it{static __wrap(t){t=t>>>0;const e=Object.create(it.prototype);return e.__wbg_ptr=t,Rt.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Rt.unregister(this),t}free(){const t=this.__destroy_into_raw();a.__wbg_wasmwebsockethandle_free(t,0)}waitForDisconnect(){return a.wasmwebsockethandle_waitForDisconnect(this.__wbg_ptr)}close(){a.wasmwebsockethandle_close(this.__wbg_ptr)}}const le=new Set(["basic","cors","default"]);async function de(n,t){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,t)}catch(r){if(n.ok&&le.has(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const e=await n.arrayBuffer();return await WebAssembly.instantiate(e,t)}else{const e=await WebAssembly.instantiate(n,t);return e instanceof WebAssembly.Instance?{instance:e,module:n}:e}}function Dt(){const n={};return n.wbg={},n.wbg.__wbg_Error_0497d5bdba9362e5=function(t,e){return Error(h(t,e))},n.wbg.__wbg_String_8f0eb39a4a4c2f66=function(t,e){const r=String(e),o=f(r,a.__wbindgen_malloc,a.__wbindgen_realloc),c=d;S().setInt32(t+4*1,c,!0),S().setInt32(t+4*0,o,!0)},n.wbg.__wbg_Window_41559019033ede94=function(t){return t.Window},n.wbg.__wbg_WorkerGlobalScope_d324bffbeaef9f3a=function(t){return t.WorkerGlobalScope},n.wbg.__wbg_abort_601b12a63a2f3a3a=function(){return u(function(t){t.abort()},arguments)},n.wbg.__wbg_bound_eb572b424befade3=function(){return u(function(t,e,r,o){return IDBKeyRange.bound(t,e,r!==0,o!==0)},arguments)},n.wbg.__wbg_buffer_a1a27a0dfa70165d=function(t){return t.buffer},n.wbg.__wbg_buffer_e495ba54cee589cc=function(t){return t.buffer},n.wbg.__wbg_call_f2db6205e5c51dc8=function(){return u(function(t,e,r){return t.call(e,r)},arguments)},n.wbg.__wbg_call_fbe8be8bf6436ce5=function(){return u(function(t,e){return t.call(e)},arguments)},n.wbg.__wbg_close_b08c03c920ee0bba=function(){return u(function(t){t.close()},arguments)},n.wbg.__wbg_commit_a54edce65f3858f2=function(){return u(function(t){t.commit()},arguments)},n.wbg.__wbg_continue_7d9cdafc888cb902=function(){return u(function(t){t.continue()},arguments)},n.wbg.__wbg_createObjectStore_b1f08961900155dd=function(){return u(function(t,e,r){return t.createObjectStore(h(e,r))},arguments)},n.wbg.__wbg_data_fffd43bf0ca75fff=function(t){return t.data},n.wbg.__wbg_delete_71b7921c73aa9378=function(){return u(function(t,e){return t.delete(e)},arguments)},n.wbg.__wbg_done_4d01f352bade43b7=function(t){return t.done},n.wbg.__wbg_entries_41651c850143b957=function(t){return Object.entries(t)},n.wbg.__wbg_error_31d7961b8e0d3f6c=function(t,e){console.error(h(t,e))},n.wbg.__wbg_error_4e978abc9692c0c5=function(){return u(function(t){const e=t.error;return R(e)?0:W(e)},arguments)},n.wbg.__wbg_error_51ecdd39ec054205=function(t){console.error(t)},n.wbg.__wbg_error_7534b8e9a36f1ab4=function(t,e){let r,o;try{r=t,o=e,console.error(h(t,e))}finally{a.__wbindgen_free(r,o,1)}},n.wbg.__wbg_from_12ff8e47307bd4c7=function(t){return Array.from(t)},n.wbg.__wbg_getRandomValues_1c61fac11405ffdc=function(){return u(function(t,e){globalThis.crypto.getRandomValues(ht(t,e))},arguments)},n.wbg.__wbg_getTime_2afe67905d873e92=function(t){return t.getTime()},n.wbg.__wbg_get_92470be87867c2e5=function(){return u(function(t,e){return Reflect.get(t,e)},arguments)},n.wbg.__wbg_get_a131a44bd1eb6979=function(t,e){return t[e>>>0]},n.wbg.__wbg_get_d37904b955701f99=function(){return u(function(t,e){return t.get(e)},arguments)},n.wbg.__wbg_getwithrefkey_1dc361bd10053bfe=function(t,e){return t[e]},n.wbg.__wbg_global_f5c2926e57ba457f=function(t){return t.global},n.wbg.__wbg_indexedDB_317016dcb8a872d6=function(){return u(function(t){const e=t.indexedDB;return R(e)?0:W(e)},arguments)},n.wbg.__wbg_indexedDB_54f01430b1e194e8=function(){return u(function(t){const e=t.indexedDB;return R(e)?0:W(e)},arguments)},n.wbg.__wbg_indexedDB_63b82e158eb67cbd=function(){return u(function(t){const e=t.indexedDB;return R(e)?0:W(e)},arguments)},n.wbg.__wbg_instanceof_ArrayBuffer_a8b6f580b363f2bc=function(t){let e;try{e=t instanceof ArrayBuffer}catch{e=!1}return e},n.wbg.__wbg_instanceof_CursorSys_4b6a8aba0e823e75=function(t){let e;try{e=t instanceof IDBCursorWithValue}catch{e=!1}return e},n.wbg.__wbg_instanceof_DomException_77720ed8752d7409=function(t){let e;try{e=t instanceof DOMException}catch{e=!1}return e},n.wbg.__wbg_instanceof_Error_58a92d81483a4b16=function(t){let e;try{e=t instanceof Error}catch{e=!1}return e},n.wbg.__wbg_instanceof_IdbCursor_07be219dc9364535=function(t){let e;try{e=t instanceof IDBCursor}catch{e=!1}return e},n.wbg.__wbg_instanceof_IdbDatabase_0ed56ed115d533bc=function(t){let e;try{e=t instanceof IDBDatabase}catch{e=!1}return e},n.wbg.__wbg_instanceof_IdbRequest_c4498c7b5a3a0fa3=function(t){let e;try{e=t instanceof IDBRequest}catch{e=!1}return e},n.wbg.__wbg_instanceof_Map_80cc65041c96417a=function(t){let e;try{e=t instanceof Map}catch{e=!1}return e},n.wbg.__wbg_instanceof_Uint8Array_ca460677bc155827=function(t){let e;try{e=t instanceof Uint8Array}catch{e=!1}return e},n.wbg.__wbg_isArray_5f090bed72bd4f89=function(t){return Array.isArray(t)},n.wbg.__wbg_isSafeInteger_90d7c4674047d684=function(t){return Number.isSafeInteger(t)},n.wbg.__wbg_item_15285ca2d766f142=function(t,e,r){const o=e.item(r>>>0);var c=R(o)?0:f(o,a.__wbindgen_malloc,a.__wbindgen_realloc),s=d;S().setInt32(t+4*1,s,!0),S().setInt32(t+4*0,c,!0)},n.wbg.__wbg_iterator_4068add5b2aef7a6=function(){return Symbol.iterator},n.wbg.__wbg_key_a17a68df9ec1b180=function(){return u(function(t){return t.key},arguments)},n.wbg.__wbg_keys_42062809bf87339e=function(t){return Object.keys(t)},n.wbg.__wbg_length_ab6d22b5ead75c72=function(t){return t.length},n.wbg.__wbg_length_f00ec12454a5d9fd=function(t){return t.length},n.wbg.__wbg_log_0cc1b7768397bcfe=function(t,e,r,o,c,s,_,w){let p,E;try{p=t,E=e,console.log(h(t,e),h(r,o),h(c,s),h(_,w))}finally{a.__wbindgen_free(p,E,1)}},n.wbg.__wbg_log_cb9e190acc5753fb=function(t,e){let r,o;try{r=t,o=e,console.log(h(t,e))}finally{a.__wbindgen_free(r,o,1)}},n.wbg.__wbg_log_ea240990d83e374e=function(t){console.log(t)},n.wbg.__wbg_lowerBound_13c8e875a3fb9f7d=function(){return u(function(t,e){return IDBKeyRange.lowerBound(t,e!==0)},arguments)},n.wbg.__wbg_mark_7438147ce31e9d4b=function(t,e){performance.mark(h(t,e))},n.wbg.__wbg_measure_fb7825c11612c823=function(){return u(function(t,e,r,o){let c,s,_,w;try{c=t,s=e,_=r,w=o,performance.measure(h(t,e),h(r,o))}finally{a.__wbindgen_free(c,s,1),a.__wbindgen_free(_,w,1)}},arguments)},n.wbg.__wbg_message_2d95ea5aff0d63b9=function(t,e){const r=e.message,o=f(r,a.__wbindgen_malloc,a.__wbindgen_realloc),c=d;S().setInt32(t+4*1,c,!0),S().setInt32(t+4*0,o,!0)},n.wbg.__wbg_message_4159c15dac08c5e9=function(t){return t.message},n.wbg.__wbg_message_44ef9b801b7d8bc3=function(t,e){const r=e.message,o=f(r,a.__wbindgen_malloc,a.__wbindgen_realloc),c=d;S().setInt32(t+4*1,c,!0),S().setInt32(t+4*0,o,!0)},n.wbg.__wbg_name_2acff1e83d9735f9=function(t,e){const r=e.name,o=f(r,a.__wbindgen_malloc,a.__wbindgen_realloc),c=d;S().setInt32(t+4*1,c,!0),S().setInt32(t+4*0,o,!0)},n.wbg.__wbg_new0_97314565408dea38=function(){return new Date},n.wbg.__wbg_new_07b483f72211fd66=function(){return new Object},n.wbg.__wbg_new_476169e6d59f23ae=function(t,e){return new Error(h(t,e))},n.wbg.__wbg_new_58353953ad2097cc=function(){return new Array},n.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},n.wbg.__wbg_new_a979b4b45bd55c7f=function(){return new Map},n.wbg.__wbg_new_e30c39c06edaabf2=function(t,e){try{var r={a:t,b:e},o=(s,_)=>{const w=r.a;r.a=0;try{return ae(w,r.b,s,_)}finally{r.a=w}};return new Promise(o)}finally{r.a=r.b=0}},n.wbg.__wbg_new_e52b3efaaa774f96=function(t){return new Uint8Array(t)},n.wbg.__wbg_new_f42a001532528172=function(){return u(function(t,e){return new WebSocket(h(t,e))},arguments)},n.wbg.__wbg_newfromslice_7c05ab1297cb2d88=function(t,e){return new Uint8Array(ht(t,e))},n.wbg.__wbg_newnoargs_ff528e72d35de39a=function(t,e){return new Function(h(t,e))},n.wbg.__wbg_newwithbyteoffsetandlength_3b01ecda099177e8=function(t,e,r){return new Uint8Array(t,e>>>0,r>>>0)},n.wbg.__wbg_newwithlength_08f872dc1e3ada2e=function(t){return new Uint8Array(t>>>0)},n.wbg.__wbg_next_8bb824d217961b5d=function(t){return t.next},n.wbg.__wbg_next_e2da48d8fff7439a=function(){return u(function(t){return t.next()},arguments)},n.wbg.__wbg_now_eb0821f3bd9f6529=function(){return Date.now()},n.wbg.__wbg_objectStoreNames_e82275eb2d403a92=function(t){return t.objectStoreNames},n.wbg.__wbg_objectStore_b463d32c86d6b543=function(){return u(function(t,e,r){return t.objectStore(h(e,r))},arguments)},n.wbg.__wbg_openCursor_7c13a2cd32c6258b=function(){return u(function(t){return t.openCursor()},arguments)},n.wbg.__wbg_open_0f04f50fa4d98f67=function(){return u(function(t,e,r,o){return t.open(h(e,r),o>>>0)},arguments)},n.wbg.__wbg_push_73fd7b5550ebf707=function(t,e){return t.push(e)},n.wbg.__wbg_put_7f0b4dcc666f09e3=function(){return u(function(t,e,r){return t.put(e,r)},arguments)},n.wbg.__wbg_queueMicrotask_46c1df247678729f=function(t){queueMicrotask(t)},n.wbg.__wbg_queueMicrotask_8acf3ccb75ed8d11=function(t){return t.queueMicrotask},n.wbg.__wbg_readyState_249e5707a38b7a7a=function(t){const e=t.readyState;return(se.indexOf(e)+1||3)-1},n.wbg.__wbg_request_5079471e06223120=function(t){return t.request},n.wbg.__wbg_request_fada8c23b78b3a02=function(t){return t.request},n.wbg.__wbg_resolve_0dac8c580ffd4678=function(t){return Promise.resolve(t)},n.wbg.__wbg_result_a0f1bf2fe64a516c=function(){return u(function(t){return t.result},arguments)},n.wbg.__wbg_send_05456d2bf190b017=function(){return u(function(t,e){t.send(e)},arguments)},n.wbg.__wbg_set_3f1d0b984ed272ed=function(t,e,r){t[e]=r},n.wbg.__wbg_set_7422acbe992d64ab=function(t,e,r){t[e>>>0]=r},n.wbg.__wbg_set_c43293f93a35998a=function(){return u(function(t,e,r){return Reflect.set(t,e,r)},arguments)},n.wbg.__wbg_set_d6bdfd275fb8a4ce=function(t,e,r){return t.set(e,r)},n.wbg.__wbg_set_fe4e79d1ed3b0e9b=function(t,e,r){t.set(e,r>>>0)},n.wbg.__wbg_setbinaryType_52787d6025601cc5=function(t,e){t.binaryType=ce[e]},n.wbg.__wbg_setonabort_479ebb5884fcb171=function(t,e){t.onabort=e},n.wbg.__wbg_setonclose_c6db38f935250174=function(t,e){t.onclose=e},n.wbg.__wbg_setoncomplete_27bdbca012e45c05=function(t,e){t.oncomplete=e},n.wbg.__wbg_setonerror_537b68f474e27d4e=function(t,e){t.onerror=e},n.wbg.__wbg_setonerror_ab02451cd01cb480=function(t,e){t.onerror=e},n.wbg.__wbg_setonerror_ce5c4d34aed931bb=function(t,e){t.onerror=e},n.wbg.__wbg_setonmessage_49ca623a77cfb3e6=function(t,e){t.onmessage=e},n.wbg.__wbg_setonopen_1475cbeb761c101f=function(t,e){t.onopen=e},n.wbg.__wbg_setonsuccess_0b2b45bd8cc13b95=function(t,e){t.onsuccess=e},n.wbg.__wbg_setonupgradeneeded_be2e0ae927917f82=function(t,e){t.onupgradeneeded=e},n.wbg.__wbg_stack_0ed75d68575b0f3c=function(t,e){const r=e.stack,o=f(r,a.__wbindgen_malloc,a.__wbindgen_realloc),c=d;S().setInt32(t+4*1,c,!0),S().setInt32(t+4*0,o,!0)},n.wbg.__wbg_static_accessor_GLOBAL_487c52c58d65314d=function(){const t=typeof globalThis>"u"?null:globalThis;return R(t)?0:W(t)},n.wbg.__wbg_static_accessor_GLOBAL_THIS_ee9704f328b6b291=function(){const t=typeof globalThis>"u"?null:globalThis;return R(t)?0:W(t)},n.wbg.__wbg_static_accessor_SELF_78c9e3071b912620=function(){const t=typeof self>"u"?null:self;return R(t)?0:W(t)},n.wbg.__wbg_static_accessor_WINDOW_a093d21393777366=function(){const t=typeof window>"u"?null:window;return R(t)?0:W(t)},n.wbg.__wbg_target_15f1da583855ac4e=function(t){const e=t.target;return R(e)?0:W(e)},n.wbg.__wbg_then_82ab9fb4080f1707=function(t,e,r){return t.then(e,r)},n.wbg.__wbg_then_db882932c0c714c6=function(t,e){return t.then(e)},n.wbg.__wbg_toString_bc7a05a172b5cf14=function(t){return t.toString()},n.wbg.__wbg_transaction_36c8b28ed4349a9a=function(){return u(function(t,e,r,o){return t.transaction(h(e,r),_e[o])},arguments)},n.wbg.__wbg_transaction_d1f21f4378880521=function(t){return t.transaction},n.wbg.__wbg_upperBound_a0bd8ece19d98580=function(){return u(function(t,e){return IDBKeyRange.upperBound(t,e!==0)},arguments)},n.wbg.__wbg_value_17b896954e14f896=function(t){return t.value},n.wbg.__wbg_value_648dc44894c8dc95=function(){return u(function(t){return t.value},arguments)},n.wbg.__wbg_wasmdochandle_new=function(t){return tt.__wrap(t)},n.wbg.__wbg_wasmdocumentwatcher_new=function(t){return et.__wrap(t)},n.wbg.__wbg_wasmerror_new=function(t){return nt.__wrap(t)},n.wbg.__wbg_wasmrepo_new=function(t){return rt.__wrap(t)},n.wbg.__wbg_wasmtonkcore_new=function(t){return ot.__wrap(t)},n.wbg.__wbindgen_bigint_from_i64=function(t){return t},n.wbg.__wbindgen_bigint_from_u64=function(t){return BigInt.asUintN(64,t)},n.wbg.__wbindgen_bigint_get_as_i64=function(t,e){const r=e,o=typeof r=="bigint"?r:void 0;S().setBigInt64(t+8*1,R(o)?BigInt(0):o,!0),S().setInt32(t+4*0,!R(o),!0)},n.wbg.__wbindgen_boolean_get=function(t){const e=t;return typeof e=="boolean"?e?1:0:2},n.wbg.__wbindgen_cb_drop=function(t){const e=t.original;return e.cnt--==1?(e.a=0,!0):!1},n.wbg.__wbindgen_closure_wrapper1832=function(t,e,r){return U(t,e,712,st)},n.wbg.__wbindgen_closure_wrapper1834=function(t,e,r){return U(t,e,712,st)},n.wbg.__wbindgen_closure_wrapper1836=function(t,e,r){return U(t,e,712,ne)},n.wbg.__wbindgen_closure_wrapper1838=function(t,e,r){return U(t,e,712,st)},n.wbg.__wbindgen_closure_wrapper2532=function(t,e,r){return U(t,e,991,re)},n.wbg.__wbindgen_closure_wrapper2534=function(t,e,r){return U(t,e,991,oe)},n.wbg.__wbindgen_closure_wrapper2562=function(t,e,r){return U(t,e,1009,ie)},n.wbg.__wbindgen_debug_string=function(t,e){const r=lt(e),o=f(r,a.__wbindgen_malloc,a.__wbindgen_realloc),c=d;S().setInt32(t+4*1,c,!0),S().setInt32(t+4*0,o,!0)},n.wbg.__wbindgen_in=function(t,e){return t in e},n.wbg.__wbindgen_init_externref_table=function(){const t=a.__wbindgen_export_4,e=t.grow(4);t.set(0,void 0),t.set(e+0,void 0),t.set(e+1,null),t.set(e+2,!0),t.set(e+3,!1)},n.wbg.__wbindgen_is_bigint=function(t){return typeof t=="bigint"},n.wbg.__wbindgen_is_function=function(t){return typeof t=="function"},n.wbg.__wbindgen_is_null=function(t){return t===null},n.wbg.__wbindgen_is_object=function(t){const e=t;return typeof e=="object"&&e!==null},n.wbg.__wbindgen_is_string=function(t){return typeof t=="string"},n.wbg.__wbindgen_is_undefined=function(t){return t===void 0},n.wbg.__wbindgen_jsval_eq=function(t,e){return t===e},n.wbg.__wbindgen_jsval_loose_eq=function(t,e){return t==e},n.wbg.__wbindgen_memory=function(){return a.memory},n.wbg.__wbindgen_number_get=function(t,e){const r=e,o=typeof r=="number"?r:void 0;S().setFloat64(t+8*1,R(o)?0:o,!0),S().setInt32(t+4*0,!R(o),!0)},n.wbg.__wbindgen_number_new=function(t){return t},n.wbg.__wbindgen_string_get=function(t,e){const r=e,o=typeof r=="string"?r:void 0;var c=R(o)?0:f(o,a.__wbindgen_malloc,a.__wbindgen_realloc),s=d;S().setInt32(t+4*1,s,!0),S().setInt32(t+4*0,c,!0)},n.wbg.__wbindgen_string_new=function(t,e){return h(t,e)},n.wbg.__wbindgen_throw=function(t,e){throw new Error(h(t,e))},n}function Pt(n,t){return a=n.exports,Q.__wbindgen_wasm_module=t,z=null,N=null,a.__wbindgen_start(),a}function ue(n){if(a!==void 0)return a;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module:n}=n:console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));const t=Dt();n instanceof WebAssembly.Module||(n=new WebAssembly.Module(n));const e=new WebAssembly.Instance(n,t);return Pt(e,n)}async function Q(n){if(a!==void 0)return a;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof n>"u"&&(n=new URL("/assets/tonk_core_bg-BvPsMkkA.wasm",import.meta.url));const t=Dt();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:e,module:r}=await de(await n,t);return Pt(e,r)}const V=Object.freeze(Object.defineProperty({__proto__:null,WasmBundle:A,WasmDocHandle:tt,WasmDocumentWatcher:et,WasmError:nt,WasmRepo:rt,WasmTonkCore:ot,WasmWebSocketHandle:it,create_bundle_from_bytes:Qt,create_tonk:Kt,create_tonk_from_bundle:Zt,create_tonk_from_bundle_with_storage:te,create_tonk_from_bytes:Gt,create_tonk_from_bytes_with_storage:Jt,create_tonk_with_config:Ht,create_tonk_with_peer_id:Yt,create_tonk_with_storage:qt,default:Q,init:Xt,initSync:ue,set_time_provider:ee},Symbol.toStringTag,{value:"Module"}));let Bt=!1,L=null;async function J(n){if(!Bt)return L||(L=(async()=>{try{n?.wasmPath?await Q({module_or_path:n.wasmPath}):await Q(),Bt=!0}catch(t){throw L=null,t}})(),L)}const At=!0;console.log("ðŸš€ SERVICE WORKER: Script loaded at",new Date().toISOString());console.log("ðŸ” DEBUG_LOGGING enabled:",At);console.log("ðŸŒ Service worker location:",self.location.href);console.log("ðŸ”§ SERVICE WORKER VERSION:","mioo0juu");console.log("ðŸ• SERVICE WORKER BUILD TIME:","2025-12-02T14:20:16.902Z");let g={status:"uninitialized"},k=null,I=null,_t=null,q=!0,C=0;const Tt=10,vt=5e3;function B(){return g.status==="ready"?g:null}const at="tonk-sw-state-v1",dt="/tonk-state/appSlug",ut="/tonk-state/bundleBytes";async function Ut(n){try{const t=await caches.open(at);if(n===null)await t.delete(dt);else{const e=new Response(JSON.stringify({slug:n}),{headers:{"Content-Type":"application/json"}});await t.put(dt,e)}i("info","AppSlug persisted to cache",{slug:n})}catch(t){i("error","Failed to persist appSlug",{error:t instanceof Error?t.message:String(t)})}}async function fe(){try{const t=await(await caches.open(at)).match(dt);return t&&(await t.json()).slug||null}catch(n){return i("error","Failed to restore appSlug",{error:n instanceof Error?n.message:String(n)}),null}}async function Y(n){try{const t=await caches.open(at);if(n===null)await t.delete(ut);else{const e=new Blob([n],{type:"application/octet-stream"}),r=new Response(e,{headers:{"Content-Type":"application/octet-stream"}});await t.put(ut,r)}i("info","Bundle bytes persisted to cache",{size:n?n.length:0})}catch(t){i("error","Failed to persist bundle bytes",{error:t instanceof Error?t.message:String(t)})}}async function we(){try{const t=await(await caches.open(at)).match(ut);if(!t)return null;const e=await t.arrayBuffer();return new Uint8Array(e)}catch(n){return i("error","Failed to restore bundle bytes",{error:n instanceof Error?n.message:String(n)}),null}}function i(n,t,e){const o=`[VFS Service Worker ${new Date().toISOString()}] ${n.toUpperCase()}:`;e!==void 0?console[n](o,t,e):console[n](o,t)}const v=new Map;async function X(n){return i("info","Waiting for PathIndex to sync from remote..."),new Promise(t=>{let e=!1,r=null;const o=setTimeout(()=>{if(r)try{r.stop()}catch(c){i("warn","Error stopping PathIndex watcher on timeout",{error:c instanceof Error?c.message:String(c)})}e||(i("info","No PathIndex changes detected after 10s - proceeding (first client or already synced)"),t())},1e3);n.watchDirectory("/",c=>{if(!e){if(e=!0,i("info","PathIndex synced from remote - changes detected!",{documentType:c.type}),clearTimeout(o),r)try{r.stop()}catch(s){i("warn","Error stopping PathIndex watcher after sync",{error:s instanceof Error?s.message:String(s)})}t()}}).then(c=>{r=c,i("info","PathIndex watcher established",{watcherId:c?.document_id||"unknown"})}).catch(c=>{i("error","Failed to establish PathIndex watcher",{error:c.message}),clearTimeout(o),t()})})}async function l(n){i("info","Posting response to main thread",{type:n.type,success:"success"in n?n.success:"N/A"}),(await self.clients.matchAll()).forEach(e=>{e.postMessage(n)})}async function be(){const n=B();if(!n)return!1;try{return await n.tonk.isConnected()}catch(t){return console.error("ðŸ¥ [SW] performHealthCheck() ERROR:",t),!1}}async function zt(){if(!I){i("error","Cannot reconnect: wsUrl not stored"),console.error("ðŸ”„ [SW] Cannot reconnect: wsUrl not stored");return}C>=Tt&&(C=0);const n=B();if(!n){i("error","Cannot reconnect: tonk not initialized"),console.error("ðŸ”„ [SW] Cannot reconnect: tonk not initialized");return}C++,i("info","Attempting to reconnect",{attempt:C,maxAttempts:Tt,wsUrl:I}),await l({type:"reconnecting",attempt:C});try{if(await n.tonk.connectWebsocket(I),await new Promise(e=>setTimeout(e,1e3)),await n.tonk.isConnected())q=!0,C=0,i("info","Reconnection successful"),await l({type:"reconnected"}),await ge();else throw new Error("Connection check failed after reconnect attempt")}catch(t){i("error","Reconnection failed",{error:t instanceof Error?t.message:String(t),attempt:C});const e=Math.min(1e3*Math.pow(2,C-1),3e4);i("info","Scheduling next reconnect attempt",{delayMs:e,nextAttempt:C+1}),setTimeout(zt,e)}}async function ge(){if(i("info","Re-establishing watchers after reconnection",{watcherCount:v.size}),!B()){i("error","Cannot re-establish watchers: tonk not available");return}const t=Array.from(v.entries());i("info","Watcher re-establishment complete",{watcherCount:t.length}),await l({type:"watchersReestablished",count:t.length})}function Z(){_t&&clearInterval(_t),i("info","Starting health monitoring",{intervalMs:vt}),_t=setInterval(async()=>{const n=await be();!n&&q?(q=!1,i("error","Connection lost, starting reconnection attempts"),console.error("âŒ [SW] Connection lost, starting reconnection attempts"),await l({type:"disconnected"}),zt()):n&&!q&&(q=!0,C=0,i("info","Connection health restored"))},vt)}i("info","Service worker starting, checking for cached state");console.log("ðŸš€ SERVICE WORKER: Starting initialization");g={status:"uninitialized"};async function he(){try{const n=await fe(),t=await we();if(!n||!t){i("info","No cached state found, waiting for initialization message",{hasSlug:!!n,hasBundle:!!t}),console.log("ðŸ”„ SERVICE WORKER: No cached state - waiting for bundle");return}k=n,i("info","Found cached state, auto-initializing",{slug:k,bundleSize:t.length}),console.log("ðŸ”„ SERVICE WORKER: Auto-initializing from cache...",k);const e="http://localhost:8081/tonk_core_bg.wasm";i("info","Fetching WASM from server"),await J({wasmPath:e}),i("info","WASM initialization completed");const o=await(await $.fromBytes(t)).getManifest();i("info","Bundle and manifest restored from cache",{rootId:o.rootId});const c=await T.fromBytes(t,{storage:{type:"indexeddb"}});i("info","TonkCore created from cached bundle"),I=`${"http://localhost:8081".replace(/^http/,"ws")}`,i("info","Connecting to websocket...",{wsUrl:I,localRootId:o.rootId}),await c.connectWebsocket(I),i("info","Websocket connected"),Z(),await X(c),i("info","Auto-initialization complete - tonk ready"),console.log("âœ… SERVICE WORKER: Auto-initialized successfully"),g={status:"ready",tonk:c,manifest:o}}catch(n){i("error","Auto-initialization failed",{error:n instanceof Error?n.message:String(n)}),console.error("âŒ SERVICE WORKER: Auto-initialization failed:",n),g={status:"uninitialized"},k=null,(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:"needsReinit",appSlug:null,reason:"Auto-initialization failed"})})}}he();self.addEventListener("install",n=>{i("info","Service worker installing"),console.log("ðŸ”§ SERVICE WORKER: Installing SW"),self.skipWaiting(),i("info","Service worker install completed, skipWaiting called")});self.addEventListener("activate",n=>{i("info","Service worker activating"),console.log("ðŸš€ SERVICE WORKER: Activating service worker."),n.waitUntil((async()=>{await self.clients.claim(),i("info","Service worker activation completed, clients claimed"),(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:"ready",needsBundle:!0})}),i("info","Service worker activated, ready message sent to all clients"),console.log("ðŸš€ SERVICE WORKER: Activated and ready")})())});const xt=async n=>{if(n.bytes){const t=atob(n.bytes),e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return new Response(e,{headers:{"Content-Type":n.content.mime}})}else return new Response(n.content,{headers:{"Content-Type":"application/json"}})},Wt=n=>{if(console.log("ðŸŽ¯ determinePath START",{url:n.href,pathname:n.pathname,appSlug:k||"none"}),!k)throw console.error("determinePath - NO APP SLUG SET"),new Error(`No app slug available for ${n.pathname}`);const t=new URL(self.registration?.scope??self.location.href).pathname,e=n.pathname.startsWith(t)?n.pathname.slice(t.length):n.pathname,r=e.replace(/^\/+/,"").split("/").filter(Boolean);console.log("determinePath - segments",{scopePath:t,strippedPath:e,segments:[...r],firstSegment:r[0]||"none"});let o=r;if(r[0]===k?(o=r.slice(1),console.log("determinePath - appSlug already present, using remaining segments",{pathSegments:[...o]})):console.log("determinePath - appSlug not present, using all segments as path",{pathSegments:[...o]}),o.length===0||n.pathname.endsWith("/")){const s=`${k}/index.html`;return console.log("determinePath - defaulting to index.html",{result:s}),s}const c=`${k}/${o.join("/")}`;return console.log("determinePath - returning file path",{result:c}),c};self.addEventListener("fetch",n=>{const t=new URL(n.request.url),e=n.request.referrer;console.log("ðŸ”¥ FETCH EVENT:",t.href,"Origin match:",t.origin===location.origin,"Pathname:",t.pathname),console.log("ðŸ”¥ Tonk state:",g.status),console.log("ðŸ”¥ Current appSlug:",k),i("info","Fetch event received",{url:t.href,origin:t.origin,pathname:t.pathname,referrer:e,method:n.request.method,matchesOrigin:t.origin===location.origin});const r=n.request.headers.get("upgrade");if(r&&r.toLowerCase()==="websocket"){i("info","ðŸ”Œ WS: WebSocket upgrade request detected - allowing through",{url:t.href});return}const o=t.pathname==="/"||t.pathname==="";if(o&&k&&(k=null,Promise.all([Ut(null),Y(null)]).catch(c=>{i("error","Failed to persist state reset",{error:c})})),k&&!o){if(t.pathname.startsWith("/@vite")||t.pathname.startsWith("/@react-refresh")||t.pathname.startsWith("/src/")||t.pathname.startsWith(`/${k}/@vite`)||t.pathname.startsWith(`/${k}/node_modules`)||t.pathname.startsWith(`/${k}/src/`)||t.pathname.startsWith("/node_modules")||t.pathname.includes("__vite__")||t.searchParams.has("t")){i("info","Vite HMR asset detected, proxying to dev server",{url:t.href}),n.respondWith((async()=>{try{const c=`http://localhost:4001${t.pathname}${t.search}`;i("info","Fetching Vite asset from dev server",{original:t.pathname,proxied:c});const s=await fetch(c),_=new Headers(s.headers);return _.set("Cache-Control","no-cache, no-store, must-revalidate"),_.set("Pragma","no-cache"),_.set("Expires","0"),new Response(s.body,{status:s.status,statusText:s.statusText,headers:_})}catch(c){return i("error","Failed to fetch Vite asset",{error:c instanceof Error?c.message:String(c),url:t.pathname}),new Response("Vite dev server unreachable",{status:502,headers:{"Content-Type":"text/plain"}})}})());return}i("info","TONK_SERVE_LOCAL enabled, proxying to local dev server"),n.respondWith((async()=>{try{const c=`http://localhost:4001${t.pathname}${t.search}`;i("info","Proxying request to local dev server",{original:t.pathname,proxied:c});const s=await fetch(c);i("info","Received response from local dev server",{status:s.status,contentType:s.headers.get("content-type")});const _=new Headers(s.headers);return _.set("Cache-Control","no-cache, no-store, must-revalidate"),_.set("Pragma","no-cache"),_.set("Expires","0"),new Response(s.body,{status:s.status,statusText:s.statusText,headers:_})}catch(c){return i("error","Failed to fetch from local dev server",{error:c instanceof Error?c.message:String(c),url:t.pathname}),new Response("Local dev server unreachable on port 4001",{status:502,headers:{"Content-Type":"text/plain"}})}})());return}k&&t.origin===location.origin&&!o?(i("info","Processing fetch request for same origin (non-root)"),n.respondWith((async()=>{try{const c=Wt(t);i("info","Determined path for request",{path:c,originalUrl:t.href});const s=B();if(i("info","Retrieved Tonk instance",{hasTonkInstance:!!s,tonkState:g.status,tonkStateDetails:g.status==="ready"?"ready":g.status==="loading"?"loading":g.status==="failed"?"failed":"uninitialized"}),!s)throw i("error","Tonk not initialized - cannot handle request",{tonkState:g.status,path:c,url:t.href}),new Error("Tonk not initialized");const _=`/${c}`;if(!await s.tonk.exists(_)){console.warn(`ðŸš¨ File not found: ${_}, falling back to index.html`),i("warn","File not found, falling back to index.html",{requestedPath:_,fallbackPath:`/${k}/index.html`});const F=`/${k}/index.html`,M=await s.tonk.readFile(F);return i("info","Successfully read index.html fallback",{filePath:F,hasContent:!!M.content,hasBytes:!!M.bytes}),xt(M)}i("info","File exists, attempting to read from Tonk",{filePath:_});const p=await s.tonk.readFile(_);i("info","Successfully read file from Tonk",{filePath:_,hasContent:!!p.content,hasBytes:!!p.bytes,contentType:p.content?p.content.mime:"unknown"});const E=xt(p);return i("info","Created response for file",{filePath:`/${c}`,responseType:p.bytes?"binary":"text"}),E}catch(c){return i("error","Failed to fetch file from Tonk, falling back to original request",{error:c instanceof Error?c.message:String(c),path:Wt(t),url:t.href,tonkState:g.status}),i("info","Falling back to original fetch request",{url:t.href}),fetch(n.request)}})())):i("info","Ignoring fetch request for different origin",{requestOrigin:t.origin,serviceWorkerOrigin:location.origin})});async function pe(n){if(i("info","Received message",{type:n.type,id:"id"in n?n.id:"N/A"}),n.type==="setAppSlug"){k=n.slug,await Ut(k),i("info","App slug set and persisted",{slug:k});return}const t=["init","loadBundle","initializeFromUrl","initializeFromBytes","getServerUrl"];if(g.status!=="ready"&&!t.includes(n.type)){i("error","Operation attempted before VFS initialization",{type:n.type,status:g.status}),"id"in n&&l({type:n.type,id:n.id,success:!1,error:"VFS not initialized. Please load a bundle first."});return}switch(n.type){case"init":i("info","Handling VFS init message",{manifestSize:n.manifest.byteLength,wsUrl:n.wsUrl,id:"id"in n?n.id:"N/A"});try{if(g.status==="ready"){i("info","Tonk already initialized, responding with success"),l({type:"init",success:!0});return}if(g.status==="loading"){i("info","Tonk is loading, waiting for completion");try{await g.promise,i("info","Tonk loading completed, responding with success"),l({type:"init",success:!0})}catch(e){i("error","Tonk loading failed",{error:e instanceof Error?e.message:String(e)}),l({type:"init",success:!1,error:e instanceof Error?e.message:String(e)})}return}if(g.status==="failed"){i("error","Tonk initialization failed previously",{error:g.error.message}),l({type:"init",success:!1,error:g.error.message});return}i("warn","Tonk is uninitialized, this is unexpected"),l({type:"init",success:!1,error:"Tonk not initialized"})}catch(e){i("error","Failed to handle init message",{error:e instanceof Error?e.message:String(e)}),l({type:"init",success:!1,error:e instanceof Error?e.message:String(e)})}break;case"readFile":i("info","Reading file",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.readFile(n.path);i("info","File read successfully",{path:n.path,documentType:r.type,hasBytes:!!r.bytes,contentType:typeof r.content}),l({type:"readFile",id:n.id,success:!0,data:r})}catch(e){i("error","Failed to read file",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"readFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"writeFile":i("info","Writing file",{path:n.path,id:n.id,create:n.create,hasBytes:!!n.content.bytes,contentType:typeof n.content.content});try{const{tonk:e}=B();n.create?(i("info","Creating new file",{path:n.path}),n.content.bytes?await e.createFileWithBytes(n.path,n.content.content,n.content.bytes):await e.createFile(n.path,n.content.content)):(i("info","Updating existing file",{path:n.path}),n.content.bytes?await e.updateFileWithBytes(n.path,n.content.content,n.content.bytes):await e.updateFile(n.path,n.content.content)),i("info","File write completed successfully",{path:n.path}),l({type:"writeFile",id:n.id,success:!0})}catch(e){i("error","Failed to write file",{path:n.path,create:n.create,error:e instanceof Error?e.message:String(e)}),l({type:"writeFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"deleteFile":i("info","Deleting file",{path:n.path,id:n.id});try{const{tonk:e}=B();await e.deleteFile(n.path),i("info","File deleted successfully",{path:n.path}),l({type:"deleteFile",id:n.id,success:!0})}catch(e){i("error","Failed to delete file",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"deleteFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"rename":i("info","Renaming file or directory",{oldPath:n.oldPath,newPath:n.newPath,id:n.id});try{const{tonk:e}=B();await e.rename(n.oldPath,n.newPath),i("info","Rename completed successfully",{oldPath:n.oldPath,newPath:n.newPath}),l({type:"rename",id:n.id,success:!0})}catch(e){i("error","Failed to rename",{oldPath:n.oldPath,newPath:n.newPath,error:e instanceof Error?e.message:String(e)}),l({type:"rename",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"listDirectory":i("info","Listing directory",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.listDirectory(n.path);i("info","Directory listed successfully",{path:n.path,fileCount:Array.isArray(r)?r.length:"unknown"}),l({type:"listDirectory",id:n.id,success:!0,data:r})}catch(e){i("error","Failed to list directory",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"listDirectory",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"exists":i("info","Checking file existence",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.exists(n.path);i("info","File existence check completed",{path:n.path,exists:r}),l({type:"exists",id:n.id,success:!0,data:r})}catch(e){i("error","Failed to check file existence",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"exists",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"watchFile":i("info","Starting file watch",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.watchFile(n.path,o=>{i("info","File change detected",{watchId:n.id,path:n.path,documentType:o.type,hasBytes:!!o.bytes}),l({type:"fileChanged",watchId:n.id,documentData:o})});v.set(n.id,r),i("info","File watch started successfully",{path:n.path,watchId:n.id,totalWatchers:v.size}),l({type:"watchFile",id:n.id,success:!0})}catch(e){i("error","Failed to start file watch",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"watchFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"unwatchFile":i("info","Stopping file watch",{watchId:n.id});try{const e=v.get(n.id);e?(i("info","Found watcher, stopping it",{watchId:n.id}),e.stop(),v.delete(n.id),i("info","File watch stopped successfully",{watchId:n.id,remainingWatchers:v.size})):i("warn","No watcher found for ID",{watchId:n.id}),l({type:"unwatchFile",id:n.id,success:!0})}catch(e){i("error","Failed to stop file watch",{watchId:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"unwatchFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"watchDirectory":i("info","Starting directory watch",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.watchDirectory(n.path,o=>{i("info","Directory change detected",{watchId:n.id,path:n.path}),l({type:"directoryChanged",watchId:n.id,path:n.path,changeData:o})});v.set(n.id,r),i("info","Directory watch started successfully",{path:n.path,watchId:n.id,totalWatchers:v.size}),l({type:"watchDirectory",id:n.id,success:!0})}catch(e){i("error","Failed to start directory watch",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"watchDirectory",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"unwatchDirectory":i("info","Stopping directory watch",{watchId:n.id});try{const e=v.get(n.id);e?(i("info","Found directory watcher, stopping it",{watchId:n.id}),e.stop(),v.delete(n.id),i("info","Directory watch stopped successfully",{watchId:n.id,remainingWatchers:v.size})):i("warn","No directory watcher found for ID",{watchId:n.id}),l({type:"unwatchDirectory",id:n.id,success:!0})}catch(e){i("error","Failed to stop directory watch",{watchId:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"unwatchDirectory",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"toBytes":i("info","Converting tonk to bytes",{id:n.id});try{const{tonk:e,manifest:r}=B(),o=await e.toBytes(),c=r.rootId;i("info","Tonk converted to bytes successfully",{id:n.id,byteLength:o.length,rootId:c,manifestKeys:Object.keys(r)}),l({type:"toBytes",id:n.id,success:!0,data:o,rootId:c})}catch(e){i("error","Failed to convert tonk to bytes",{id:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"toBytes",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"forkToBytes":i("info","Forking tonk to bytes",{id:n.id});try{const{tonk:e}=B(),r=await e.forkToBytes(),c=await(await $.fromBytes(r)).getManifest(),s=c.rootId;i("info","Tonk forked to bytes successfully",{id:n.id,byteLength:r.length,rootId:s,manifestKeys:Object.keys(c)}),l({type:"forkToBytes",id:n.id,success:!0,data:r,rootId:s})}catch(e){i("error","Failed to fork tonk to bytes",{id:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"forkToBytes",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"loadBundle":i("info","Loading new bundle",{id:n.id,byteLength:n.bundleBytes.byteLength,serverUrl:n.serverUrl});try{const e=n.serverUrl||"http://localhost:8081";if(i("info","Using server URL",{serverUrl:e}),g.status==="uninitialized"){i("info","WASM not initialized, initializing now");const F=`${`${e}/tonk_core_bg.wasm`}?t=${Date.now()}`;i("info","Fetching WASM from",{cacheBustUrl:F}),await J({wasmPath:F}),i("info","WASM initialization completed for bundle loading")}const r=new Uint8Array(n.bundleBytes);i("info","Creating bundle from bytes",{byteLength:r.length});const c=await(await $.fromBytes(r)).getManifest();i("info","Bundle and manifest created successfully",{rootId:c.rootId}),i("info","Creating new TonkCore from bundle bytes");const s=await T.fromBytes(r,{storage:{type:"indexeddb"}});i("info","New TonkCore created successfully");const w=new URLSearchParams(self.location.search).get("bundle");let p=`${e.replace(/^http/,"ws")}`;if(w)try{const E=atob(w),F=JSON.parse(E);F.wsUrl&&(p=F.wsUrl)}catch(E){i("warn","Could not parse bundle config for wsUrl",{error:E instanceof Error?E.message:String(E)})}i("info","Determined websocket URL",{wsUrl:p,serverUrl:e}),I=p,i("info","Connecting new tonk to websocket",{wsUrl:I,localRootId:c.rootId}),I&&(await s.connectWebsocket(I),i("info","Websocket connection established"),Z(),await X(s),i("info","PathIndex sync complete after loadBundle")),g={status:"ready",tonk:s,manifest:c},i("info","Tonk state updated with new instance"),await Y(r),i("info","Bundle bytes persisted to IndexedDB"),l({type:"loadBundle",id:n.id,success:!0})}catch(e){i("error","Failed to load bundle",{id:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"loadBundle",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"getServerUrl":i("info","Getting server URL",{id:n.id}),l({type:"getServerUrl",id:n.id,success:!0,data:"http://localhost:8081"});break;case"getManifest":i("info","Getting manifest",{id:n.id});try{const e=B();if(!e)throw new Error("Tonk not initialized");l({type:"getManifest",id:n.id,success:!0,data:e.manifest})}catch(e){i("error","Failed to get manifest",{id:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"getManifest",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"initializeFromUrl":i("info","Initializing from URL",{id:n.id,manifestUrl:n.manifestUrl,wasmUrl:n.wasmUrl});try{const e=n.wasmUrl||"http://localhost:8081/tonk_core_bg.wasm",r=n.manifestUrl||"http://localhost:8081/.manifest.tonk",o=n.wsUrl||"http://localhost:8081".replace(/^http/,"ws");i("info","Fetching WASM from URL",{wasmUrl:e});const c=`${e}?t=${Date.now()}`;await J({wasmPath:c}),i("info","WASM initialization completed"),i("info","Fetching manifest from URL",{manifestUrl:r});const s=await fetch(r),_=new Uint8Array(await s.arrayBuffer());i("info","Manifest bytes loaded",{byteLength:_.length});const p=await(await $.fromBytes(_)).getManifest();i("info","Bundle and manifest created successfully"),i("info","Creating TonkCore from manifest bytes");const E=await T.fromBytes(_,{storage:{type:"indexeddb"}});i("info","TonkCore created successfully"),I=o,i("info","Connecting to websocket",{wsUrl:I}),await E.connectWebsocket(I),i("info","Websocket connection established"),Z(),await X(E),i("info","PathIndex sync complete after initializeFromUrl"),g={status:"ready",tonk:E,manifest:p},i("info","Tonk state updated to ready from URL"),await Y(_),i("info","Bundle bytes persisted to IndexedDB"),l({type:"initializeFromUrl",id:n.id,success:!0})}catch(e){i("error","Failed to initialize from URL",{id:n.id,error:e instanceof Error?e.message:String(e)}),g={status:"failed",error:e},l({type:"initializeFromUrl",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"initializeFromBytes":i("info","Initializing from bytes",{id:n.id,byteLength:n.bundleBytes.byteLength,serverUrl:n.serverUrl,wsUrl:n.wsUrl});try{const e=n.serverUrl||"http://localhost:8081",r=n.wsUrl||e.replace(/^http/,"ws");if(i("info","Using server URL",{serverUrl:e}),g.status==="uninitialized"){i("info","WASM not initialized, initializing now");const p=`${`${e}/tonk_core_bg.wasm`}?t=${Date.now()}`;i("info","Fetching WASM from",{cacheBustUrl:p}),await J({wasmPath:p}),i("info","WASM initialization completed for bytes loading")}const o=new Uint8Array(n.bundleBytes);i("info","Creating bundle from bytes",{byteLength:o.length});const s=await(await $.fromBytes(o)).getManifest();i("info","Bundle and manifest created successfully",{rootId:s.rootId}),i("info","Creating TonkCore from bundle bytes");const _=await T.fromBytes(o,{storage:{type:"indexeddb"}});i("info","TonkCore created successfully"),I=r,i("info","Connecting to websocket",{wsUrl:I}),I&&(await _.connectWebsocket(I),i("info","Websocket connection established"),Z(),await X(_),i("info","PathIndex sync complete after initializeFromBytes")),g={status:"ready",tonk:_,manifest:s},i("info","Tonk state updated to ready from bytes"),await Y(o),i("info","Bundle bytes persisted to IndexedDB"),l({type:"initializeFromBytes",id:n.id,success:!0})}catch(e){i("error","Failed to initialize from bytes",{id:n.id,error:e instanceof Error?e.message:String(e)}),g={status:"failed",error:e},l({type:"initializeFromBytes",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break}}self.addEventListener("message",async n=>{i("info","Raw message event received",{eventType:n.type,messageType:n.data?.type,hasData:!!n.data});try{await pe(n.data)}catch(t){i("error","Error handling message",{error:t instanceof Error?t.message:String(t)})}});i("info","VFS Service Worker started",{debugLogging:At});
