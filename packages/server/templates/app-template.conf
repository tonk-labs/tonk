# Nginx configuration template for custom bundle servers
# This file should be placed in bundle/server/app-${bundleName}.conf
#
# Placeholders:
# - ${port} - The port where the custom server is running
# - ${bundleName} - The name of the bundle
# - ${bundlePath} - The path to the bundle directory

server {
    listen 8080;
    server_name _;
    
    # Route API requests based on bundle name header
    location /api/ {
        # Only handle requests for this specific bundle
        if ($http_x_bundle_name != "${bundleName}") {
            return 404;
        }
        
        # Proxy to the custom server
        proxy_pass http://127.0.0.1:${port}/;
        
        # All proxy headers are already set globally in main config
        # But we can add bundle-specific headers here
        proxy_set_header X-Bundle-Name "${bundleName}";
        proxy_set_header X-Bundle-Path "${bundlePath}";
        
        # Preserve original request path structure
        # The /api prefix is kept in the forwarded request
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Path $uri;
        
        # Handle potential errors gracefully
        proxy_intercept_errors on;
        error_page 502 503 504 /50x.html;
    }
    
    # Health check endpoint for this bundle's custom server
    location /health/${bundleName} {
        proxy_pass http://127.0.0.1:${port}/health;
        
        # Health checks should be fast
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        
        # Don't cache health check responses
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # Error page for this bundle
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
} 