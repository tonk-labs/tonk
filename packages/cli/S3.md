# S3

For now to use this you need to setup S3 bucket and appropriate credentials. You can setup AWS using
`aws` cli.

> ⚠️ Make sure to customize environment variables before running the script.

```sh
export BUCKET_NAME=tonk-facts
export AWS_REGION=us-east-2
export IAM_USER=tonk_aws

# create bucket
aws s3 mb s3://$BUCKET_NAME --region $AWS_REGION --no-cli-pager

# set CORS policy
aws s3api put-bucket-cors --bucket $BUCKET_NAME --cors-configuration file://s3-cors.json --no-cli-pager

# create a user
aws iam create-user --user-name $IAM_USER --no-cli-pager

export AWS_POLICY=${IAM_USER}_policy

# create policy (uses envsubst to substitute BUCKET_NAME in s3-policy.json)
envsubst < s3-policy.json > /tmp/s3-policy.json
aws iam create-policy \
  --policy-name ${AWS_POLICY} \
  --policy-document file:///tmp/s3-policy.json \
  --no-cli-pager

# attach policy to user
aws iam attach-user-policy \
  --user-name $IAM_USER \
  --policy-arn arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):policy/${AWS_POLICY} \
  --no-cli-pager

# create access key
aws iam create-access-key --user-name $IAM_USER --no-cli-pager
```

## Environment setup for dialog

Once you have created the S3 bucket and IAM user, you can print the environment variables needed for
dialog:

```sh
export BUCKET_NAME=tonk-facts
export AWS_REGION=us-east-1
export IAM_USER=tonk_aws

aws iam list-access-keys --user-name $IAM_USER --no-cli-pager \
  --query 'AccessKeyMetadata[0].AccessKeyId' --output text | \
  xargs -I{} sh -c 'echo "R2S3_REGION=$AWS_REGION"; echo "R2S3_BUCKET=$BUCKET_NAME"; echo "R2S3_ACCESS_KEY_ID={}"'

echo "R2S3_SECRET_ACCESS_KEY=<from when you created the key>"
```

> ⚠️ The secret access key is only shown once when created. If you lost it, delete the old key and
> create a new one:

```sh
aws iam create-access-key --user-name $IAM_USER --no-cli-pager
```

You'll need that info to setup remote for the space

## Object expiry for test buckets

For test buckets, you can set a lifecycle rule to automatically delete objects after 1 day (minimum
allowed):

```sh
aws s3api put-bucket-lifecycle-configuration \
  --bucket $BUCKET_NAME \
  --lifecycle-configuration file://s3-lifecycle.json \
  --no-cli-pager
```
