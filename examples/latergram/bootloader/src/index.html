<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Opening portal...</title>
    <script>
      async function handleRedirect() {
        // Debug bundle contents first
        console.log("Bundle is ready! Check the service worker console logs to see available directories.")

        // Now redirect to test our React app
        const redirectPath = '/test-wasm-2/'
        if (redirectPath) {
          console.log("Redirecting to:", redirectPath, "in 3 seconds...")
          //await new Promise(resolve => setTimeout(resolve, 3000))
          // instead of a redirect here, we should just signify to the sw that we want to load the new page
          // window.location.href = redirectPath
          window.location.href = window.location.href
        }
      }
      
      (async () => {
        if ("serviceWorker" in navigator) {
          // If we already have a controller, we can redirect immediately
          if (navigator.serviceWorker.controller) {
            console.log("Service worker is already controlling the page")
            await handleRedirect()
          } else {
            // Otherwise wait for a controller
            navigator.serviceWorker
              .register("./service-worker-bundled.js", { type: "module" })
              .catch((err) => {
                console.log("ServiceWorker registration failed: ", err)
                document.body.innerHTML = `<h1>Trail-Runner proxy failed to load.</h1>
                <p>If you're on Firefox, check this <a href="https://caniuse.com/mdn-api_serviceworker_ecmascript_modules">link</a> for more information and if Firefox is green now, <a href="mailto:pvh@pvh.ca">email me</a>.</p>`
                handleRedirect()
              })
            console.log("Waiting for service worker to take control...")
            navigator.serviceWorker.addEventListener("controllerchange", async () => {
              console.log("Service worker now controlling the page")
              await handleRedirect()
            })
            try {await handleRedirect()}
            catch (error) {console.log(error)}

            await new Promise(resolve => setTimeout(resolve, 5000))
          }
        }
      })()
    </script>
  </head>
  <body>
    <h1>Trail-Runner: Booting...</h1>
    <p>Standby for control of service worker...</p>
  </body>
</html>
