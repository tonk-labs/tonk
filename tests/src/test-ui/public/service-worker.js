const ee="modulepreload",ne=function(n){return"/"+n},Tt={},et=function(t,e,r){let o=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),_=s?.nonce||s?.getAttribute("nonce");o=Promise.allSettled(e.map(f=>{if(f=ne(f),f in Tt)return;Tt[f]=!0;const S=f.endsWith(".css"),F=S?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${F}`))return;const p=document.createElement("link");if(p.rel=S?"stylesheet":ee,S||(p.as="script"),p.crossOrigin="",p.href=f,_&&p.setAttribute("nonce",_),document.head.appendChild(p),S)return new Promise((R,A)=>{p.addEventListener("load",R),p.addEventListener("error",()=>A(new Error(`Unable to preload CSS for ${f}`)))})}))}function c(s){const _=new Event("vite:preloadError",{cancelable:!0});if(_.payload=s,window.dispatchEvent(_),!_.defaultPrevented)throw s}return o.then(s=>{for(const _ of s||[])_.status==="rejected"&&c(_.reason);return t().catch(c)})};var Kt=function(n,t,e,r,o){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!o)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?n!==t||!o:!t.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?o.call(n,e):o?o.value=e:t.set(n,e),e},b=function(n,t,e,r){if(e==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?n!==t||!r:!t.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?r:e==="a"?r.call(n):r?r.value:t.get(n)},C,h;class ct extends Error{constructor(t,e){super(t),this.code=e,this.name="TonkError"}}class re extends ct{constructor(t){super(t,"CONNECTION_ERROR"),this.name="ConnectionError"}}class y extends ct{constructor(t){super(t,"FILESYSTEM_ERROR"),this.name="FileSystemError"}}class x extends ct{constructor(t){super(t,"BUNDLE_ERROR"),this.name="BundleError"}}class N{constructor(t){C.set(this,void 0),Kt(this,C,t,"f")}static async fromBytes(t,e){try{const{create_bundle_from_bytes:r}=e||await et(()=>Promise.resolve().then(()=>rt),void 0);return new N(r(t))}catch(r){throw new x(`Failed to create bundle from bytes: ${r}`)}}async getRootId(){try{return await b(this,C,"f").getRootId()}catch(t){throw new x(`Failed to get root ID: ${t}`)}}async get(t){try{const e=await b(this,C,"f").get(t);return e===null?null:e}catch(e){throw new x(`Failed to get key ${t}: ${e}`)}}async getPrefix(t){try{return(await b(this,C,"f").getPrefix(t)).map(r=>({key:r.key,value:r.value}))}catch(e){throw new x(`Failed to get prefix ${t}: ${e}`)}}async listKeys(){try{return await b(this,C,"f").listKeys()}catch(t){throw new x(`Failed to list keys: ${t}`)}}async getManifest(){try{return await b(this,C,"f").getManifest()}catch(t){throw new x(`Failed to retrieve manifest: ${t}`)}}async setManifest(t){try{await b(this,C,"f").setManifest(t)}catch(e){throw new x(`Failed to set manifest: ${e}`)}}async toBytes(){try{return await b(this,C,"f").toBytes()}catch(t){throw new x(`Failed to serialize bundle: ${t}`)}}free(){b(this,C,"f").free()}}C=new WeakMap;class T{constructor(t){h.set(this,void 0),Kt(this,h,t,"f")}static async create(t,e){const r=e||await et(()=>Promise.resolve().then(()=>rt),void 0);if(t?.peerId&&t?.storage){const{create_tonk_with_config:o}=r,c=await o(t.peerId,t.storage.type==="indexeddb");return new T(c)}else if(t?.peerId){const{create_tonk_with_peer_id:o}=r,c=await o(t.peerId);return new T(c)}else if(t?.storage){const{create_tonk_with_storage:o}=r,c=await o(t.storage.type==="indexeddb");return new T(c)}else{const{create_tonk:o}=r,c=await o();return new T(c)}}static async createWithPeerId(t,e){const{create_tonk_with_peer_id:r}=e||await et(()=>Promise.resolve().then(()=>rt),void 0),o=await r(t);return new T(o)}static async fromBundle(t,e,r){const o=r||await et(()=>Promise.resolve().then(()=>rt),void 0);if(e?.storage){const{create_tonk_from_bundle_with_storage:c}=o,s=await c(t,e.storage.type==="indexeddb");return new T(s)}else{const{create_tonk_from_bundle:c}=o,s=await c(t);return new T(s)}}static async fromBytes(t,e,r){const o=r||await et(()=>Promise.resolve().then(()=>rt),void 0);if(e?.storage){const{create_tonk_from_bytes_with_storage:c}=o,s=await c(t,e.storage.type==="indexeddb");return new T(s)}else{const{create_tonk_from_bytes:c}=o,s=await c(t);return new T(s)}}getPeerId(){return b(this,h,"f").getPeerId()}async connectWebsocket(t){try{await b(this,h,"f").connectWebsocket(t)}catch(e){throw new re(`Failed to connect to ${t}: ${e}`)}}async isConnected(){try{return await b(this,h,"f").isConnected()}catch(t){return console.error("🔌 [CORE-JS] isConnected() error:",t),!1}}async getConnectionState(){try{return await b(this,h,"f").getConnectionState()}catch(t){return console.error("📡 [CORE-JS] getConnectionState() error:",t),"failed:"+String(t)}}async forkToBytes(t){try{return await b(this,h,"f").forkToBytes(t)}catch(e){throw new ct(`Failed to serialize to bundle data: ${e}`)}}async toBytes(t){try{return await b(this,h,"f").toBytes(t)}catch(e){throw new ct(`Failed to serialize to bundle data: ${e}`)}}async createFile(t,e){try{await b(this,h,"f").createFile(t,e)}catch(r){throw new y(`Failed to create file at ${t}: ${r}`)}}async createFileWithBytes(t,e,r){try{let o=typeof r=="string"?vt(r):r;await b(this,h,"f").createFileWithBytes(t,e,o)}catch(o){throw new y(`Failed to create file at ${t}: ${o}`)}}async readFile(t){try{const e=await b(this,h,"f").readFile(t);if(e===null)throw new y(`File not found: ${t}`);let r;return e.bytes&&(r=At(e.bytes)),{...e,content:JSON.parse(e.content),bytes:r}}catch(e){throw e instanceof y?e:new y(`Failed to read file at ${t}: ${e}`)}}async updateFile(t,e){try{return await b(this,h,"f").updateFile(t,e)}catch(r){throw new y(`Failed to update file at ${t}: ${r}`)}}async updateFileWithBytes(t,e,r){try{let o=typeof r=="string"?vt(r):r;return await b(this,h,"f").updateFileWithBytes(t,e,o)}catch(o){throw new y(`Failed to update file at ${t}: ${o}`)}}async deleteFile(t){try{return await b(this,h,"f").deleteFile(t)}catch(e){throw new y(`Failed to delete file at ${t}: ${e}`)}}async createDirectory(t){try{await b(this,h,"f").createDirectory(t)}catch(e){throw new y(`Failed to create directory at ${t}: ${e}`)}}async listDirectory(t){try{return(await b(this,h,"f").listDirectory(t)).map(r=>({name:r.name,type:r.type,timestamps:r.timestamps,pointer:r.pointer}))}catch(e){throw new y(`Failed to list directory at ${t}: ${e}`)}}async exists(t){try{return await b(this,h,"f").exists(t)}catch(e){throw new y(`Failed to check existence of ${t}: ${e}`)}}async rename(t,e){try{return await b(this,h,"f").rename(t,e)}catch(r){throw new y(`Failed to rename ${t} to ${e}: ${r}`)}}async getMetadata(t){try{const e=await b(this,h,"f").getMetadata(t);if(e===null)throw new y(`File or directory not found: ${t}`);return e}catch(e){throw e instanceof y?e:new y(`Failed to get metadata for ${t}: ${e}`)}}async watchFile(t,e){try{const r=await b(this,h,"f").watchDocument(t,o=>{let c;o.bytes&&(c=At(o.bytes)),e({...o,content:JSON.parse(o.content),bytes:c})});if(r===null)throw new y(`File not found: ${t}`);return r}catch(r){throw r instanceof y?r:new y(`Failed to watch file at path ${t}: ${r}`)}}async watchDirectory(t,e){try{const r=await b(this,h,"f").watchDirectory(t,e);if(r===null)throw new y(`Directory not found: ${t}`);return r}catch(r){throw r instanceof y?r:new y(`Failed to watch directory at path ${t}: ${r}`)}}free(){b(this,h,"f").free()}}h=new WeakMap;const vt=n=>{const t=atob(n),e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e},At=n=>{if(typeof n=="string")return n;if(Array.isArray(n)){let e="";for(let r=0;r<n.length;r+=8192){const o=n.slice(r,r+8192);e+=String.fromCharCode(...o)}return btoa(e)}else throw new y(`Unrecognized bytes type in readFile ${typeof n}`)};let i,nt=null;function q(){return(nt===null||nt.byteLength===0)&&(nt=new Uint8Array(i.memory.buffer)),nt}let _t=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});_t.decode();const oe=2146435072;let ut=0;function ie(n,t){return ut+=t,ut>=oe&&(_t=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),_t.decode(),ut=t),_t.decode(q().subarray(n,n+t))}function g(n,t){return n=n>>>0,ie(n,t)}let u=0;const it=new TextEncoder;"encodeInto"in it||(it.encodeInto=function(n,t){const e=it.encode(n);return t.set(e),{read:n.length,written:e.length}});function w(n,t,e){if(e===void 0){const _=it.encode(n),f=t(_.length,1)>>>0;return q().subarray(f,f+_.length).set(_),u=_.length,f}let r=n.length,o=t(r,1)>>>0;const c=q();let s=0;for(;s<r;s++){const _=n.charCodeAt(s);if(_>127)break;c[o+s]=_}if(s!==r){s!==0&&(n=n.slice(s)),o=e(o,r,r=s+n.length*3,1)>>>0;const _=q().subarray(o+s,o+r),f=it.encodeInto(n,_);s+=f.written,o=e(o,r,s,1)>>>0}return u=s,o}let M=null;function k(){return(M===null||M.buffer.detached===!0||M.buffer.detached===void 0&&M.buffer!==i.memory.buffer)&&(M=new DataView(i.memory.buffer)),M}function U(n){const t=i.__externref_table_alloc();return i.__wbindgen_export_4.set(t,n),t}function d(n,t){try{return n.apply(this,t)}catch(e){const r=U(e);i.__wbindgen_exn_store(r)}}function I(n){return n==null}function st(n,t){return n=n>>>0,q().subarray(n/1,n/1+t)}function pt(n){const t=typeof n;if(t=="number"||t=="boolean"||n==null)return`${n}`;if(t=="string")return`"${n}"`;if(t=="symbol"){const o=n.description;return o==null?"Symbol":`Symbol(${o})`}if(t=="function"){const o=n.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(n)){const o=n.length;let c="[";o>0&&(c+=pt(n[0]));for(let s=1;s<o;s++)c+=", "+pt(n[s]);return c+="]",c}const e=/\[object ([^\]]+)\]/.exec(toString.call(n));let r;if(e&&e.length>1)r=e[1];else return toString.call(n);if(r=="Object")try{return"Object("+JSON.stringify(n)+")"}catch{return"Object"}return n instanceof Error?`${n.name}: ${n.message}
${n.stack}`:r}const Pt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>{i.__wbindgen_export_6.get(n.dtor)(n.a,n.b)});function O(n,t,e,r){const o={a:n,b:t,cnt:1,dtor:e},c=(...s)=>{o.cnt++;const _=o.a;o.a=0;try{return r(_,o.b,...s)}finally{--o.cnt===0?(i.__wbindgen_export_6.get(o.dtor)(_,o.b),Pt.unregister(o)):o.a=_}};return c.original=o,Pt.register(c,o,o),c}function $(n){const t=i.__wbindgen_export_4.get(n);return i.__externref_table_dealloc(n),t}function Bt(n,t){if(!(n instanceof t))throw new Error(`expected instance of ${t.name}`)}function Ct(n,t){const e=t(n.length*1,1)>>>0;return q().set(n,e/1),u=n.length,e}function ae(){i.init()}function ce(){return i.create_tonk()}function se(n){const t=i.create_bundle_from_bytes(n);if(t[2])throw $(t[1]);return D.__wrap(t[0])}function _e(n){return i.create_tonk_from_bytes(n)}function le(n){const t=w(n,i.__wbindgen_malloc,i.__wbindgen_realloc),e=u;return i.create_tonk_with_peer_id(t,e)}function fe(n){return i.create_tonk_with_storage(n)}function ue(n,t){return Bt(n,D),i.create_tonk_from_bundle_with_storage(n.__wbg_ptr,t)}function de(n){return Bt(n,D),i.create_tonk_from_bundle(n.__wbg_ptr)}function we(n,t){return i.create_tonk_from_bytes_with_storage(n,t)}function be(n,t){const e=w(n,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.create_tonk_with_config(e,r,t)}function ge(n){i.set_time_provider(n)}function he(n,t){i.wasm_bindgen__convert__closures_____invoke__hebf85c734a100b68(n,t)}function dt(n,t,e){i.closure769_externref_shim(n,t,e)}function pe(n,t,e){const r=i.closure772_externref_shim_multivalue_shim(n,t,e);if(r[1])throw $(r[0])}function ye(n,t,e){i.closure990_externref_shim(n,t,e)}function me(n,t,e){i.closure1017_externref_shim(n,t,e)}function ke(n,t,e,r){i.closure1266_externref_shim(n,t,e,r)}const Se=["blob","arraybuffer"],Ee=["pending","done"],Fe=["readonly","readwrite","versionchange","readwriteflush","cleanup"],Ut=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>i.__wbg_wasmbundle_free(n>>>0,1));class D{static __wrap(t){t=t>>>0;const e=Object.create(D.prototype);return e.__wbg_ptr=t,Ut.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Ut.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_wasmbundle_free(t,0)}static fromBytes(t){const e=i.wasmbundle_fromBytes(t);if(e[2])throw $(e[1]);return D.__wrap(e[0])}getPrefix(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmbundle_getPrefix(this.__wbg_ptr,e,r)}getRootId(){return i.wasmbundle_getRootId(this.__wbg_ptr)}getManifest(){return i.wasmbundle_getManifest(this.__wbg_ptr)}setManifest(t){return i.wasmbundle_setManifest(this.__wbg_ptr,t)}get(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmbundle_get(this.__wbg_ptr,e,r)}toBytes(){return i.wasmbundle_toBytes(this.__wbg_ptr)}listKeys(){return i.wasmbundle_listKeys(this.__wbg_ptr)}}Symbol.dispose&&(D.prototype[Symbol.dispose]=D.prototype.free);const Wt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>i.__wbg_wasmdochandle_free(n>>>0,1));class K{static __wrap(t){t=t>>>0;const e=Object.create(K.prototype);return e.__wbg_ptr=t,Wt.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Wt.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_wasmdochandle_free(t,0)}documentId(){let t,e;try{const r=i.wasmdochandle_documentId(this.__wbg_ptr);return t=r[0],e=r[1],g(r[0],r[1])}finally{i.__wbindgen_free(t,e,1)}}getDocument(){const t=i.wasmdochandle_getDocument(this.__wbg_ptr);if(t[2])throw $(t[1]);return $(t[0])}url(){let t,e;try{const r=i.wasmdochandle_url(this.__wbg_ptr);return t=r[0],e=r[1],g(r[0],r[1])}finally{i.__wbindgen_free(t,e,1)}}}Symbol.dispose&&(K.prototype[Symbol.dispose]=K.prototype.free);const Dt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>i.__wbg_wasmdocumentwatcher_free(n>>>0,1));class G{static __wrap(t){t=t>>>0;const e=Object.create(G.prototype);return e.__wbg_ptr=t,Dt.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Dt.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_wasmdocumentwatcher_free(t,0)}documentId(){let t,e;try{const r=i.wasmdocumentwatcher_documentId(this.__wbg_ptr);return t=r[0],e=r[1],g(r[0],r[1])}finally{i.__wbindgen_free(t,e,1)}}stop(){return i.wasmdocumentwatcher_stop(this.__wbg_ptr)}}Symbol.dispose&&(G.prototype[Symbol.dispose]=G.prototype.free);const zt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>i.__wbg_wasmerror_free(n>>>0,1));class H{static __wrap(t){t=t>>>0;const e=Object.create(H.prototype);return e.__wbg_ptr=t,zt.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,zt.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_wasmerror_free(t,0)}get message(){let t,e;try{const r=i.wasmerror_message(this.__wbg_ptr);return t=r[0],e=r[1],g(r[0],r[1])}finally{i.__wbindgen_free(t,e,1)}}}Symbol.dispose&&(H.prototype[Symbol.dispose]=H.prototype.free);const xt=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>i.__wbg_wasmrepo_free(n>>>0,1));class J{static __wrap(t){t=t>>>0;const e=Object.create(J.prototype);return e.__wbg_ptr=t,xt.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,xt.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_wasmrepo_free(t,0)}findDocument(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmrepo_findDocument(this.__wbg_ptr,e,r)}listDocuments(){const t=i.wasmrepo_listDocuments(this.__wbg_ptr);if(t[2])throw $(t[1]);return $(t[0])}createDocument(t){return i.wasmrepo_createDocument(this.__wbg_ptr,t)}connectWebSocket(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u,o=i.wasmrepo_connectWebSocket(this.__wbg_ptr,e,r);if(o[2])throw $(o[1]);return Y.__wrap(o[0])}connectWebSocketAsync(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmrepo_connectWebSocketAsync(this.__wbg_ptr,e,r)}constructor(){return i.wasmrepo_new()}stop(){return i.wasmrepo_stop(this.__wbg_ptr)}peerId(){let t,e;try{const r=i.wasmrepo_peerId(this.__wbg_ptr);return t=r[0],e=r[1],g(r[0],r[1])}finally{i.__wbindgen_free(t,e,1)}}}Symbol.dispose&&(J.prototype[Symbol.dispose]=J.prototype.free);const $t=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>i.__wbg_wasmtonkcore_free(n>>>0,1));class Q{static __wrap(t){t=t>>>0;const e=Object.create(Q.prototype);return e.__wbg_ptr=t,$t.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,$t.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_wasmtonkcore_free(t,0)}static fromBytes(t){return i.wasmtonkcore_fromBytes(t)}createFile(t,e){const r=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),o=u;return i.wasmtonkcore_createFile(this.__wbg_ptr,r,o,e)}deleteFile(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmtonkcore_deleteFile(this.__wbg_ptr,e,r)}static fromBundle(t){return Bt(t,D),i.wasmtonkcore_fromBundle(t.__wbg_ptr)}getPeerId(){return i.wasmtonkcore_getPeerId(this.__wbg_ptr)}updateFile(t,e){const r=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),o=u;return i.wasmtonkcore_updateFile(this.__wbg_ptr,r,o,e)}getMetadata(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmtonkcore_getMetadata(this.__wbg_ptr,e,r)}isConnected(){return i.wasmtonkcore_isConnected(this.__wbg_ptr)}static withPeerId(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmtonkcore_withPeerId(e,r)}forkToBytes(t){return i.wasmtonkcore_forkToBytes(this.__wbg_ptr,t)}listDirectory(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmtonkcore_listDirectory(this.__wbg_ptr,e,r)}watchDocument(t,e){const r=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),o=u;return i.wasmtonkcore_watchDocument(this.__wbg_ptr,r,o,e)}watchDirectory(t,e){const r=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),o=u;return i.wasmtonkcore_watchDirectory(this.__wbg_ptr,r,o,e)}createDirectory(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmtonkcore_createDirectory(this.__wbg_ptr,e,r)}connectWebsocket(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmtonkcore_connectWebsocket(this.__wbg_ptr,e,r)}getConnectionState(){return i.wasmtonkcore_getConnectionState(this.__wbg_ptr)}createFileWithBytes(t,e,r){const o=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),c=u,s=Ct(r,i.__wbindgen_malloc),_=u;return i.wasmtonkcore_createFileWithBytes(this.__wbg_ptr,o,c,e,s,_)}updateFileWithBytes(t,e,r){const o=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),c=u,s=Ct(r,i.__wbindgen_malloc),_=u;return i.wasmtonkcore_updateFileWithBytes(this.__wbg_ptr,o,c,e,s,_)}constructor(){return i.wasmtonkcore_new()}exists(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmtonkcore_exists(this.__wbg_ptr,e,r)}rename(t,e){const r=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),o=u,c=w(e,i.__wbindgen_malloc,i.__wbindgen_realloc),s=u;return i.wasmtonkcore_rename(this.__wbg_ptr,r,o,c,s)}toBytes(t){return i.wasmtonkcore_toBytes(this.__wbg_ptr,t)}readFile(t){const e=w(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=u;return i.wasmtonkcore_readFile(this.__wbg_ptr,e,r)}}Symbol.dispose&&(Q.prototype[Symbol.dispose]=Q.prototype.free);const Ot=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>i.__wbg_wasmwebsockethandle_free(n>>>0,1));class Y{static __wrap(t){t=t>>>0;const e=Object.create(Y.prototype);return e.__wbg_ptr=t,Ot.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Ot.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_wasmwebsockethandle_free(t,0)}waitForDisconnect(){return i.wasmwebsockethandle_waitForDisconnect(this.__wbg_ptr)}close(){i.wasmwebsockethandle_close(this.__wbg_ptr)}}Symbol.dispose&&(Y.prototype[Symbol.dispose]=Y.prototype.free);const Ie=new Set(["basic","cors","default"]);async function Re(n,t){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,t)}catch(r){if(n.ok&&Ie.has(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const e=await n.arrayBuffer();return await WebAssembly.instantiate(e,t)}else{const e=await WebAssembly.instantiate(n,t);return e instanceof WebAssembly.Instance?{instance:e,module:n}:e}}function Gt(){const n={};return n.wbg={},n.wbg.__wbg_Error_e17e777aac105295=function(t,e){return Error(g(t,e))},n.wbg.__wbg_String_8f0eb39a4a4c2f66=function(t,e){const r=String(e),o=w(r,i.__wbindgen_malloc,i.__wbindgen_realloc),c=u;k().setInt32(t+4*1,c,!0),k().setInt32(t+4*0,o,!0)},n.wbg.__wbg_Window_41559019033ede94=function(t){return t.Window},n.wbg.__wbg_WorkerGlobalScope_d324bffbeaef9f3a=function(t){return t.WorkerGlobalScope},n.wbg.__wbg_abort_48fad284f76f23cd=function(){return d(function(t){t.abort()},arguments)},n.wbg.__wbg_bound_99d0883606949696=function(){return d(function(t,e,r,o){return IDBKeyRange.bound(t,e,r!==0,o!==0)},arguments)},n.wbg.__wbg_buffer_8d40b1d762fb3c66=function(t){return t.buffer},n.wbg.__wbg_call_13410aac570ffff7=function(){return d(function(t,e){return t.call(e)},arguments)},n.wbg.__wbg_call_a5400b25a865cfd8=function(){return d(function(t,e,r){return t.call(e,r)},arguments)},n.wbg.__wbg_close_6437264570d2d37f=function(){return d(function(t){t.close()},arguments)},n.wbg.__wbg_commit_a54edce65f3858f2=function(){return d(function(t){t.commit()},arguments)},n.wbg.__wbg_continue_f3937b9af363e05d=function(){return d(function(t){t.continue()},arguments)},n.wbg.__wbg_createObjectStore_2bc52da689ca2130=function(){return d(function(t,e,r){return t.createObjectStore(g(e,r))},arguments)},n.wbg.__wbg_data_9ab529722bcc4e6c=function(t){return t.data},n.wbg.__wbg_delete_33e805b6d49fa644=function(){return d(function(t,e){return t.delete(e)},arguments)},n.wbg.__wbg_done_75ed0ee6dd243d9d=function(t){return t.done},n.wbg.__wbg_entries_2be2f15bd5554996=function(t){return Object.entries(t)},n.wbg.__wbg_error_118f1b830b6ccf22=function(){return d(function(t){const e=t.error;return I(e)?0:U(e)},arguments)},n.wbg.__wbg_error_31d7961b8e0d3f6c=function(t,e){console.error(g(t,e))},n.wbg.__wbg_error_7534b8e9a36f1ab4=function(t,e){let r,o;try{r=t,o=e,console.error(g(t,e))}finally{i.__wbindgen_free(r,o,1)}},n.wbg.__wbg_error_99981e16d476aa5c=function(t){console.error(t)},n.wbg.__wbg_from_88bc52ce20ba6318=function(t){return Array.from(t)},n.wbg.__wbg_getRandomValues_3c9c0d586e575a16=function(){return d(function(t,e){globalThis.crypto.getRandomValues(st(t,e))},arguments)},n.wbg.__wbg_getTime_6bb3f64e0f18f817=function(t){return t.getTime()},n.wbg.__wbg_get_0da715ceaecea5c8=function(t,e){return t[e>>>0]},n.wbg.__wbg_get_1b2c33a63c4be73f=function(){return d(function(t,e){return t.get(e)},arguments)},n.wbg.__wbg_get_458e874b43b18b25=function(){return d(function(t,e){return Reflect.get(t,e)},arguments)},n.wbg.__wbg_getwithrefkey_1dc361bd10053bfe=function(t,e){return t[e]},n.wbg.__wbg_global_f5c2926e57ba457f=function(t){return t.global},n.wbg.__wbg_indexedDB_003e3d885edf75fc=function(){return d(function(t){const e=t.indexedDB;return I(e)?0:U(e)},arguments)},n.wbg.__wbg_indexedDB_1956995e4297311c=function(){return d(function(t){const e=t.indexedDB;return I(e)?0:U(e)},arguments)},n.wbg.__wbg_indexedDB_54f01430b1e194e8=function(){return d(function(t){const e=t.indexedDB;return I(e)?0:U(e)},arguments)},n.wbg.__wbg_instanceof_ArrayBuffer_67f3012529f6a2dd=function(t){let e;try{e=t instanceof ArrayBuffer}catch{e=!1}return e},n.wbg.__wbg_instanceof_CursorSys_4b6a8aba0e823e75=function(t){let e;try{e=t instanceof IDBCursorWithValue}catch{e=!1}return e},n.wbg.__wbg_instanceof_DomException_bd63c2a0e0b53ed5=function(t){let e;try{e=t instanceof DOMException}catch{e=!1}return e},n.wbg.__wbg_instanceof_Error_76149ae9b431750e=function(t){let e;try{e=t instanceof Error}catch{e=!1}return e},n.wbg.__wbg_instanceof_IdbCursor_2d6e2a2a3b9fb015=function(t){let e;try{e=t instanceof IDBCursor}catch{e=!1}return e},n.wbg.__wbg_instanceof_IdbDatabase_6e6efef94c4a355d=function(t){let e;try{e=t instanceof IDBDatabase}catch{e=!1}return e},n.wbg.__wbg_instanceof_IdbRequest_a4a68ff63181a915=function(t){let e;try{e=t instanceof IDBRequest}catch{e=!1}return e},n.wbg.__wbg_instanceof_Map_ebb01a5b6b5ffd0b=function(t){let e;try{e=t instanceof Map}catch{e=!1}return e},n.wbg.__wbg_instanceof_Uint8Array_9a8378d955933db7=function(t){let e;try{e=t instanceof Uint8Array}catch{e=!1}return e},n.wbg.__wbg_isArray_030cce220591fb41=function(t){return Array.isArray(t)},n.wbg.__wbg_isSafeInteger_1c0d1af5542e102a=function(t){return Number.isSafeInteger(t)},n.wbg.__wbg_item_dc4321784299a463=function(t,e,r){const o=e.item(r>>>0);var c=I(o)?0:w(o,i.__wbindgen_malloc,i.__wbindgen_realloc),s=u;k().setInt32(t+4*1,s,!0),k().setInt32(t+4*0,c,!0)},n.wbg.__wbg_iterator_f370b34483c71a1c=function(){return Symbol.iterator},n.wbg.__wbg_key_4c46cfeacd2dbc18=function(){return d(function(t){return t.key},arguments)},n.wbg.__wbg_keys_ef52390b2ae0e714=function(t){return Object.keys(t)},n.wbg.__wbg_length_186546c51cd61acd=function(t){return t.length},n.wbg.__wbg_length_6bb7e81f9d7713e4=function(t){return t.length},n.wbg.__wbg_log_0cc1b7768397bcfe=function(t,e,r,o,c,s,_,f){let S,F;try{S=t,F=e,console.log(g(t,e),g(r,o),g(c,s),g(_,f))}finally{i.__wbindgen_free(S,F,1)}},n.wbg.__wbg_log_6c7b5f4f00b8ce3f=function(t){console.log(t)},n.wbg.__wbg_log_cb9e190acc5753fb=function(t,e){let r,o;try{r=t,o=e,console.log(g(t,e))}finally{i.__wbindgen_free(r,o,1)}},n.wbg.__wbg_lowerBound_5a50c0a9f6e7db91=function(){return d(function(t,e){return IDBKeyRange.lowerBound(t,e!==0)},arguments)},n.wbg.__wbg_mark_7438147ce31e9d4b=function(t,e){performance.mark(g(t,e))},n.wbg.__wbg_measure_fb7825c11612c823=function(){return d(function(t,e,r,o){let c,s,_,f;try{c=t,s=e,_=r,f=o,performance.measure(g(t,e),g(r,o))}finally{i.__wbindgen_free(c,s,1),i.__wbindgen_free(_,f,1)}},arguments)},n.wbg.__wbg_message_125a1b2998b3552a=function(t){return t.message},n.wbg.__wbg_message_5481231e71ccaf7b=function(t,e){const r=e.message,o=w(r,i.__wbindgen_malloc,i.__wbindgen_realloc),c=u;k().setInt32(t+4*1,c,!0),k().setInt32(t+4*0,o,!0)},n.wbg.__wbg_message_702ebc62fa8b0c7c=function(t,e){const r=e.message,o=w(r,i.__wbindgen_malloc,i.__wbindgen_realloc),c=u;k().setInt32(t+4*1,c,!0),k().setInt32(t+4*0,o,!0)},n.wbg.__wbg_name_f75f535832c8ea6b=function(t,e){const r=e.name,o=w(r,i.__wbindgen_malloc,i.__wbindgen_realloc),c=u;k().setInt32(t+4*1,c,!0),k().setInt32(t+4*0,o,!0)},n.wbg.__wbg_new0_b0a0a38c201e6df5=function(){return new Date},n.wbg.__wbg_new_19c25a3f2fa63a02=function(){return new Object},n.wbg.__wbg_new_1f3a344cf3123716=function(){return new Array},n.wbg.__wbg_new_2e3c58a15f39f5f9=function(t,e){try{var r={a:t,b:e},o=(s,_)=>{const f=r.a;r.a=0;try{return ke(f,r.b,s,_)}finally{r.a=f}};return new Promise(o)}finally{r.a=r.b=0}},n.wbg.__wbg_new_2ff1f68f3676ea53=function(){return new Map},n.wbg.__wbg_new_638ebfaedbf32a5e=function(t){return new Uint8Array(t)},n.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},n.wbg.__wbg_new_da9dc54c5db29dfa=function(t,e){return new Error(g(t,e))},n.wbg.__wbg_new_e213f63d18b0de01=function(){return d(function(t,e){return new WebSocket(g(t,e))},arguments)},n.wbg.__wbg_newfromslice_074c56947bd43469=function(t,e){return new Uint8Array(st(t,e))},n.wbg.__wbg_newnoargs_254190557c45b4ec=function(t,e){return new Function(g(t,e))},n.wbg.__wbg_newwithlength_a167dcc7aaa3ba77=function(t){return new Uint8Array(t>>>0)},n.wbg.__wbg_next_5b3530e612fde77d=function(t){return t.next},n.wbg.__wbg_next_692e82279131b03c=function(){return d(function(t){return t.next()},arguments)},n.wbg.__wbg_now_1e80617bcee43265=function(){return Date.now()},n.wbg.__wbg_objectStoreNames_31ac72154caf5a01=function(t){return t.objectStoreNames},n.wbg.__wbg_objectStore_b2a5b80b2e5c5f8b=function(){return d(function(t,e,r){return t.objectStore(g(e,r))},arguments)},n.wbg.__wbg_openCursor_2a1cca3c492dd5ec=function(){return d(function(t){return t.openCursor()},arguments)},n.wbg.__wbg_open_7281831ed8ff7bd2=function(){return d(function(t,e,r,o){return t.open(g(e,r),o>>>0)},arguments)},n.wbg.__wbg_prototypesetcall_3d4a26c1ed734349=function(t,e,r){Uint8Array.prototype.set.call(st(t,e),r)},n.wbg.__wbg_push_330b2eb93e4e1212=function(t,e){return t.push(e)},n.wbg.__wbg_put_cdfadd5d7f714201=function(){return d(function(t,e,r){return t.put(e,r)},arguments)},n.wbg.__wbg_queueMicrotask_25d0739ac89e8c88=function(t){queueMicrotask(t)},n.wbg.__wbg_queueMicrotask_4488407636f5bf24=function(t){return t.queueMicrotask},n.wbg.__wbg_readyState_a2853902a50c6d54=function(t){const e=t.readyState;return(Ee.indexOf(e)+1||3)-1},n.wbg.__wbg_request_5079471e06223120=function(t){return t.request},n.wbg.__wbg_request_fada8c23b78b3a02=function(t){return t.request},n.wbg.__wbg_resolve_4055c623acdd6a1b=function(t){return Promise.resolve(t)},n.wbg.__wbg_result_825a6aeeb31189d2=function(){return d(function(t){return t.result},arguments)},n.wbg.__wbg_send_0f09f4487d932d86=function(){return d(function(t,e){t.send(e)},arguments)},n.wbg.__wbg_set_1353b2a5e96bc48c=function(t,e,r){t.set(st(e,r))},n.wbg.__wbg_set_3f1d0b984ed272ed=function(t,e,r){t[e]=r},n.wbg.__wbg_set_453345bcda80b89a=function(){return d(function(t,e,r){return Reflect.set(t,e,r)},arguments)},n.wbg.__wbg_set_90f6c0f7bd8c0415=function(t,e,r){t[e>>>0]=r},n.wbg.__wbg_set_b7f1cf4fae26fe2a=function(t,e,r){return t.set(e,r)},n.wbg.__wbg_setbinaryType_37f3cd35d7775a47=function(t,e){t.binaryType=Se[e]},n.wbg.__wbg_setonabort_4edac498cf4576fe=function(t,e){t.onabort=e},n.wbg.__wbg_setonclose_159c0332c2d91b09=function(t,e){t.onclose=e},n.wbg.__wbg_setoncomplete_8a32ad2d1ca4f49b=function(t,e){t.oncomplete=e},n.wbg.__wbg_setonerror_4b0c685c365f600d=function(t,e){t.onerror=e},n.wbg.__wbg_setonerror_5d9bff045f909e89=function(t,e){t.onerror=e},n.wbg.__wbg_setonerror_bcdbd7f3921ffb1f=function(t,e){t.onerror=e},n.wbg.__wbg_setonmessage_5e486f326638a9da=function(t,e){t.onmessage=e},n.wbg.__wbg_setonopen_3e43af381c2901f8=function(t,e){t.onopen=e},n.wbg.__wbg_setonsuccess_ffb2ddb27ce681d8=function(t,e){t.onsuccess=e},n.wbg.__wbg_setonupgradeneeded_4e32d1c6a08c4257=function(t,e){t.onupgradeneeded=e},n.wbg.__wbg_stack_0ed75d68575b0f3c=function(t,e){const r=e.stack,o=w(r,i.__wbindgen_malloc,i.__wbindgen_realloc),c=u;k().setInt32(t+4*1,c,!0),k().setInt32(t+4*0,o,!0)},n.wbg.__wbg_static_accessor_GLOBAL_8921f820c2ce3f12=function(){const t=typeof globalThis>"u"?null:globalThis;return I(t)?0:U(t)},n.wbg.__wbg_static_accessor_GLOBAL_THIS_f0a4409105898184=function(){const t=typeof globalThis>"u"?null:globalThis;return I(t)?0:U(t)},n.wbg.__wbg_static_accessor_SELF_995b214ae681ff99=function(){const t=typeof self>"u"?null:self;return I(t)?0:U(t)},n.wbg.__wbg_static_accessor_WINDOW_cde3890479c675ea=function(){const t=typeof window>"u"?null:window;return I(t)?0:U(t)},n.wbg.__wbg_target_f2c963b447be6283=function(t){const e=t.target;return I(e)?0:U(e)},n.wbg.__wbg_then_b33a773d723afa3e=function(t,e,r){return t.then(e,r)},n.wbg.__wbg_then_e22500defe16819f=function(t,e){return t.then(e)},n.wbg.__wbg_toString_78df35411a4fd40c=function(t){return t.toString()},n.wbg.__wbg_transaction_553a104dd139f032=function(){return d(function(t,e,r,o){return t.transaction(g(e,r),Fe[o])},arguments)},n.wbg.__wbg_transaction_b51dc7b903eb86c1=function(t){return t.transaction},n.wbg.__wbg_upperBound_884e6dbf6030d98b=function(){return d(function(t,e){return IDBKeyRange.upperBound(t,e!==0)},arguments)},n.wbg.__wbg_value_809430714c127bb5=function(){return d(function(t){return t.value},arguments)},n.wbg.__wbg_value_dd9372230531eade=function(t){return t.value},n.wbg.__wbg_wasmdochandle_new=function(t){return K.__wrap(t)},n.wbg.__wbg_wasmdocumentwatcher_new=function(t){return G.__wrap(t)},n.wbg.__wbg_wasmerror_new=function(t){return H.__wrap(t)},n.wbg.__wbg_wasmrepo_new=function(t){return J.__wrap(t)},n.wbg.__wbg_wasmtonkcore_new=function(t){return Q.__wrap(t)},n.wbg.__wbg_wbindgenbigintgetasi64_ac743ece6ab9bba1=function(t,e){const r=e,o=typeof r=="bigint"?r:void 0;k().setBigInt64(t+8*1,I(o)?BigInt(0):o,!0),k().setInt32(t+4*0,!I(o),!0)},n.wbg.__wbg_wbindgenbooleanget_3fe6f642c7d97746=function(t){const e=t,r=typeof e=="boolean"?e:void 0;return I(r)?16777215:r?1:0},n.wbg.__wbg_wbindgencbdrop_eb10308566512b88=function(t){const e=t.original;return e.cnt--==1?(e.a=0,!0):!1},n.wbg.__wbg_wbindgendebugstring_99ef257a3ddda34d=function(t,e){const r=pt(e),o=w(r,i.__wbindgen_malloc,i.__wbindgen_realloc),c=u;k().setInt32(t+4*1,c,!0),k().setInt32(t+4*0,o,!0)},n.wbg.__wbg_wbindgenin_d7a1ee10933d2d55=function(t,e){return t in e},n.wbg.__wbg_wbindgenisbigint_ecb90cc08a5a9154=function(t){return typeof t=="bigint"},n.wbg.__wbg_wbindgenisfunction_8cee7dce3725ae74=function(t){return typeof t=="function"},n.wbg.__wbg_wbindgenisnull_f3037694abe4d97a=function(t){return t===null},n.wbg.__wbg_wbindgenisobject_307a53c6bd97fbf8=function(t){const e=t;return typeof e=="object"&&e!==null},n.wbg.__wbg_wbindgenisstring_d4fa939789f003b0=function(t){return typeof t=="string"},n.wbg.__wbg_wbindgenisundefined_c4b71d073b92f3c5=function(t){return t===void 0},n.wbg.__wbg_wbindgenjsvaleq_e6f2ad59ccae1b58=function(t,e){return t===e},n.wbg.__wbg_wbindgenjsvallooseeq_9bec8c9be826bed1=function(t,e){return t==e},n.wbg.__wbg_wbindgennumberget_f74b4c7525ac05cb=function(t,e){const r=e,o=typeof r=="number"?r:void 0;k().setFloat64(t+8*1,I(o)?0:o,!0),k().setInt32(t+4*0,!I(o),!0)},n.wbg.__wbg_wbindgenstringget_0f16a6ddddef376f=function(t,e){const r=e,o=typeof r=="string"?r:void 0;var c=I(o)?0:w(o,i.__wbindgen_malloc,i.__wbindgen_realloc),s=u;k().setInt32(t+4*1,s,!0),k().setInt32(t+4*0,c,!0)},n.wbg.__wbg_wbindgenthrow_451ec1a8469d7eb6=function(t,e){throw new Error(g(t,e))},n.wbg.__wbindgen_cast_1b36288b9f4ae891=function(t,e){return O(t,e,989,he)},n.wbg.__wbindgen_cast_2241b6af4c4b2941=function(t,e){return g(t,e)},n.wbg.__wbindgen_cast_225691e997a55b03=function(t,e){return O(t,e,768,dt)},n.wbg.__wbindgen_cast_38585ec8b7a22336=function(t,e){return O(t,e,989,ye)},n.wbg.__wbindgen_cast_4625c577ab2ec9ee=function(t){return BigInt.asUintN(64,t)},n.wbg.__wbindgen_cast_47e541b17e78e8bd=function(t,e){return O(t,e,768,dt)},n.wbg.__wbindgen_cast_88727f4eea4b1ea5=function(t,e){return O(t,e,768,pe)},n.wbg.__wbindgen_cast_9a54668b0b80706c=function(t,e){return O(t,e,1016,me)},n.wbg.__wbindgen_cast_9ae0607507abb057=function(t){return t},n.wbg.__wbindgen_cast_9c24d5d192fdc396=function(t,e){return O(t,e,768,dt)},n.wbg.__wbindgen_cast_d6cd19b81560fd6e=function(t){return t},n.wbg.__wbindgen_init_externref_table=function(){const t=i.__wbindgen_export_4,e=t.grow(4);t.set(0,void 0),t.set(e+0,void 0),t.set(e+1,null),t.set(e+2,!0),t.set(e+3,!1)},n}function Ht(n,t){return i=n.exports,lt.__wbindgen_wasm_module=t,M=null,nt=null,i.__wbindgen_start(),i}function Be(n){if(i!==void 0)return i;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module:n}=n:console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));const t=Gt();n instanceof WebAssembly.Module||(n=new WebAssembly.Module(n));const e=new WebAssembly.Instance(n,t);return Ht(e,n)}async function lt(n){if(i!==void 0)return i;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof n>"u"&&(n=new URL("/assets/tonk_core_bg-Ct7UlwJv.wasm",import.meta.url));const t=Gt();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:e,module:r}=await Re(await n,t);return Ht(e,r)}const rt=Object.freeze(Object.defineProperty({__proto__:null,WasmBundle:D,WasmDocHandle:K,WasmDocumentWatcher:G,WasmError:H,WasmRepo:J,WasmTonkCore:Q,WasmWebSocketHandle:Y,create_bundle_from_bytes:se,create_tonk:ce,create_tonk_from_bundle:de,create_tonk_from_bundle_with_storage:ue,create_tonk_from_bytes:_e,create_tonk_from_bytes_with_storage:we,create_tonk_with_config:be,create_tonk_with_peer_id:le,create_tonk_with_storage:fe,default:lt,init:ae,initSync:Be,set_time_provider:ge},Symbol.toStringTag,{value:"Module"}));let Mt=!1,tt=null;async function yt(n){if(!Mt)return tt||(tt=(async()=>{try{n?.wasmPath?await lt(n.wasmPath):await lt(),Mt=!0}catch(t){throw tt=null,t}})(),tt)}const Jt=!0;console.log("🚀 SERVICE WORKER: Script loaded at",new Date().toISOString());console.log("🔍 DEBUG_LOGGING enabled:",Jt);console.log("🌐 Service worker location:",self.location.href);console.log("UNIQUE ID:",779);let m={status:"uninitialized"},E=null,X=!1,wt=null,j=null,at=!1,V=!1,bt=null,L=null,v=null,gt=null,ot=!0,W=0;const Lt=10,jt=5e3;let z=[],ht=!1;const Te=10;function B(){return m.status==="ready"?m:null}const Z="tonk-sw-state-v1",mt="/tonk-state/appSlug",kt="/tonk-state/bundleBytes",St="/tonk-state/serverUrl";async function Qt(n){try{const t=await caches.open(Z);if(n===null)await t.delete(mt);else{const e=new Response(JSON.stringify({slug:n}),{headers:{"Content-Type":"application/json"}});await t.put(mt,e)}a("info","AppSlug persisted to cache",{slug:n})}catch(t){a("error","Failed to persist appSlug",{error:t instanceof Error?t.message:String(t)})}}async function ve(){try{const t=await(await caches.open(Z)).match(mt);return t&&(await t.json()).slug||null}catch(n){return a("error","Failed to restore appSlug",{error:n instanceof Error?n.message:String(n)}),null}}async function Et(n){try{const t=await caches.open(Z);if(n===null)await t.delete(kt);else{const e=new Blob([n],{type:"application/octet-stream"}),r=new Response(e,{headers:{"Content-Type":"application/octet-stream"}});await t.put(kt,r)}a("info","Bundle bytes persisted to cache",{size:n?n.length:0})}catch(t){a("error","Failed to persist bundle bytes",{error:t instanceof Error?t.message:String(t)})}}async function Ae(){try{const t=await(await caches.open(Z)).match(kt);if(!t)return null;const e=await t.arrayBuffer();return new Uint8Array(e)}catch(n){return a("error","Failed to restore bundle bytes",{error:n instanceof Error?n.message:String(n)}),null}}async function Ft(n){try{const t=await caches.open(Z);if(n===null)await t.delete(St);else{const e=new Response(JSON.stringify({serverUrl:n}),{headers:{"Content-Type":"application/json"}});await t.put(St,e)}a("info","Server URL persisted to cache",{serverUrl:n})}catch(t){a("error","Failed to persist server URL",{error:t instanceof Error?t.message:String(t)})}}async function Pe(){try{const t=await(await caches.open(Z)).match(St);return t&&(await t.json()).serverUrl||null}catch(n){return a("error","Failed to restore server URL",{error:n instanceof Error?n.message:String(n)}),null}}function a(n,t,e){const o=`[VFS Service Worker ${new Date().toISOString()}] ${n.toUpperCase()}:`;e!==void 0?console[n](o,t,e):console[n](o,t)}const P=new Map;async function l(n){a("info","Posting response to main thread",{type:n.type,success:"success"in n?n.success:"N/A"}),(await self.clients.matchAll()).forEach(e=>{e.postMessage(n)})}async function Nt(n){const t=await self.clients.matchAll();t.forEach(e=>e.postMessage(n)),a("info","Broadcast message to clients",{type:n.type,clientCount:t.length})}async function Ce(n=3e4){if(!X)return wt||(wt=new Promise(t=>{j=t})),Promise.race([wt,new Promise((t,e)=>setTimeout(()=>e(new Error("SW ready timeout")),n))])}async function Ue(n=3e4){if(!at)return bt||(bt=new Promise(t=>{L=t})),Promise.race([bt,new Promise((t,e)=>setTimeout(()=>e(new Error("Auto-init timeout")),n))])}async function We(){const n=B();if(!n)return!1;try{return await n.tonk.isConnected()}catch(t){return console.error("🏥 [SW] performHealthCheck() ERROR:",t),!1}}async function Yt(){if(!v){a("error","Cannot reconnect: wsUrl not stored"),console.error("🔄 [SW] Cannot reconnect: wsUrl not stored");return}W>=Lt&&(W=0);const n=B();if(!n){a("error","Cannot reconnect: tonk not initialized"),console.error("🔄 [SW] Cannot reconnect: tonk not initialized");return}W++,a("info","Attempting to reconnect",{attempt:W,maxAttempts:Lt,wsUrl:v}),await l({type:"reconnecting",attempt:W});try{if(await n.tonk.connectWebsocket(v),await new Promise(e=>setTimeout(e,1e3)),await n.tonk.isConnected())ot=!0,W=0,a("info","Reconnection successful"),await l({type:"reconnected"}),await De();else throw new Error("Connection check failed after reconnect attempt")}catch(t){a("error","Reconnection failed",{error:t instanceof Error?t.message:String(t),attempt:W});const e=Math.min(1e3*Math.pow(2,W-1),3e4);a("info","Scheduling next reconnect attempt",{delayMs:e,nextAttempt:W+1}),setTimeout(Yt,e)}}async function De(){if(a("info","Re-establishing watchers after reconnection",{watcherCount:P.size}),!B()){a("error","Cannot re-establish watchers: tonk not available");return}const t=Array.from(P.entries());a("info","Watcher re-establishment complete",{watcherCount:t.length}),await l({type:"watchersReestablished",count:t.length})}function It(){gt&&clearInterval(gt),a("info","Starting health monitoring",{intervalMs:jt}),gt=setInterval(async()=>{const n=await We();!n&&ot?(ot=!1,a("error","Connection lost, starting reconnection attempts"),console.error("❌ [SW] Connection lost, starting reconnection attempts"),await l({type:"disconnected"}),Yt()):n&&!ot&&(ot=!0,W=0,a("info","Connection health restored"))},jt)}a("info","Service worker starting, checking for cached state");console.log("🚀 SERVICE WORKER: Starting initialization");m={status:"uninitialized"};async function ze(){try{const n=await ve(),t=await Ae(),e=await Pe();if(!n||!t){a("info","No cached state found, waiting for initialization message",{hasSlug:!!n,hasBundle:!!t}),console.log("🔄 SERVICE WORKER: No cached state - waiting for bundle"),at=!0,V=!1,L&&L();return}E=n;const r=e||"http://localhost";a("info","Found cached state, auto-initializing",{slug:E,bundleSize:t.length,serverUrl:r}),console.log("🔄 SERVICE WORKER: Auto-initializing from cache...",E,"Server:",r);const o=`${r}/tonk_core_bg.wasm`;a("info","Fetching WASM from server",{wasmUrl:o}),await yt({wasmPath:o}),a("info","WASM initialization completed");const s=await(await N.fromBytes(t)).getManifest();a("info","Bundle and manifest restored from cache",{rootId:s.rootId});const _=await T.fromBytes(t,{storage:{type:"indexeddb"}});a("info","TonkCore created from cached bundle"),v=`${r.replace(/^http/,"ws")}`,a("info","Connecting to websocket...",{wsUrl:v,localRootId:s.rootId}),await _.connectWebsocket(v),a("info","Websocket connected"),It();let f=0;const S=20;for(;f<S;)try{await _.listDirectory("/app"),a("info","Auto-initialization complete - tonk ready"),console.log("✅ SERVICE WORKER: Auto-initialized successfully");break}catch{f++,f>=S?a("warn","Initial sync timeout after restore",{attempts:f}):await new Promise(p=>setTimeout(p,500))}m={status:"ready",tonk:_,manifest:s},X=!0,j&&j(),at=!0,V=!0,L&&L(),await Rt()}catch(n){a("error","Auto-initialization failed",{error:n instanceof Error?n.message:String(n)}),console.error("❌ SERVICE WORKER: Auto-initialization failed:",n),m={status:"uninitialized"},E=null,at=!0,V=!1,L&&L()}}ze().catch(n=>{a("error","Auto-initialization failed critically",{error:n.message})});self.addEventListener("install",()=>{a("info","Service worker installing"),console.log("🔧 SERVICE WORKER: Installing SW"),self.skipWaiting(),a("info","Service worker install completed, skipWaiting called")});self.addEventListener("activate",n=>{a("info","Service worker activating"),console.log("🚀 SERVICE WORKER: Activating service worker."),n.waitUntil((async()=>{await self.clients.claim(),a("info","Service worker activation completed, clients claimed");try{await Ue(3e4)}catch{a("warn","Auto-init timeout in activate handler, proceeding anyway")}(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:"swReady",autoInitialized:V,needsBundle:!V})}),a("info","Service worker activated, ready message sent to all clients",{autoInitSucceeded:V}),console.log("🚀 SERVICE WORKER: Activated and ready")})())});const qt=async n=>{if(n.bytes){const t=atob(n.bytes),e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return new Response(e,{headers:{"Content-Type":n.content.mime}})}else return new Response(n.content,{headers:{"Content-Type":"application/json"}})},Vt=n=>{if(console.log("🎯 determinePath START",{url:n.href,pathname:n.pathname,appSlug:E||"none"}),!E)throw console.error("determinePath - NO APP SLUG SET"),new Error(`No app slug available for ${n.pathname}`);const t=new URL(self.registration?.scope??self.location.href).pathname,e=n.pathname.startsWith(t)?n.pathname.slice(t.length):n.pathname,r=e.replace(/^\/+/,"").split("/").filter(Boolean);console.log("determinePath - segments",{scopePath:t,strippedPath:e,segments:[...r],firstSegment:r[0]||"none"});let o=r;if(r[0]===E?(o=r.slice(1),console.log("determinePath - appSlug already present, using remaining segments",{pathSegments:[...o]})):console.log("determinePath - appSlug not present, using all segments as path",{pathSegments:[...o]}),o.length===0||n.pathname.endsWith("/")){const s=`${E}/index.html`;return console.log("determinePath - defaulting to index.html",{result:s}),s}const c=`${E}/${o.join("/")}`;return console.log("determinePath - returning file path",{result:c}),c};self.addEventListener("fetch",n=>{const t=new URL(n.request.url),e=n.request.referrer;console.log("🔥 FETCH EVENT:",t.href,"Origin match:",t.origin===location.origin,"Pathname:",t.pathname),console.log("🔥 Tonk state:",m.status),console.log("🔥 Current appSlug:",E),a("info","Fetch event received",{url:t.href,origin:t.origin,pathname:t.pathname,referrer:e,method:n.request.method,matchesOrigin:t.origin===location.origin});const r=t.pathname==="/"||t.pathname==="";r&&E&&(E=null,Promise.all([Qt(null),Et(null),Ft(null)]).catch(o=>{a("error","Failed to persist state reset",{error:o})})),E&&t.origin===location.origin&&!r?(a("info","Processing fetch request for same origin (non-root)"),n.respondWith((async()=>{try{const o=Vt(t);a("info","Determined path for request",{path:o,originalUrl:t.href});const c=B();if(a("info","Retrieved Tonk instance",{hasTonkInstance:!!c,tonkState:m.status,tonkStateDetails:m.status==="ready"?"ready":m.status==="loading"?"loading":m.status==="failed"?"failed":"uninitialized"}),!c)throw a("error","Tonk not initialized - cannot handle request",{tonkState:m.status,path:o,url:t.href}),new Error("Tonk not initialized");const s=`/app/${o}`;if(!await c.tonk.exists(s)){console.warn(`🚨 File not found: ${s}, falling back to index.html`),a("warn","File not found, falling back to index.html",{requestedPath:s,fallbackPath:`/app/${E}/index.html`});const F=`/app/${E}/index.html`,p=await c.tonk.readFile(F);return a("info","Successfully read index.html fallback",{filePath:F,hasContent:!!p.content,hasBytes:!!p.bytes}),qt(p)}a("info","File exists, attempting to read from Tonk",{filePath:s});const f=await c.tonk.readFile(s);a("info","Successfully read file from Tonk",{filePath:s,hasContent:!!f.content,hasBytes:!!f.bytes,contentType:f.content?f.content.mime:"unknown"});const S=qt(f);return a("info","Created response for file",{filePath:`/app/${o}`,responseType:f.bytes?"binary":"text"}),S}catch(o){return a("error","Failed to fetch file from Tonk, falling back to original request",{error:o instanceof Error?o.message:String(o),path:Vt(t),url:t.href,tonkState:m.status}),a("info","Falling back to original fetch request",{url:t.href}),fetch(n.request)}})())):a("info","Ignoring fetch request for different origin",{requestOrigin:t.origin,serviceWorkerOrigin:location.origin})});async function Rt(){if(!(ht||z.length===0)){for(ht=!0,a("info","Processing message queue",{queueSize:z.length});z.length>0;){const n=z.splice(0,Te);a("info","Processing message batch",{batchSize:n.length,remainingInQueue:z.length}),await Promise.allSettled(n.map(async t=>{const e=Date.now()-t.timestamp;a("info","Processing queued message",{type:t.message.type,waitTime:`${e}ms`});try{await Xt(t.message)}catch(r){a("error","Error processing queued message",{type:t.message.type,error:r instanceof Error?r.message:String(r)}),"id"in t.message&&await l({type:t.message.type,id:t.message.id,success:!1,error:r instanceof Error?r.message:String(r)})}}))}ht=!1,a("info","Message queue processing complete")}}async function xe(n){if(a("info","Received message",{type:n.type,id:"id"in n?n.id:"N/A",queueSize:z.length,isReady:X,autoInitCompleted:at}),n.type==="setAppSlug"){E=n.slug,await Qt(E),a("info","App slug set and persisted",{slug:E});return}if(!X&&!["loadBundle","initializeFromUrl"].includes(n.type)){a("info","Queueing message until VFS is ready",{type:n.type,queuePosition:z.length}),z.push({message:n,clientId:"queued",timestamp:Date.now()}),"id"in n&&await l({type:"messageQueued",id:n.id,originalType:n.type,queuePosition:z.length});return}await Xt(n)}async function Xt(n){if(!["init","loadBundle","initializeFromUrl","getServerUrl"].includes(n.type))try{await Ce(1e4)}catch(e){a("error","Operation attempted before VFS ready",{type:n.type,error:e instanceof Error?e.message:String(e)}),"id"in n&&l({type:n.type,id:n.id,success:!1,error:"VFS not initialized. Please load a bundle first."});return}switch(n.type){case"init":a("info","Handling VFS init message",{manifestSize:n.manifest.byteLength,wsUrl:n.wsUrl,id:"id"in n?n.id:"N/A"});try{if(m.status==="ready"){a("info","Tonk already initialized, responding with success"),l({type:"init",success:!0});return}if(m.status==="loading"){a("info","Tonk is loading, waiting for completion");try{const{tonk:e,manifest:r}=await m.promise;a("info","Tonk loading completed, responding with success"),l({type:"init",success:!0})}catch(e){a("error","Tonk loading failed",{error:e instanceof Error?e.message:String(e)}),l({type:"init",success:!1,error:e instanceof Error?e.message:String(e)})}return}if(m.status==="failed"){a("error","Tonk initialization failed previously",{error:m.error.message}),l({type:"init",success:!1,error:m.error.message});return}a("warn","Tonk is uninitialized, this is unexpected"),l({type:"init",success:!1,error:"Tonk not initialized"})}catch(e){a("error","Failed to handle init message",{error:e instanceof Error?e.message:String(e)}),l({type:"init",success:!1,error:e instanceof Error?e.message:String(e)})}break;case"readFile":a("info","Reading file",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.readFile(n.path);a("info","File read successfully",{path:n.path,documentType:r.type,hasBytes:!!r.bytes,contentType:typeof r.content}),l({type:"readFile",id:n.id,success:!0,data:r})}catch(e){a("error","Failed to read file",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"readFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"writeFile":a("info","Writing file",{path:n.path,id:n.id,create:n.create,hasBytes:!!n.content.bytes,contentType:typeof n.content.content});try{const{tonk:e}=B();n.create?(a("info","Creating new file",{path:n.path}),n.content.bytes?await e.createFileWithBytes(n.path,n.content.content,n.content.bytes):await e.createFile(n.path,n.content.content)):(a("info","Updating existing file",{path:n.path}),n.content.bytes?await e.updateFileWithBytes(n.path,n.content.content,n.content.bytes):await e.updateFile(n.path,n.content.content)),a("info","File write completed successfully",{path:n.path}),l({type:"writeFile",id:n.id,success:!0})}catch(e){a("error","Failed to write file",{path:n.path,create:n.create,error:e instanceof Error?e.message:String(e)}),l({type:"writeFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"deleteFile":a("info","Deleting file",{path:n.path,id:n.id});try{const{tonk:e}=B();await e.deleteFile(n.path),a("info","File deleted successfully",{path:n.path}),l({type:"deleteFile",id:n.id,success:!0})}catch(e){a("error","Failed to delete file",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"deleteFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"rename":a("info","Renaming file or directory",{oldPath:n.oldPath,newPath:n.newPath,id:n.id});try{const{tonk:e}=B();await e.rename(n.oldPath,n.newPath),a("info","Rename completed successfully",{oldPath:n.oldPath,newPath:n.newPath}),l({type:"rename",id:n.id,success:!0})}catch(e){a("error","Failed to rename",{oldPath:n.oldPath,newPath:n.newPath,error:e instanceof Error?e.message:String(e)}),l({type:"rename",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"listDirectory":a("info","Listing directory",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.listDirectory(n.path);a("info","Directory listed successfully",{path:n.path,fileCount:Array.isArray(r)?r.length:"unknown"}),l({type:"listDirectory",id:n.id,success:!0,data:r})}catch(e){a("error","Failed to list directory",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"listDirectory",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"exists":a("info","Checking file existence",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.exists(n.path);a("info","File existence check completed",{path:n.path,exists:r}),l({type:"exists",id:n.id,success:!0,data:r})}catch(e){a("error","Failed to check file existence",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"exists",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"watchFile":a("info","Starting file watch",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.watchFile(n.path,o=>{a("info","File change detected",{watchId:n.id,path:n.path,documentType:o.type,hasBytes:!!o.bytes}),l({type:"fileChanged",watchId:n.id,documentData:o})});P.set(n.id,r),a("info","File watch started successfully",{path:n.path,watchId:n.id,totalWatchers:P.size}),l({type:"watchFile",id:n.id,success:!0})}catch(e){a("error","Failed to start file watch",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"watchFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"unwatchFile":a("info","Stopping file watch",{watchId:n.id});try{const e=P.get(n.id);e?(a("info","Found watcher, stopping it",{watchId:n.id}),e.stop(),P.delete(n.id),a("info","File watch stopped successfully",{watchId:n.id,remainingWatchers:P.size})):a("warn","No watcher found for ID",{watchId:n.id}),l({type:"unwatchFile",id:n.id,success:!0})}catch(e){a("error","Failed to stop file watch",{watchId:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"unwatchFile",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"watchDirectory":a("info","Starting directory watch",{path:n.path,id:n.id});try{const{tonk:e}=B(),r=await e.watchDirectory(n.path,o=>{a("info","Directory change detected",{watchId:n.id,path:n.path}),l({type:"directoryChanged",watchId:n.id,path:n.path,changeData:o})});P.set(n.id,r),a("info","Directory watch started successfully",{path:n.path,watchId:n.id,totalWatchers:P.size}),l({type:"watchDirectory",id:n.id,success:!0})}catch(e){a("error","Failed to start directory watch",{path:n.path,error:e instanceof Error?e.message:String(e)}),l({type:"watchDirectory",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"unwatchDirectory":a("info","Stopping directory watch",{watchId:n.id});try{const e=P.get(n.id);e?(a("info","Found directory watcher, stopping it",{watchId:n.id}),e.stop(),P.delete(n.id),a("info","Directory watch stopped successfully",{watchId:n.id,remainingWatchers:P.size})):a("warn","No directory watcher found for ID",{watchId:n.id}),l({type:"unwatchDirectory",id:n.id,success:!0})}catch(e){a("error","Failed to stop directory watch",{watchId:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"unwatchDirectory",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"toBytes":a("info","Converting tonk to bytes",{id:n.id});try{const{tonk:e,manifest:r}=B(),o=await e.toBytes(),c=r.rootId;a("info","Tonk converted to bytes successfully",{id:n.id,byteLength:o.length,rootId:c,manifestKeys:Object.keys(r)}),l({type:"toBytes",id:n.id,success:!0,data:o,rootId:c})}catch(e){a("error","Failed to convert tonk to bytes",{id:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"toBytes",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"forkToBytes":a("info","Forking tonk to bytes",{id:n.id});try{const{tonk:e}=B(),r=await e.forkToBytes(),c=await(await N.fromBytes(r)).getManifest(),s=c.rootId;a("info","Tonk forked to bytes successfully",{id:n.id,byteLength:r.length,rootId:s,manifestKeys:Object.keys(c)}),l({type:"forkToBytes",id:n.id,success:!0,data:r,rootId:s})}catch(e){a("error","Failed to fork tonk to bytes",{id:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"forkToBytes",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"loadBundle":a("info","Loading new bundle",{id:n.id,byteLength:n.bundleBytes.byteLength,serverUrl:n.serverUrl});try{const e=n.serverUrl||"http://localhost";if(a("info","Using server URL",{serverUrl:e}),m.status==="uninitialized"){a("info","WASM not initialized, initializing now");const A=`${`${e}/tonk_core_bg.wasm`}?t=${Date.now()}`;a("info","Fetching WASM from",{cacheBustUrl:A}),await yt({wasmPath:A}),a("info","WASM initialization completed for bundle loading")}const r=new Uint8Array(n.bundleBytes);a("info","Creating bundle from bytes",{byteLength:r.length});const c=await(await N.fromBytes(r)).getManifest();a("info","Bundle and manifest created successfully",{rootId:c.rootId}),a("info","Creating new TonkCore from bundle bytes");const s=await T.fromBytes(r,{storage:{type:"indexeddb"}});a("info","New TonkCore created successfully");const f=new URLSearchParams(self.location.search).get("bundle");let S=`${e.replace(/^http/,"ws")}`;if(f)try{const R=atob(f),A=JSON.parse(R);A.wsUrl&&(S=A.wsUrl)}catch(R){a("warn","Could not parse bundle config for wsUrl",{error:R instanceof Error?R.message:String(R)})}a("info","Determined websocket URL",{wsUrl:S,serverUrl:e}),v=S,a("info","Connecting new tonk to websocket",{wsUrl:v,localRootId:c.rootId}),v&&(await s.connectWebsocket(v),a("info","Websocket connection established"),It()),a("info","Waiting for initial data sync");let F=0;const p=20;for(;F<p;)try{await s.listDirectory("/app"),a("info","Initial data sync confirmed");break}catch(R){F++,F>=p?a("warn","Initial sync timeout, proceeding anyway",{attempts:F,error:R instanceof Error?R.message:String(R)}):await new Promise(A=>setTimeout(A,500))}m={status:"ready",tonk:s,manifest:c},a("info","Tonk state updated with new instance"),X=!0,j&&j(),await Et(r),await Ft(e),a("info","Bundle bytes and server URL persisted to cache"),await Nt({type:"swReady",autoInitialized:!1}),l({type:"loadBundle",id:n.id,success:!0}),await Rt()}catch(e){a("error","Failed to load bundle",{id:n.id,error:e instanceof Error?e.message:String(e)}),l({type:"loadBundle",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break;case"getServerUrl":a("info","Getting server URL",{id:n.id}),l({type:"getServerUrl",id:n.id,success:!0,data:"http://localhost"});break;case"initializeFromUrl":a("info","Initializing from URL",{id:n.id,manifestUrl:n.manifestUrl,wasmUrl:n.wasmUrl});try{const e=n.wasmUrl||"http://localhost/tonk_core_bg.wasm",r=n.manifestUrl||"http://localhost/.manifest.tonk",o=n.wsUrl||"http://localhost".replace(/^http/,"ws");a("info","Fetching WASM from URL",{wasmUrl:e});const c=`${e}?t=${Date.now()}`;await yt({wasmPath:c}),a("info","WASM initialization completed"),a("info","Fetching manifest from URL",{manifestUrl:r});const s=await fetch(r),_=new Uint8Array(await s.arrayBuffer());a("info","Manifest bytes loaded",{byteLength:_.length});const S=await(await N.fromBytes(_)).getManifest();a("info","Bundle and manifest created successfully"),a("info","Creating TonkCore from manifest bytes");const F=await T.fromBytes(_,{storage:{type:"indexeddb"}});a("info","TonkCore created successfully"),v=o,a("info","Connecting to websocket",{wsUrl:v}),await F.connectWebsocket(v),a("info","Websocket connection established"),It(),a("info","Waiting for initial data sync");let p=0;const R=20;for(;p<R;)try{await F.listDirectory("/app"),a("info","Initial data sync confirmed");break}catch(ft){p++,p>=R?a("warn","Initial sync timeout, proceeding anyway",{attempts:p,error:ft instanceof Error?ft.message:String(ft)}):await new Promise(te=>setTimeout(te,500))}m={status:"ready",tonk:F,manifest:S},a("info","Tonk state updated to ready from URL"),X=!0,j&&j(),await Et(_);const A=new URL(r),Zt=`${A.protocol}//${A.host}`;await Ft(Zt),a("info","Bundle bytes and server URL persisted to cache"),await Nt({type:"swReady",autoInitialized:!1}),l({type:"initializeFromUrl",id:n.id,success:!0}),await Rt()}catch(e){a("error","Failed to initialize from URL",{id:n.id,error:e instanceof Error?e.message:String(e)}),m={status:"failed",error:e},l({type:"initializeFromUrl",id:n.id,success:!1,error:e instanceof Error?e.message:String(e)})}break}}self.addEventListener("message",async n=>{a("info","Raw message event received",{eventType:n.type,messageType:n.data?.type,hasData:!!n.data});try{await xe(n.data)}catch(t){a("error","Error handling message",{error:t instanceof Error?t.message:String(t)})}});a("info","VFS Service Worker started",{debugLogging:Jt});
